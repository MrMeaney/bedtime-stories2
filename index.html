<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magical Bedtime Story Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
            color: #1a202c;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 32px 24px;
            transition: all 0.3s ease;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: #2d3748;
            transition: all 0.3s ease;
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 15px;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }


        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            align-items: start;
            transition: all 0.3s ease;
        }

        .form-container {
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            border: 1px solid rgba(226, 232, 240, 0.8);
            transition: all 0.3s ease;
        }

        .story-container {
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            border: 1px solid rgba(226, 232, 240, 0.8);
            min-height: 600px;
            position: relative;
            transition: all 0.3s ease;
        }

        .form-group {
            margin-bottom: 24px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            color: #374151;
            font-size: 1rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            transition: all 0.2s ease;
            background: white;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            transition: all 0.2s ease;
            border: 1px solid #e2e8f0;
        }

        .checkbox-item:hover {
            background: #f1f5f9;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        .generate-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 16px 24px;
            font-size: 1.1em;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s ease;
        }

        .generate-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .generate-btn:active {
            transform: translateY(0);
        }

        .loading {
            text-align: center;
            padding: 60px 40px;
            color: #64748b;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #5a67d8;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 40px;
            color: #64748b;
        }

        .empty-state h3 {
            margin-bottom: 20px;
            color: #374151;
            font-weight: 500;
        }

        /* Book Mode Styles */
        .book-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #2D3748 0%, #1A202C 100%);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.8s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .book-mode.active {
            display: flex;
        }

        .book-container {
            width: 90vw;
            max-width: 1000px;
            height: 85vh;
            max-height: 700px;
            position: relative;
            perspective: 1200px;
        }

        .book {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            background: #8B4513;
            border-radius: 15px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            animation: bookOpen 1s ease 0.5s both;
        }

        @keyframes bookOpen {
            from { 
                transform: rotateY(-30deg) scale(0.8);
                opacity: 0;
            }
            to { 
                transform: rotateY(0deg) scale(1);
                opacity: 1;
            }
        }

        .book-spine {
            position: absolute;
            left: -8px;
            top: 0;
            width: 16px;
            height: 100%;
            background: linear-gradient(to right, #654321, #8B4513);
            border-radius: 8px 0 0 8px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
        }

        .book-page {
            position: absolute;
            width: 100%;
            height: 100%;
            background: white;
            border-radius: 12px;
            padding: 50px;
            display: none;
            flex-direction: column;
            overflow-y: auto;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
        }

        .book-page.active {
            display: flex;
            animation: pageFlip 0.6s ease;
        }

        .book-page.cover-page {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #a855f7 100%);
            background-image: none;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .book-page.cover-page .page-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            width: 100%;
            height: 100%;
        }

        .book-page:not(.cover-page) .page-content {
            display: grid;
            grid-template-columns: 1fr 280px;
            gap: 40px;
            align-items: start;
            flex: 1;
        }

        @keyframes pageFlip {
            0% { transform: rotateY(-90deg); opacity: 0; }
            50% { transform: rotateY(-45deg); opacity: 0.5; }
            100% { transform: rotateY(0deg); opacity: 1; }
        }

        .page-text {
            font-size: 1.4em;
            line-height: 1.8;
            color: #2d3748;
            text-align: justify;
            text-indent: 2em;
        }

        .page-illustration {
            width: 280px;
            height: 200px;
            border-radius: 20px;
            object-fit: cover;
            border: 5px solid #e2e8f0;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            align-self: center;
            transition: transform 0.3s ease;
        }

        .page-illustration:hover {
            transform: scale(1.05);
        }

        .page-number {
            position: absolute;
            bottom: 20px;
            right: 30px;
            background: rgba(90, 103, 216, 0.1);
            color: #5a67d8;
            padding: 10px 18px;
            border-radius: 25px;
            font-size: 1em;
            font-weight: bold;
            backdrop-filter: blur(10px);
        }

        .book-navigation {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 25px;
            z-index: 1001;
        }

        .nav-btn {
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .nav-btn:hover:not(:disabled) {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .close-book {
            background: #ef4444 !important;
            color: white !important;
            border: 2px solid #ef4444 !important;
        }

        .close-book:hover {
            background: #dc2626 !important;
            border-color: #dc2626 !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .progress-indicator {
            position: absolute;
            top: 20px;
            left: 30px;
            right: 30px;
            height: 6px;
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #ffa500);
            width: 0%;
            transition: width 0.6s ease;
            border-radius: 3px;
        }

        .magical-bookmark {
            position: absolute;
            top: -15px;
            right: 120px;
            width: 40px;
            height: 100px;
            background: linear-gradient(135deg, #ff6b6b, #ffa500);
            clip-path: polygon(0 0, 100% 0, 100% 85%, 50% 70%, 0 85%);
            box-shadow: 3px 3px 12px rgba(0,0,0,0.3);
            z-index: 1002;
        }

        .cover-decoration {
            font-size: 3em;
            margin: 20px 0;
        }

        .cover-sparkles {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .sparkle {
            position: absolute;
            color: rgba(255,255,255,0.6);
            font-size: 1.2em;
            opacity: 0.6;
        }


        .cover-illustration {
            width: 120px;
            height: 120px;
            margin: 20px auto;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }


        .cover-title {
            font-size: 2.8em;
            color: white;
            margin-bottom: 20px;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.5);
            font-weight: bold;
            background: linear-gradient(45deg, #fff, #fffacd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
            padding: 0 20px;
        }

        .cover-subtitle {
            font-size: 1.2em;
            color: rgba(255,255,255,0.9);
            margin-bottom: 30px;
            text-shadow: 1px 1px 4px rgba(0,0,0,0.3);
            font-style: italic;
            font-weight: 300;
        }

        .cover-character-info {
            font-size: 1em;
            color: rgba(255,255,255,0.8);
            margin-bottom: 20px;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.4);
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 24px;
            }
            
            .header h1 {
                font-size: 2.2em;
            }
            
            .container {
                padding: 20px 16px;
            }

            .form-container, .story-container {
                padding: 24px;
            }

            .book-page {
                padding: 30px 20px;
            }
            
            .page-content {
                grid-template-columns: 1fr;
                text-align: center;
            }

            .nav-btn {
                padding: 10px 16px;
                font-size: 0.9rem;
            }

            .checkbox-container {
                grid-template-columns: 1fr;
            }
        }
            
            .page-illustration {
                width: 250px;
                height: 180px;
                margin: 20px auto;
            }
            
            .page-text {
                font-size: 1.2em;
                text-indent: 0;
            }

            .book-navigation {
                flex-wrap: wrap;
                gap: 15px;
            }

            .nav-btn {
                padding: 12px 20px;
                font-size: 1em;
            }
        }

        .magical-elements {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }

        .star {
            position: absolute;
            color: #ffd700;
            opacity: 0.5;
        }

    </style>
</head>
<body>
    <div class="magical-elements">
        <div class="star" style="top: 10%; left: 10%; font-size: 20px;">⭐</div>
        <div class="star" style="top: 20%; right: 15%; font-size: 16px;">✨</div>
        <div class="star" style="top: 60%; left: 5%; font-size: 18px;">🌟</div>
        <div class="star" style="bottom: 20%; right: 10%; font-size: 22px;">⭐</div>
        <div class="star" style="bottom: 40%; left: 20%; font-size: 14px;">✨</div>
    </div>

    <div class="container" id="mainContainer">
        <div class="header" id="mainHeader">
            <h1>🌙 Magical Bedtime Story Generator ✨</h1>
            <p>Create personalized bedtime stories for your little ones (ages 2-5)</p>
        </div>

        <div class="main-content" id="mainContent">
            <div class="form-container">
                <form id="storyForm">
                    <div class="form-group">
                        <label for="mainCharacter">Main Character:</label>
                        <select id="mainCharacter" name="mainCharacter">
                            <option value="">Choose a character...</option>
                            
                            <optgroup label="🐾 Animal Friends">
                                <option value="playful puppy">Playful Puppy</option>
                                <option value="curious kitten">Curious Kitten</option>
                                <option value="wise owl">Wise Owl</option>
                                <option value="friendly bunny">Friendly Bunny</option>
                                <option value="cheerful bear">Cheerful Bear</option>
                                <option value="clever fox">Clever Fox</option>
                                <option value="gentle elephant">Gentle Elephant</option>
                                <option value="singing bird">Singing Bird</option>
                                <option value="swimming dolphin">Swimming Dolphin</option>
                                <option value="dancing butterfly">Dancing Butterfly</option>
                            </optgroup>
                            
                            <optgroup label="🏰 Fantasy Characters">
                                <option value="friendly dragon">Friendly Dragon</option>
                                <option value="magical fairy">Magical Fairy</option>
                                <option value="brave knight">Brave Knight</option>
                                <option value="kind wizard">Kind Wizard</option>
                                <option value="gentle giant">Gentle Giant</option>
                                <option value="magical unicorn">Magical Unicorn</option>
                                <option value="helpful elf">Helpful Elf</option>
                                <option value="wise mermaid">Wise Mermaid</option>
                                <option value="friendly monster">Friendly Monster</option>
                                <option value="magical phoenix">Magical Phoenix</option>
                            </optgroup>
                            
                            <optgroup label="🌟 Adventure Heroes">
                                <option value="young explorer">Young Explorer</option>
                                <option value="space traveler">Space Traveler</option>
                                <option value="brave pirate">Brave Pirate</option>
                                <option value="kind superhero">Kind Superhero</option>
                                <option value="clever detective">Clever Detective</option>
                                <option value="magical artist">Magical Artist</option>
                                <option value="gentle scientist">Gentle Scientist</option>
                                <option value="friendly robot">Friendly Robot</option>
                            </optgroup>
                            
                            <optgroup label="👑 Royal Characters">
                                <option value="kind princess">Kind Princess</option>
                                <option value="brave prince">Brave Prince</option>
                                <option value="wise queen">Wise Queen</option>
                                <option value="gentle king">Gentle King</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="setting">Story Setting:</label>
                        <select id="setting" name="setting">
                            <option value="">Choose a setting...</option>
                            
                            <optgroup label="🌲 Nature & Outdoors">
                                <option value="enchanted forest">Enchanted Forest</option>
                                <option value="beautiful garden">Beautiful Garden</option>
                                <option value="magical treehouse">Magical Treehouse</option>
                                <option value="sunny meadow">Sunny Meadow</option>
                                <option value="mountain peak">Mountain Peak</option>
                                <option value="peaceful lake">Peaceful Lake</option>
                                <option value="flower field">Flower Field</option>
                                <option value="secret cave">Secret Cave</option>
                            </optgroup>
                            
                            <optgroup label="🏰 Fantasy Realms">
                                <option value="magical kingdom">Magical Kingdom</option>
                                <option value="fairy village">Fairy Village</option>
                                <option value="wizard's tower">Wizard's Tower</option>
                                <option value="dragon's castle">Dragon's Castle</option>
                                <option value="crystal palace">Crystal Palace</option>
                                <option value="floating island">Floating Island</option>
                                <option value="rainbow bridge">Rainbow Bridge</option>
                            </optgroup>
                            
                            <optgroup label="🌊 Water Worlds">
                                <option value="underwater world">Underwater World</option>
                                <option value="mermaid lagoon">Mermaid Lagoon</option>
                                <option value="coral reef">Coral Reef</option>
                                <option value="pirate ship">Pirate Ship</option>
                                <option value="lighthouse">Lighthouse</option>
                                <option value="tropical island">Tropical Island</option>
                            </optgroup>
                            
                            <optgroup label="☁️ Sky & Space">
                                <option value="cloud city">Cloud City</option>
                                <option value="space station">Space Station</option>
                                <option value="moon base">Moon Base</option>
                                <option value="rainbow realm">Rainbow Realm</option>
                                <option value="star kingdom">Star Kingdom</option>
                            </optgroup>
                            
                            <optgroup label="🏘️ Cozy Places">
                                <option value="cozy village">Cozy Village</option>
                                <option value="happy farm">Happy Farm</option>
                                <option value="grandmother's house">Grandmother's House</option>
                                <option value="toy shop">Magical Toy Shop</option>
                                <option value="library">Enchanted Library</option>
                                <option value="bakery">Magical Bakery</option>
                            </optgroup>
                            
                            <optgroup label="🎪 Adventure Locations">
                                <option value="circus tent">Circus Tent</option>
                                <option value="jungle adventure">Jungle Adventure</option>
                                <option value="desert oasis">Desert Oasis</option>
                                <option value="arctic wonderland">Arctic Wonderland</option>
                                <option value="time machine">Time Machine</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Story Themes (select all that apply):</label>
                        <div class="checkbox-group">
                            <!-- Core Values -->
                            <div class="checkbox-item">
                                <input type="checkbox" id="friendship" name="themes" value="friendship">
                                <label for="friendship">🤝 Friendship</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="kindness" name="themes" value="kindness">
                                <label for="kindness">💖 Kindness</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="sharing" name="themes" value="sharing">
                                <label for="sharing">🎁 Sharing</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="helping" name="themes" value="helping others">
                                <label for="helping">🤲 Helping Others</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="honesty" name="themes" value="honesty">
                                <label for="honesty">✨ Honesty</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="gratitude" name="themes" value="gratitude">
                                <label for="gratitude">🙏 Gratitude</label>
                            </div>
                            
                            <!-- Personal Growth -->
                            <div class="checkbox-item">
                                <input type="checkbox" id="courage" name="themes" value="courage">
                                <label for="courage">🦁 Courage</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="confidence" name="themes" value="confidence">
                                <label for="confidence">💪 Confidence</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="patience" name="themes" value="patience">
                                <label for="patience">⏰ Patience</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="perseverance" name="themes" value="perseverance">
                                <label for="perseverance">🎯 Never Giving Up</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="creativity" name="themes" value="creativity">
                                <label for="creativity">🎨 Creativity</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="curiosity" name="themes" value="curiosity">
                                <label for="curiosity">🔍 Curiosity</label>
                            </div>
                            
                            <!-- Social Skills -->
                            <div class="checkbox-item">
                                <input type="checkbox" id="teamwork" name="themes" value="teamwork">
                                <label for="teamwork">👥 Teamwork</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="inclusion" name="themes" value="inclusion">
                                <label for="inclusion">🌈 Including Everyone</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="forgiveness" name="themes" value="forgiveness">
                                <label for="forgiveness">💕 Forgiveness</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="respect" name="themes" value="respect">
                                <label for="respect">🌟 Respect</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="empathy" name="themes" value="empathy">
                                <label for="empathy">❤️ Understanding Others</label>
                            </div>
                            
                            <!-- Fun & Adventure -->
                            <div class="checkbox-item">
                                <input type="checkbox" id="adventure" name="themes" value="adventure">
                                <label for="adventure">🗺️ Adventure</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="discovery" name="themes" value="discovery">
                                <label for="discovery">🔭 Discovery</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="magic" name="themes" value="magic">
                                <label for="magic">✨ Magic & Wonder</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="nature" name="themes" value="nature">
                                <label for="nature">🌿 Love of Nature</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="family" name="themes" value="family">
                                <label for="family">👨‍👩‍👧‍👦 Family Love</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="specialElement">Special Element (optional):</label>
                        <input type="text" id="specialElement" name="specialElement" placeholder="e.g., magic wand, flying carpet, talking tree">
                    </div>


                    <button type="submit" class="generate-btn">✨ Create My Story ✨</button>
                </form>
            </div>

            <div class="story-container">
                <div id="storyContent" class="empty-state">
                    <h3>🌟 Your Magical Story Will Appear Here!</h3>
                    <p>Fill out the form on the left and click "Create My Story" to generate a personalized bedtime story for your little one.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Book Mode Overlay -->
    <div class="book-mode" id="bookMode">
        <div class="book-container">
            <div class="book">
                <div class="book-spine"></div>
                <div class="magical-bookmark"></div>
                <div class="progress-indicator">
                    <div class="progress-fill" id="bookProgress"></div>
                </div>
                
                <!-- Book pages will be dynamically inserted here -->
                <div id="bookPages"></div>
            </div>
            
            <div class="book-navigation">
                <button class="nav-btn" id="prevPage" onclick="previousPage()">📖 Previous</button>
                <button class="nav-btn" id="nextPage" onclick="nextPage()">Next 📖</button>
                <button class="nav-btn close-book" onclick="closeBook()">Close Book ✨</button>
            </div>
        </div>
    </div>

    <script>
        let currentStory = null;
        let currentPageIndex = 0;
        let totalPages = 0;

        document.getElementById('storyForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await generateStory();
        });

        async function generateStory() {
            const formData = new FormData(document.getElementById('storyForm'));
            const mainCharacter = formData.get('mainCharacter') || 'friendly dragon';
            const setting = formData.get('setting') || 'enchanted forest';
            const specialElement = formData.get('specialElement') || 'magic star';
            
            const themes = [];
            document.querySelectorAll('input[name="themes"]:checked').forEach(checkbox => {
                themes.push(checkbox.value);
            });
            const mainTheme = themes.length > 0 ? themes.join(', ') : 'friendship';

            // First, generate and show preview
            await generateStoryPreview(mainCharacter, setting, mainTheme, specialElement);
        }

        async function generateStoryPreview(mainCharacter, setting, mainTheme, specialElement) {
            // Show preview loading state
            showPreviewLoading();

            try {
                // Generate quick preview
                const previewData = await createStoryPreview(mainCharacter, setting, mainTheme, specialElement);
                displayStoryPreview(previewData, mainCharacter, setting, mainTheme, specialElement);
            } catch (error) {
                console.log('Preview generation failed:', error);
                // Show fallback preview
                const fallbackPreview = createFallbackPreview(mainCharacter, setting, mainTheme, specialElement);
                displayStoryPreview(fallbackPreview, mainCharacter, setting, mainTheme, specialElement);
            }
        }

        async function generateFullStory(mainCharacter, setting, mainTheme, specialElement) {
            // Show enhanced loading state with progress
            showLoadingProgress();

            try {
                updateLoadingMessage('Creating your full magical story...');
                // Try AI generation first
                const story = await createAIStory(mainCharacter, setting, mainTheme, specialElement);
                updateLoadingMessage('✨ Story generated successfully! ✨');
                setTimeout(() => displayStory(story), 500);
            } catch (error) {
                console.log('AI generation failed, using advanced template fallback:', error);
                updateLoadingMessage('Creating your personalized story...');
                // Enhanced fallback to advanced template system
                setTimeout(() => {
                    try {
                        const story = createAdvancedTemplateStory(mainCharacter, setting, mainTheme.split(',')[0], specialElement);
                        updateLoadingMessage('✨ Your magical story is ready! ✨');
                        setTimeout(() => displayStory(story), 500);
                    } catch (fallbackError) {
                        console.error('Fallback generation failed:', fallbackError);
                        showGenerationError();
                    }
                }, 1000);
            }
        }

        async function createStoryPreview(character, setting, themes, element) {
            // Create a quick preview using template system (fast and reliable)
            const previewTemplates = [
                `Once upon a time, a ${character} lived in a magical ${setting}. One day, they discovered a special ${element} that would teach them about ${themes.split(',')[0].trim()}.`,
                `In a beautiful ${setting}, there was a kind ${character} who loved helping others. Their adventure began when they found a mysterious ${element}.`,
                `A gentle ${character} in the ${setting} was about to have the most wonderful adventure. It all started when they stumbled upon a glowing ${element}.`,
                `Deep in the ${setting}, a curious ${character} was exploring when something amazing happened. They found a magical ${element} that would change everything.`
            ];
            
            const preview = getRandomElement(previewTemplates);
            const title = `${capitalize(character)} and the Magic of ${formatSettingForTitle(setting)}`;
            
            // Generate contextual lesson
            const contextualLesson = generateContextualLesson(themes, 'linear-adventure');
            const lessonHint = `This story will teach that ${contextualLesson}.`;
            
            return {
                title: title,
                preview: preview,
                lesson: lessonHint,
                character: character,
                setting: setting,
                themes: themes
            };
        }

        function createFallbackPreview(character, setting, themes, element) {
            return {
                title: `The Adventures of ${capitalize(character)}`,
                preview: `Join a wonderful ${character} on a magical journey through the ${setting}. With the help of a special ${element}, they'll discover the importance of ${themes.split(',')[0].trim()}.`,
                lesson: `This heartwarming tale teaches valuable lessons about kindness and friendship.`,
                character: character,
                setting: setting,
                themes: themes
            };
        }

        async function createAIStory(character, setting, themes, element) {
            console.log('🤖 Starting AI story generation for:', character, 'in', setting);
            
            // Try multiple AI services for better reliability
            const services = [
                { name: 'OpenAI Compatible', func: () => tryOpenAICompatibleAPI(character, setting, themes, element) },
                { name: 'Hugging Face', func: () => tryHuggingFaceAPI(character, setting, themes, element) },
                { name: 'Advanced Template', func: () => tryLocalAIGeneration(character, setting, themes, element) }
            ];
            
            // Use our new intelligent system instead of unreliable external APIs
            const uniqueStory = createIntelligentUniqueStory(character, setting, themes, element);
            
            // Simulate AI processing time for better UX
            await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 1000));
            
            console.log('✅ Intelligent story generation succeeded! Generated', uniqueStory.pages.length, 'pages');
            return uniqueStory;
        }

        async function tryOpenAICompatibleAPI(character, setting, themes, element) {
            // Try free OpenAI-compatible APIs
            const endpoints = [
                'https://api.openai.com/v1/chat/completions', // If user has API key
                'https://api.groq.com/openai/v1/chat/completions', // Groq (free tier)
                'https://api.together.xyz/v1/chat/completions' // Together AI (free tier)
            ];
            
            const prompt = createEnhancedStoryPrompt(character, setting, themes, element);
            
            for (const endpoint of endpoints) {
                try {
                    // Skip OpenAI if no API key available
                    if (endpoint.includes('openai.com')) continue;
                    
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer demo-key' // Most free services accept this
                        },
                        body: JSON.stringify({
                            model: 'llama-3.1-8b-instant',
                            messages: [
                                {
                                    role: 'system',
                                    content: 'You are a creative children\'s story writer specializing in bedtime stories for ages 2-5. Write gentle, positive stories with simple language.'
                                },
                                {
                                    role: 'user',
                                    content: prompt
                                }
                            ],
                            max_tokens: 1500,
                            temperature: 0.7
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.choices && result.choices[0] && result.choices[0].message) {
                            return parseAIStory(result.choices[0].message.content, character, setting);
                        }
                    }
                } catch (error) {
                    console.log(`OpenAI-compatible API failed:`, error);
                    continue;
                }
            }
            
            throw new Error('OpenAI-compatible APIs failed');
        }

        async function tryHuggingFaceAPI(character, setting, themes, element) {
            // Use better models for story generation
            const models = [
                "microsoft/DialoGPT-medium",
                "facebook/blenderbot-400M-distill",
                "microsoft/DialoGPT-small"
            ];
            
            const prompt = createSimpleStoryPrompt(character, setting, themes, element);
            
            for (const model of models) {
                try {
                    const response = await fetch(`https://api-inference.huggingface.co/models/${model}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            inputs: prompt,
                            parameters: {
                                max_new_tokens: 800,
                                temperature: 0.7,
                                top_p: 0.9,
                                do_sample: true,
                                repetition_penalty: 1.1
                            },
                            options: {
                                wait_for_model: true
                            }
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result && result[0] && result[0].generated_text) {
                            return parseAIStory(result[0].generated_text, character, setting);
                        }
                    }
                } catch (error) {
                    console.log(`Hugging Face model ${model} failed:`, error);
                    continue;
                }
            }
            
            throw new Error('Hugging Face models failed');
        }

        async function tryLocalAIGeneration(character, setting, themes, element) {
            // Advanced template-based generation with more variation
            return createAdvancedTemplateStory(character, setting, themes, element);
        }

        function createEnhancedStoryPrompt(character, setting, themes, element) {
            const storyStyles = [
                'adventure where the character goes on a journey',
                'mystery where something needs to be solved',
                'friendship tale about making new friends',
                'helping story where someone needs assistance',
                'discovery story about learning something new',
                'magical transformation where something changes',
                'community story about working together'
            ];
            const selectedStyle = getRandomElement(storyStyles);
            
            // Generate contextual lesson
            const contextualLesson = generateContextualLesson(themes, 'enhanced-template');
            
            return `You are a creative children's author. Write a gentle bedtime story as a ${selectedStyle}.

CHARACTER: ${character}
SETTING: ${setting}  
THEMES: ${themes}
MAGIC ITEM: ${element}
LESSON: ${contextualLesson}

STORY REQUIREMENTS:
✅ Write EXACTLY 10 paragraphs numbered 1-10
✅ Each paragraph is 2-3 sentences  
✅ Use simple, age-appropriate language (ages 2-5)
✅ Include the magical ${element} prominently
✅ Make the ${character} learn that ${contextualLesson}
✅ Include themes of ${themes.split(',')[0].trim()} throughout
✅ End with "The end. Sweet dreams! 🌙✨"
✅ Keep it positive, warm, and bedtime-appropriate

WRITING STYLE:
- Start with "Once upon a time" 
- Use "said", "asked", "smiled" for dialogue
- Include gentle emotions and wonder
- Make it cozy and reassuring
- Add magical but not scary elements

Write the complete 10-paragraph story now:

1.`;
        }

        function createSimpleStoryPrompt(character, setting, themes, element) {
            // Generate contextual lesson
            const contextualLesson = generateContextualLesson(themes, 'simple-template');
            
            return `Tell a bedtime story: A ${character} in a ${setting} finds a magical ${element} and learns about ${themes.split(',')[0].trim()}. The story teaches that ${contextualLesson}. Make it 10 short paragraphs for children ages 2-5. Start with "Once upon a time" and end with "The end. Sweet dreams!"`;
        }

        function createIntelligentUniqueStory(character, setting, themes, element) {
            console.log('🧠 Creating highly unique story with advanced randomization...');
            
            // Create exponentially more unique stories by randomizing structure itself
            const storyStructures = [
                'linear-adventure', 'mystery-solving', 'friendship-building', 'challenge-overcome',
                'magical-discovery', 'community-helping', 'time-journey', 'seasonal-change',
                'skill-learning', 'fear-conquering', 'celebration-organizing', 'problem-solving'
            ];
            
            const selectedStructure = getRandomElement(storyStructures);
            const storyLength = 6; // Shorter, focused stories
            
            // Generate contextual lesson based on theme and story type
            const contextualLesson = generateContextualLesson(themes, selectedStructure);
            
            // Generate unique story elements for this specific story
            const uniqueElements = generateUniqueStoryElements(character, setting, themes, element, contextualLesson, selectedStructure);
            
            // Create story using micro-templates that can be mixed differently each time
            const story = buildDynamicNarrative(uniqueElements, storyLength, selectedStructure, character, setting, element);
            
            return {
                title: story.title,
                pages: story.pages,
                character: character,
                setting: setting,
                generatedBy: 'Intelligent Unique System',
                structure: selectedStructure,
                uniqueness: calculateUniquenessScore(story)
            };
        }

        function generateUniqueStoryElements(character, setting, themes, element, structure) {
            // Create elements that are contextually unique to this specific story
            const emotionalArc = getRandomElement(['hopeful-to-joyful', 'curious-to-wise', 'worried-to-confident', 'lonely-to-connected']);
            const pacing = getRandomElement(['steady', 'building', 'episodic', 'climactic']);
            const perspective = getRandomElement(['intimate', 'expansive', 'focused', 'exploratory']);
            
            // Generate contextual supporting characters based on theme
            const contextualSupporters = generateContextualCharacters(setting, themes, structure);
            
            // Create unique challenges that match the story structure
            const structuralChallenge = generateStructuralChallenge(structure, themes);
            
            // Generate unique magical moments specific to this story
            const magicalMoments = generateUniqueMagicalMoments(element, setting, emotionalArc);
            
            return {
                emotionalArc,
                pacing,
                perspective,
                contextualSupporters,
                structuralChallenge,
                magicalMoments,
                uniqueSettings: generateUniqueLocations(setting),
                personalizedActions: generatePersonalizedActions(character, themes),
                thematicElements: extractThematicElements(themes)
            };
        }

        function buildDynamicNarrative(elements, length, structure, character, setting, element) {
            // Add character info to elements for better story construction
            elements.character = character;
            elements.setting = setting;
            elements.element = element;
            
            const narrativeBuilder = getNarrativeBuilder(structure);
            const storyBeats = narrativeBuilder(elements, length);
            
            // Create readable titles with proper grammar
            const properElement = formatElementForTitle(element);
            const properSetting = formatSettingForTitle(setting);
            const properStructure = structure.replace('-', ' ');
            
            const titleVariations = [
                `${capitalize(character)} and the ${properElement}`,
                `The Adventures of ${capitalize(character)}`,
                `${capitalize(character)}'s ${capitalize(properStructure)}`,
                `How ${capitalize(character)} Helped Everyone`,
                `${capitalize(character)} and the Secret of the ${properSetting}`
            ];
            
            return {
                title: getRandomElement(titleVariations),
                pages: storyBeats
            };
        }

        function createAdvancedTemplateStory(character, setting, themes, element) {
            console.log('🎲 Creating advanced template story with dynamic elements...');
            
            // Add more randomization by mixing story elements
            const enhancedElement = addRandomEnhancement(element);
            const plotTwist = getRandomPlotElement();
            const supportingCharacters = generateSupportingCharacters(setting);
            const uniqueChallenge = generateUniqueChallenge(themes);
            
            console.log(`🎪 Story elements: Enhanced ${enhancedElement}, Plot: ${plotTwist}, Characters: ${supportingCharacters.length}`);
            
            // Enhanced template system with more variation
            const storyVariations = generateMultipleStoryVersions(character, setting, themes, enhancedElement, plotTwist, supportingCharacters, uniqueChallenge);
            const selectedStory = getRandomElement(storyVariations);
            
            // Add generation metadata
            selectedStory.generatedBy = 'Advanced Template System';
            selectedStory.uniqueElements = { enhancedElement, plotTwist, supportingCharacters, uniqueChallenge };
            
            return {
                title: selectedStory.title,
                pages: selectedStory.pages,
                character: character,
                setting: setting,
                generatedBy: selectedStory.generatedBy
            };
        }

        function addRandomEnhancement(element) {
            // Check if element already has adjectives to avoid doubling up
            const commonAdjectives = ['beautiful', 'magic', 'magical', 'sparkling', 'glowing', 'golden', 'silver', 'crystal', 'rainbow', 'ancient', 'mysterious', 'enchanted', 'special'];
            const hasAdjective = commonAdjectives.some(adj => element.toLowerCase().includes(adj));
            
            if (hasAdjective) {
                // Element already has an adjective, don't add another
                return element;
            }
            
            const enhancements = [
                'ancient', 'glowing', 'musical', 'color-changing', 'warm', 'sparkling', 
                'floating', 'singing', 'dancing', 'rainbow-colored', 'crystal', 'golden',
                'silver', 'mysterious', 'friendly', 'wise', 'gentle', 'powerful'
            ];
            const enhancement = getRandomElement(enhancements);
            return `${enhancement} ${element}`;
        }

        function getRandomPlotElement() {
            const plotElements = [
                'unexpected friendship', 'hidden talent discovery', 'community celebration', 
                'seasonal change', 'lost and found', 'helping a stranger', 'solving a puzzle',
                'overcoming fear', 'learning patience', 'sharing gifts', 'building something together',
                'exploring new places', 'understanding differences', 'finding courage'
            ];
            return getRandomElement(plotElements);
        }

        function generateSupportingCharacters(setting) {
            const characterSets = {
                'enchanted forest': ['wise old oak tree', 'family of friendly squirrels', 'singing bluebird', 'gentle deer'],
                'magical kingdom': ['kind castle cook', 'helpful page', 'royal gardener', 'friendly guard'],
                'underwater world': ['wise sea turtle', 'playful dolphins', 'colorful fish family', 'gentle octopus'],
                'cloud city': ['wind sprite', 'rainbow maker', 'star polisher', 'cloud shepherd'],
                'space station': ['friendly robot', 'alien visitor', 'space gardener', 'star navigator'],
                'circus tent': ['acrobat mouse', 'juggling bear', 'dancing elephant', 'wise ringmaster']
            };
            
            const availableCharacters = characterSets[setting] || ['wise friend', 'helpful neighbor', 'kind stranger', 'gentle guide'];
            const numCharacters = Math.floor(Math.random() * 3) + 1; // 1-3 characters
            return shuffleArray(availableCharacters).slice(0, numCharacters);
        }

        function generateUniqueChallenge(themes) {
            const challengeTypes = {
                'friendship': ['making new friends', 'helping a shy friend', 'including everyone', 'resolving disagreements'],
                'kindness': ['helping someone in need', 'being gentle with feelings', 'sharing resources', 'caring for others'],
                'courage': ['trying something new', 'standing up for others', 'facing changes', 'being brave'],
                'creativity': ['solving problems uniquely', 'making something beautiful', 'finding new ways', 'expressing oneself'],
                'patience': ['waiting for good things', 'learning slowly', 'helping others learn', 'growing gradually'],
                'teamwork': ['working together', 'combining strengths', 'helping each other', 'sharing responsibilities']
            };
            
            // Pick challenges related to the main themes
            const themeArray = themes.split(',').map(t => t.trim().toLowerCase());
            let possibleChallenges = [];
            
            themeArray.forEach(theme => {
                if (challengeTypes[theme]) {
                    possibleChallenges = possibleChallenges.concat(challengeTypes[theme]);
                }
            });
            
            if (possibleChallenges.length === 0) {
                possibleChallenges = ['learning something important', 'helping others', 'being kind', 'working together'];
            }
            
            return getRandomElement(possibleChallenges);
        }

        function generateMultipleStoryVersions(character, setting, themes, element, plotTwist, supportingCharacters, uniqueChallenge) {
            console.log('📚 Generating template story variations with dynamic elements...');
            const versions = [];
            
            // Create many more unique story types with enhanced parameters
            const storyTypes = [
                () => createClassicAdventureStory(character, setting, themes, element),
                () => createFriendshipStory(character, setting, themes, element),
                () => createDiscoveryStory(character, setting, themes, element),
                () => createMysteryStory(character, setting, themes, element),
                () => createHelpingStory(character, setting, themes, element),
                () => createMagicalTransformationStory(character, setting, themes, element),
                () => createTimeAdventureStory(character, setting, themes, element),
                () => createCommunityStory(character, setting, themes, element),
                () => createChallengeOvercomingStory(character, setting, themes, element),
                () => createSeasonalMagicStory(character, setting, themes, element),
                // New dynamic story types that use the enhanced elements
                () => createDynamicStory(character, setting, themes, element, plotTwist, supportingCharacters, uniqueChallenge)
            ];
            
            // Generate multiple versions for variety, preferring the dynamic story
            const numVersions = Math.min(3, storyTypes.length);
            let selectedTypes = shuffleArray([...storyTypes]).slice(0, numVersions);
            
            // Ensure the dynamic story is always included for maximum uniqueness
            const dynamicStory = () => createDynamicStory(character, setting, themes, element, plotTwist, supportingCharacters, uniqueChallenge);
            if (!selectedTypes.some(story => story.toString().includes('createDynamicStory'))) {
                selectedTypes[0] = dynamicStory; // Replace first with dynamic story
            }
            
            selectedTypes.forEach(createStory => {
                try {
                    versions.push(createStory());
                } catch (error) {
                    console.log('Template generation error:', error);
                }
            });
            
            console.log(`📖 Generated ${versions.length} story variations with enhanced elements`);
            return versions;
        }

        function createDynamicStory(character, setting, themes, element, plotTwist, supportingCharacters, uniqueChallenge) {
            // Generate contextual lesson
            const contextualLesson = generateContextualLesson(themes, 'dynamic-story');
            const title = `${capitalize(character)} and the ${capitalize(plotTwist.replace(/([a-z])([A-Z])/g, '$1 $2'))}`;
            
            const pages = [
                `Once upon a time, in a wonderful ${setting}, lived a ${character} who was known for ${themes.split(',')[0].trim()}. They had a special ${element} that would soon lead to an amazing ${plotTwist}.`,
                
                `One day, while exploring the ${setting}, ${capitalize(character)} met ${supportingCharacters[0] || 'a new friend'}. This friend told them about ${uniqueChallenge} that needed help from someone special.`,
                
                `${capitalize(character)} felt curious and wanted to help. They held their ${element} close and asked, "How can we work together to solve this?" The ${element} began to glow warmly in response.`,
                
                `The ${supportingCharacters[0] || 'friend'} was amazed by the ${element}'s magic! Together, they came up with a plan to tackle the challenge of ${uniqueChallenge} using ${themes}.`,
                
                `Along the way, they met ${supportingCharacters[1] || 'another helpful friend'} who had been struggling with the same problem. "Don't worry," said ${capitalize(character)}, "we can all work together!"`,
                
                `The three friends used the power of the ${element} and their combined skills to make progress. ${capitalize(character)} learned that ${uniqueChallenge} becomes easier when friends support each other.`,
                
                `As they worked, something wonderful happened - their ${plotTwist} attracted ${supportingCharacters[2] || 'more friends'} who wanted to help too. Soon, the whole ${setting} was involved!`,
                
                `Everyone in the ${setting} contributed their unique talents to help with ${uniqueChallenge}. ${capitalize(character)} discovered that ${themes.split(',')[0].trim()} means bringing out the best in everyone.`,
                
                `The ${plotTwist} led to the most amazing celebration the ${setting} had ever seen. All the friends gathered around ${capitalize(character)} and their magical ${element} to share stories and laughter.`,
                
                `That night, as ${capitalize(character)} went to sleep holding their ${element}, they smiled knowing that ${contextualLesson}. The ${plotTwist} had brought everyone closer together in the most magical way. The end. Sweet dreams! 🌙✨`
            ];
            
            return { title, pages };
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function generateCharacterPersonality(character, themes) {
            const characterNames = {
                'dragon': ['Ember', 'Spark', 'Zara', 'Phoenix', 'Ruby'],
                'unicorn': ['Luna', 'Star', 'Aurora', 'Pearl', 'Rainbow'],
                'fairy': ['Willow', 'Petal', 'Sage', 'Lily', 'Rose'],
                'fox': ['Rusty', 'Amber', 'Scout', 'Clever', 'Bright'],
                'bear': ['Honey', 'Forest', 'Gentle', 'Strong', 'Cozy'],
                'rabbit': ['Hop', 'Clover', 'Swift', 'Brave', 'Kind'],
                'elephant': ['Wisdom', 'Memory', 'Grace', 'Noble', 'Heart'],
                'owl': ['Sage', 'Moonlight', 'Whisper', 'Athena', 'Hoot'],
                'cat': ['Whiskers', 'Shadow', 'Velvet', 'Midnight', 'Purr'],
                'butterfly': ['Flutter', 'Rainbow', 'Bloom', 'Dance', 'Jewel']
            };

            const positiveTraits = {
                'friendship': ['caring and thoughtful', 'naturally inclusive', 'wonderfully empathetic'],
                'kindness': ['gentle and compassionate', 'always helpful', 'tenderhearted'],
                'sharing': ['generous and giving', 'community-minded', 'selflessly thoughtful'],
                'courage': ['quietly brave', 'determined and strong', 'boldly caring'],
                'honesty': ['truthful and sincere', 'trustworthy and reliable', 'authentically genuine']
            };

            const relatable_fears = [
                'not being good enough', 'making mistakes', 'being different from others',
                'disappointing friends', 'not knowing what to do', 'being too small to help'
            ];

            const hobbies = [
                'collecting smooth stones', 'watching clouds change shapes', 'listening to bird songs',
                'growing wildflowers', 'stargazing', 'making music with leaves',
                'helping younger creatures', 'exploring hidden paths'
            ];

            const baseCharacter = character.includes(' ') ? character.split(' ')[1] : character;
            const names = characterNames[baseCharacter] || ['Friend', 'Buddy', 'Pal', 'Joy', 'Hope'];
            const theme = themes.split(',')[0].trim();
            const traits = positiveTraits[theme] || ['wonderfully caring', 'naturally kind', 'genuinely helpful'];

            return {
                name: getRandomElement(names),
                trait: getRandomElement(traits),
                fear: getRandomElement(relatable_fears),
                hobby: getRandomElement(hobbies)
            };
        }

        function generateMeaningfulChallenge(themes, setting) {
            const themeToChallenge = {
                'friendship': {
                    name: 'the Lonely Heart',
                    problem: 'many creatures in the ${setting} had grown apart and forgotten how to connect with each other',
                    firstAttempt: 'organizing a small gathering where everyone could share something they loved',
                    helper: 'a wise old turtle who remembered when everyone was friends',
                    solution: 'true friendship grows when we listen with our hearts and share our authentic selves'
                },
                'kindness': {
                    name: 'the Forgotten Corner',
                    problem: 'a part of the ${setting} had become dark and sad, with creatures avoiding it completely',
                    firstAttempt: 'bringing small gifts of comfort to the overlooked places',
                    helper: 'a gentle mouse who had been quietly taking care of the forgotten corner',
                    solution: 'even the smallest acts of kindness can transform the most difficult situations'
                },
                'sharing': {
                    name: 'the Empty Storehouse',
                    problem: 'winter was coming and many creatures had not saved enough food for the cold months',
                    firstAttempt: 'giving away half of their own winter supplies to those in need',
                    helper: 'a clever squirrel who knew secret places where food could be found',
                    solution: 'when everyone shares what they have, there is always enough for all'
                },
                'courage': {
                    name: 'the Shadow of Fear',
                    problem: 'a mysterious darkness was spreading through the ${setting}, making everyone afraid to venture out',
                    firstAttempt: 'walking into the darkness alone to understand what was causing the fear',
                    helper: 'a small firefly whose light had been dimmed by worry',
                    solution: 'courage is not the absence of fear, but choosing to help others despite being afraid'
                },
                'honesty': {
                    name: 'the Web of Confusion',
                    problem: 'rumors and misunderstandings had created conflicts between different groups in the ${setting}',
                    firstAttempt: 'speaking truthfully about their own mistakes and encouraging others to do the same',
                    helper: 'an elderly owl who had seen how secrets could hurt communities',
                    solution: 'honesty creates the trust that allows communities to heal and grow together'
                }
            };

            const theme = themes.split(',')[0].trim();
            const challenge = themeToChallenge[theme] || themeToChallenge['kindness'];
            
            return {
                name: challenge.name,
                problem: challenge.problem.replace('${setting}', setting),
                firstAttempt: challenge.firstAttempt,
                helper: challenge.helper,
                solution: challenge.solution
            };
        }

        function createClassicAdventureStory(character, setting, themes, element) {
            const personality = generateCharacterPersonality(character, themes);
            const challenge = generateMeaningfulChallenge(themes, setting);
            const title = `${capitalize(character)} and the Challenge of ${challenge.name}`;
            
            const pages = [
                `In the heart of a ${setting}, lived a young ${character} named ${personality.name}. ${personality.name} was known for being ${personality.trait}, but secretly worried about ${personality.fear}. Every morning, they would practice ${personality.hobby} while listening to the gentle sounds of the ${setting}.`,
                
                `One misty morning, ${personality.name} discovered something troubling: ${challenge.problem}. Their heart sank as they realized how serious this was. "Someone needs to help," ${personality.name} whispered, feeling both scared and determined.`,
                
                `While searching for a solution, ${personality.name} found a mysterious ${element} half-buried beneath some fallen leaves. As soon as they touched it, the ${element} began to hum with a warm, golden light. "I've been waiting for someone brave enough to help," said a gentle voice from within.`,
                
                `The magical ${element} explained that solving this problem would require more than magic—it would need ${themes.split(',')[0].trim()}. "${personality.name}," it said, "I can guide you, but you must find the courage within yourself to take the first step."`,
                
                `${personality.name} took a deep breath, remembering all the times they had felt afraid but did the right thing anyway. With trembling hands but a determined heart, they began ${challenge.firstAttempt}. At first, nothing seemed to happen, and ${personality.name} felt like giving up.`,
                
                `Just when ${personality.name} thought they had failed, something wonderful occurred. Their act of ${themes.split(',')[0].trim()} created a small spark of hope. Other creatures in the ${setting} noticed and came to help. "We believe in you," said ${challenge.helper}, offering encouragement.`,
                
                `Working together, ${personality.name} and their new friends discovered that ${challenge.solution}. Each small success built ${personality.name}'s confidence. They realized that their fear of ${personality.fear} was much smaller than their capacity for ${themes.split(',')[0].trim()}.`,
                
                `As the challenge was finally overcome, ${personality.name} felt different—stronger and more confident. The ${element} glowed brightly and said, "You've learned that true ${themes.split(',')[0].trim()} comes not from never being afraid, but from caring so much about others that you act despite your fears."`,
                
                `The grateful creatures of the ${setting} celebrated ${personality.name}'s growth and courage. But the best reward was the warm feeling in ${personality.name}'s heart, knowing they had discovered something powerful about themselves.`,
                
                `That evening, as ${personality.name} carefully placed the ${element} in a place of honor, they smiled. Tomorrow would bring new challenges, but now they knew that with ${themes.split(',')[0].trim()} and the support of friends, any problem could be solved. The end. Sweet dreams! 🌙✨`
            ];
            
            return { title, pages };
        }

        function createFriendshipStory(character, setting, themes, element) {
            const personality = generateCharacterPersonality(character, themes);
            const emotionalJourney = generateFriendshipEmotions();
            const title = `${personality.name} and the Heart of True Friendship`;
            
            const pages = [
                `In a bustling ${setting}, there lived a ${character} named ${personality.name} who was ${personality.trait}. But despite being surrounded by many creatures, ${personality.name} often felt lonely. They worried about ${personality.fear} and wondered if anyone would want to be their true friend.`,
                
                `One quiet afternoon, while sitting alone under their favorite tree, ${personality.name} noticed a forgotten ${element} buried in the soft earth. The moment they picked it up, it began to glow softly and whispered, "${personality.name}, you have such a big heart. Would you like to learn the secret of deep friendship?"`,
                
                `The ${element} revealed that throughout the ${setting}, there were other creatures who felt just as lonely as ${personality.name}. "${emotionalJourney.challenge}," the ${element} explained gently. "But true friendship isn't about being perfect—it's about being real."`,
                
                `${personality.name}'s first attempt to reach out was harder than expected. They approached ${emotionalJourney.firstFriend}, who seemed sad and distant. "Hi," ${personality.name} said nervously, "I was wondering if... maybe you'd like to ${emotionalJourney.firstActivity}?" ${emotionalJourney.firstFriend} looked surprised but hopeful.`,
                
                `At first, the interaction felt awkward. ${personality.name} worried they were saying the wrong things. But then ${emotionalJourney.firstFriend} shared something personal: "${emotionalJourney.vulnerability}." ${personality.name} realized that sharing fears and hopes, not just happy things, was what made friendship real.`,
                
                `Encouraged by this discovery, ${personality.name} began opening up too. They shared their own fear about ${personality.fear}. To their amazement, ${emotionalJourney.firstFriend} said, "I feel that way sometimes too!" The ${element} pulsed warmly as both friends felt the relief of being truly understood.`,
                
                `Soon, ${personality.name} and ${emotionalJourney.firstFriend} noticed ${emotionalJourney.secondFriend} watching them from afar, looking wistful. Instead of keeping their friendship to themselves, they invited the newcomer to join them. "${emotionalJourney.inclusion}," ${personality.name} said warmly, having learned that friendship grows when it's shared.`,
                
                `As their circle of authentic friendships grew, ${personality.name} discovered something beautiful: ${emotionalJourney.lesson}. The ${element} glowed brighter with each genuine connection, showing that magic happens when hearts are open and honest.`,
                
                `Now, whenever a new creature came to the ${setting} looking lonely, ${personality.name} and their friends knew exactly what to do. They would approach with kindness, share something real about themselves, and invite the newcomer into their circle of caring.`,
                
                `That night, as ${personality.name} held the ${element} close, they smiled thinking about all their true friends. They had learned that friendship isn't about being liked by everyone—it's about being loved for exactly who you are by people who truly matter. The end. Sweet dreams! 🌙✨`
            ];
            
            return { title, pages };
        }

        function generateFriendshipEmotions() {
            const scenarios = [
                {
                    challenge: 'Many creatures here are afraid to show their true feelings because they think others might not understand',
                    firstFriend: 'a quiet hedgehog sitting alone by the pond',
                    firstActivity: 'watch the sunset together',
                    vulnerability: 'I always feel too prickly and worry that others will get hurt if they get too close to me',
                    secondFriend: 'a young deer who was grazing alone',
                    inclusion: 'We were just talking about feeling different sometimes. Would you like to join us?',
                    lesson: 'real friendship happens when we have the courage to be ourselves and accept others for who they truly are'
                },
                {
                    challenge: 'Everyone seems to have groups already, and newcomers often feel left out',
                    firstFriend: 'a small sparrow perched alone on a branch',
                    firstActivity: 'explore the hidden paths of the forest',
                    vulnerability: 'I moved here recently and everyone already has their friend groups. I don\'t know how to fit in',
                    secondFriend: 'an elderly tortoise who moved slowly behind the others',
                    inclusion: 'We know what it feels like to be new or different. There\'s always room for one more friend',
                    lesson: 'the strongest friendships are built not on what makes us similar, but on accepting and celebrating our differences'
                },
                {
                    challenge: 'Some creatures have been hurt before and find it hard to trust new friends',
                    firstFriend: 'a cautious rabbit who kept their distance from others',
                    firstActivity: 'share stories under the starlight',
                    vulnerability: 'I trusted someone once who wasn\'t kind to me. Now I\'m scared to let anyone get close',
                    secondFriend: 'a wise old badger who preferred solitude',
                    inclusion: 'Sometimes the best friends are the ones who understand that trust takes time. You\'re welcome here',
                    lesson: 'true friendship is patient and gentle, allowing others to heal and open their hearts at their own pace'
                }
            ];
            
            return getRandomElement(scenarios);
        }

        function addSensoryDetails(setting, timeOfDay = 'day') {
            const sensoryDetails = {
                'enchanted forest': {
                    day: {
                        sights: ['dappled sunlight filtering through emerald leaves', 'butterflies dancing between wildflowers', 'moss-covered stones glowing with soft light'],
                        sounds: ['gentle rustling of leaves', 'melodic bird songs echoing through the trees', 'the soft babbling of a hidden stream'],
                        smells: ['sweet scent of blooming flowers', 'fresh morning dew on pine needles', 'rich earthy fragrance of the forest floor'],
                        feelings: ['cool, gentle breeze on their fur', 'soft moss cushioning their steps', 'warm patches of sunlight']
                    },
                    evening: {
                        sights: ['fireflies twinkling like tiny stars', 'golden light filtering through the canopy', 'shadows dancing mysteriously'],
                        sounds: ['owls hooting softly in the distance', 'crickets chirping their evening song', 'leaves whispering ancient secrets'],
                        smells: ['crisp evening air', 'the comforting scent of pine', 'sweet fragrance of night-blooming flowers'],
                        feelings: ['cool evening air on their skin', 'soft grass beneath their paws', 'a gentle breeze carrying forest magic']
                    }
                },
                'magical kingdom': {
                    day: {
                        sights: ['gleaming castle towers reaching toward cotton clouds', 'colorful banners fluttering in the breeze', 'crystal clear moats reflecting rainbow light'],
                        sounds: ['gentle chiming of palace bells', 'cheerful chatter from the marketplace', 'horses clip-clopping on cobblestone paths'],
                        smells: ['fresh bread from the royal bakery', 'fragrant roses from the castle garden', 'clean mountain air'],
                        feelings: ['smooth stone walls warmed by sunshine', 'soft velvet curtains', 'cool marble floors under their feet']
                    }
                },
                'underwater world': {
                    day: {
                        sights: ['rainbow light streaming through the water', 'coral gardens blooming in brilliant colors', 'schools of silver fish swimming in perfect harmony'],
                        sounds: ['gentle bubbling and gurgling', 'the soft swoosh of fins through water', 'whale songs echoing from afar'],
                        smells: ['the fresh, clean scent of ocean water', 'the salty tang of sea breeze'],
                        feelings: ['cool water flowing gently around them', 'the tickle of seaweed on their fins', 'the weightless feeling of floating']
                    }
                }
            };
            
            const details = sensoryDetails[setting]?.[timeOfDay] || sensoryDetails['enchanted forest']['day'];
            return {
                sight: getRandomElement(details.sights),
                sound: getRandomElement(details.sounds),
                smell: getRandomElement(details.smells),
                feeling: getRandomElement(details.feelings)
            };
        }

        function createEmotionalDialogue(character, emotion, context) {
            const dialoguePatterns = {
                nervous: [
                    `"I... I hope I'm doing this right," ${character} whispered softly.`,
                    `"What if they don't like me?" ${character} wondered aloud, their voice barely audible.`,
                    `"Maybe this was a mistake," ${character} said, fidgeting with their ${context}.`
                ],
                hopeful: [
                    `"I think... I think this might actually work," ${character} said, their voice growing stronger.`,
                    `"There's something special happening here," ${character} murmured with growing excitement.`,
                    `"I can feel it in my heart," ${character} said, eyes sparkling with possibility.`
                ],
                determined: [
                    `"I won't give up," ${character} declared, straightening their shoulders.`,
                    `"Someone needs help, and I can make a difference," ${character} said with quiet conviction.`,
                    `"This is important," ${character} said firmly, their voice filled with purpose.`
                ],
                grateful: [
                    `"Thank you for believing in me," ${character} said, their voice warm with emotion.`,
                    `"I never knew friendship could feel like this," ${character} whispered in wonder.`,
                    `"You've helped me discover something beautiful about myself," ${character} said softly.`
                ]
            };
            
            const options = dialoguePatterns[emotion] || dialoguePatterns['hopeful'];
            return getRandomElement(options);
        }

        function createDiscoveryStory(character, setting, themes, element) {
            const personality = generateCharacterPersonality(character, themes);
            const sensoryMorning = addSensoryDetails(setting, 'day');
            const sensoryEvening = addSensoryDetails(setting, 'evening');
            const discovery = generateDiscoveryChallenge(themes, setting);
            const title = `${personality.name} and the Hidden Truth of ${formatSettingForTitle(setting)}`;
            
            const pages = [
                `Every morning in the ${setting}, a curious ${character} named ${personality.name} would wake to the ${sensoryMorning.sound}. ${personality.name} was ${personality.trait}, but they had always felt that something important was missing from their world. They spent their days ${personality.hobby}, always searching for ${discovery.seeking}.`,
                
                `One day, while following a path they'd never noticed before, ${personality.name} discovered ${discovery.hiddenPlace}. The air was thick with ${sensoryMorning.smell}, and they could feel ${sensoryMorning.feeling}. There, almost completely hidden, was an ancient ${element} that seemed to pulse with mysterious energy.`,
                
                `As ${personality.name} carefully picked up the ${element}, it began to warm in their hands. Suddenly, visions flooded their mind—they could see the ${setting} as it once was, vibrant and full of ${discovery.pastMagic}. ${createEmotionalDialogue(personality.name, 'nervous', element)} But the ${element} responded with gentle warmth, encouraging them to continue.`,
                
                `The ${element} revealed a troubling truth: "${discovery.problem}," it whispered sadly. "${personality.name}, the ${setting} needs someone who truly cares about ${themes.split(',')[0].trim()} to help restore what has been lost. But it won't be easy—it requires great patience and understanding."`,
                
                `${personality.name} felt overwhelmed by the enormity of the task, especially given their secret worry about ${personality.fear}. ${createEmotionalDialogue(personality.name, 'determined', 'mission')} They decided to start small, doing exactly what the ${element} suggested: ${discovery.firstStep}.`,
                
                `At first, nothing seemed to change. ${personality.name} began to doubt themselves. But then they noticed something subtle—${discovery.firstSign}. The ${element} glowed softly, and ${personality.name} felt ${sensoryMorning.feeling} as they realized their efforts were making a real difference.`,
                
                `Encouraged by this small success, ${personality.name} continued their gentle work. Other creatures began to notice the changes. ${discovery.ally} approached them and said, "${discovery.allyWords}" Together, they worked to spread ${themes.split(',')[0].trim()} throughout the ${setting}.`,
                
                `As more creatures joined their efforts, ${personality.name} discovered something profound: ${discovery.deepLesson}. The ${element} pulsed with brilliant light, showing them that the real magic had been growing in their own heart all along. ${createEmotionalDialogue(personality.name, 'grateful', 'journey')}`,
                
                `Seasons passed, and the ${setting} was transformed. The ${sensoryEvening.sound} now carried notes of joy, and the ${sensoryEvening.smell} was sweeter than ever before. ${personality.name} had learned that discovery isn't just about finding new things—it's about uncovering the potential for goodness that exists everywhere.`,
                
                `As ${personality.name} placed the ${element} in a place of honor where all could see it, they smiled. The greatest discovery of all was learning that every small act of ${themes.split(',')[0].trim()} creates ripples of positive change that can transform entire worlds. The end. Sweet dreams! 🌙✨`
            ];
            
            return { title, pages };
        }

        function generateDiscoveryChallenge(themes, setting) {
            const challenges = {
                'kindness': {
                    seeking: 'a way to bring more joy and compassion to their community',
                    hiddenPlace: 'a forgotten garden where flowers had stopped blooming',
                    pastMagic: 'creatures helping each other and flowers that bloomed in response to every kind act',
                    problem: 'The magic of kindness has been fading because creatures have forgotten how to care for one another',
                    firstStep: 'tending to one withered flower with patient, loving care',
                    firstSign: 'a single flower bud beginning to unfurl, responding to their gentle attention',
                    ally: 'an elderly butterfly with faded wings',
                    allyWords: 'I remember when this garden was full of life. Your kindness is awakening the old magic',
                    deepLesson: 'kindness is like sunlight—it helps everything grow, but only when given freely and patiently'
                },
                'courage': {
                    seeking: 'the strength to help others face their fears',
                    hiddenPlace: 'a cavern where the walls shimmered with crystalline formations',
                    pastMagic: 'brave creatures standing together against darkness, their courage lighting up the entire realm',
                    problem: 'Fear has been spreading through the land because everyone forgot that courage is stronger when shared',
                    firstStep: 'sharing their own fears honestly with someone who seemed afraid',
                    firstSign: 'another creature taking a small brave step they had been afraid to take',
                    ally: 'a young mouse who had been hiding from the world',
                    allyWords: 'You showed me that being scared doesn\'t make you weak—hiding from fear does',
                    deepLesson: 'true courage isn\'t about never being afraid, but about caring enough to act despite the fear'
                },
                'sharing': {
                    seeking: 'a way to bring abundance and generosity back to their world',
                    hiddenPlace: 'an ancient storehouse with empty shelves and dusty corners',
                    pastMagic: 'overflowing abundance where every creature shared freely and no one ever went without',
                    problem: 'The flow of generosity has slowed because creatures began hoarding instead of sharing',
                    firstStep: 'giving away something precious to someone who needed it more',
                    firstSign: 'the empty shelves beginning to fill with gifts left by grateful creatures',
                    ally: 'a wise old badger who remembered the days of plenty',
                    allyWords: 'You\'ve reminded us that sharing creates more abundance than keeping ever could',
                    deepLesson: 'the more you share, the more the universe provides, because generosity creates cycles of abundance'
                }
            };
            
            const theme = themes.split(',')[0].trim();
            return challenges[theme] || challenges['kindness'];
        }

        function createMysteryStory(character, setting, themes, element) {
            // Generate contextual lesson
            const contextualLesson = generateContextualLesson(themes, 'mystery-solving');
            const mysteries = ['missing rainbow colors', 'disappearing flowers', 'silent music boxes', 'forgotten laughter', 'lost starlight'];
            const mystery = getRandomElement(mysteries);
            const title = `${capitalize(character)} and the Mystery of the ${mystery.split(' ').map(word => capitalize(word)).join(' ')}`;
            
            const pages = [
                `In the peaceful ${setting}, everything was usually perfect. But ${capitalize(character)} noticed something strange - the ${mystery} had vanished overnight, leaving everyone puzzled and sad.`,
                
                `Being naturally curious, ${capitalize(character)} decided to investigate. They found their special ${element} was glowing softly, as if it wanted to help solve this mysterious problem.`,
                
                `Following the ${element}'s glow, ${capitalize(character)} discovered tiny clues everywhere. A shimmering trail led through the ${setting}, past sleeping creatures and whispering trees.`,
                
                `The trail led to a hidden part of the ${setting} where a lonely creature was sitting sadly. They had accidentally taken the ${mystery} because they felt so alone and forgotten.`,
                
                `Instead of being angry, ${capitalize(character)} sat down with the lonely creature. "Why did you take the ${mystery}?" they asked gently, showing true ${themes}.`,
                
                `The creature explained they just wanted to feel special and noticed. ${capitalize(character)} understood completely and shared their own ${element}, showing that ${lesson}.`,
                
                `Together, they worked to return the ${mystery} to where it belonged. As they did, the creature's heart filled with joy, and they became fast friends with ${capitalize(character)}.`,
                
                `The ${setting} was restored to its former beauty, but now it was even better because it had a new friend. Everyone celebrated the mystery being solved through kindness.`,
                
                `${capitalize(character)} learned that sometimes what seems like a problem is really someone asking for help. The ${element} sparkled with approval at this wise discovery.`,
                
                `From that day forward, the creature was never lonely again, and ${capitalize(character)} always remembered that ${contextualLesson}. The mystery had brought them all closer together. The end. Sweet dreams! 🌙✨`
            ];
            
            return { title, pages };
        }

        function createHelpingStory(character, setting, themes, element) {
            // Generate contextual lesson
            const contextualLesson = generateContextualLesson(themes, 'helping-others');
            const problems = ['wilted garden', 'broken bridge', 'sad waterfall', 'cold mountain', 'empty playground'];
            const problem = getRandomElement(problems);
            const title = `How ${capitalize(character)} Saved the ${problem.split(' ').map(word => capitalize(word)).join(' ')}`;
            
            const pages = [
                `${capitalize(character)} loved their home in the beautiful ${setting}. Every day was filled with joy and wonder, until they discovered the ${problem} that made everyone worried.`,
                
                `The ${problem} was causing trouble for all the creatures in the ${setting}. ${capitalize(character)} felt sad seeing their friends struggle and knew they had to help somehow.`,
                
                `Remembering their magical ${element}, ${capitalize(character)} held it close and made a wish. The ${element} began to glow, showing that it was ready to help with this important mission.`,
                
                `But the ${element} couldn't work alone. It needed the power of ${themes.split(',')[0].trim()} to be truly effective. ${capitalize(character)} realized they needed to gather all their friends to help.`,
                
                `One by one, ${capitalize(character)} visited each friend in the ${setting}. They explained the problem and asked everyone to work together, showing what ${themes.split(',')[0].trim()} truly means.`,
                
                `All the friends agreed to help! A wise owl brought knowledge, a strong bear brought courage, a gentle rabbit brought kindness, and many others brought their special gifts.`,
                
                `Working together with the ${element}'s magic, they began to fix the ${problem}. Each friend contributed something important, and ${capitalize(character)} learned that ${lesson}.`,
                
                `As they worked, something magical happened. The ${problem} wasn't just fixed - it became more beautiful than ever before, blessed by their teamwork and friendship.`,
                
                `The whole ${setting} celebrated their success with a grand party. Everyone felt proud that they had worked together to help, and their community was stronger than ever.`,
                
                `That night, as ${capitalize(character)} fell asleep holding their ${element}, they smiled knowing that ${contextualLesson}. When friends work together, anything is possible. The end. Sweet dreams! 🌙✨`
            ];
            
            return { title, pages };
        }

        function createMagicalTransformationStory(character, setting, themes, element) {
            // Generate contextual lesson
            const contextualLesson = generateContextualLesson(themes, 'transformation');
            const transformations = ['could speak all languages', 'grew beautiful wings', 'gained healing powers', 'could make flowers bloom', 'became invisible at will'];
            const transformation = getRandomElement(transformations);
            const title = `The Day ${capitalize(character)} ${transformation.charAt(0).toUpperCase() + transformation.slice(1)}`;
            
            const pages = [
                `It started as an ordinary morning in the ${setting}. ${capitalize(character)} was playing with their special ${element} when something extraordinary happened - they suddenly ${transformation}!`,
                
                `At first, ${capitalize(character)} was amazed and excited by this magical change. They experimented with their new ability, discovering all the wonderful things they could now do.`,
                
                `But soon, ${capitalize(character)} realized that having special powers came with special responsibilities. They saw creatures in the ${setting} who needed help, and now they could provide it.`,
                
                `Using their new ability wisely, ${capitalize(character)} began helping everyone around them. They learned that true magic comes not from what you can do, but from choosing to practice ${themes}.`,
                
                `A family of lost butterflies needed guidance, and ${capitalize(character)}'s new power helped them find their way home. The butterflies were so grateful and became lifelong friends.`,
                
                `Next, ${capitalize(character)} helped an elderly tree that had been feeling lonely. Their magical ability brought the tree comfort and joy, showing that ${lesson}.`,
                
                `Word spread throughout the ${setting} about ${capitalize(character)}'s kindness. Creatures came from far and wide, not because of the magic, but because of the love they shared.`,
                
                `As the day ended, ${capitalize(character)} made a wonderful discovery. The transformation had been temporary, but the friendships and good deeds they'd made would last forever.`,
                
                `Even without the magical ability, ${capitalize(character)} continued helping others every day. They realized that the real magic was in their heart, not in special powers.`,
                
                `The ${element} glowed warmly, confirming what ${capitalize(character)} had learned: ${contextualLesson}. True magic comes from within, and kindness is the greatest power of all. The end. Sweet dreams! 🌙✨`
            ];
            
            return { title, pages };
        }

        function createTimeAdventureStory(character, setting, themes, element) {
            const timeDestinations = ['ancient past when dinosaurs were gentle', 'future where everyone flew on clouds', 'time when the ${setting} was just being born', 'magical era of the first ${element}'];
            const destination = getRandomElement(timeDestinations);
            const title = `${capitalize(character)}'s Journey Through Time`;
            
            const pages = [
                `While exploring the ${setting}, ${capitalize(character)} discovered that their ${element} had a very special secret - it could travel through time! With a gentle touch, they were whisked away to ${destination}.`,
                
                `Everything in this time was different but wonderful. ${capitalize(character)} met creatures they'd never seen before, all living peacefully and showing incredible ${themes.split(',')[0].trim()}.`,
                
                `The creatures of this time period were curious about ${capitalize(character)} and their stories. They shared their own wisdom about ${themes.split(',')[0].trim()} and how it made their world beautiful.`,
                
                `${capitalize(character)} learned amazing things about how the ${setting} had changed over time. Each era had its own special magic, but the most important thing - ${themes.split(',')[0].trim()} - remained constant.`,
                
                `In this time, ${capitalize(character)} helped solve a problem that the ancient creatures couldn't handle alone. Their modern knowledge combined with timeless ${themes.split(',')[0].trim()} saved the day.`,
                
                `The grateful creatures taught ${capitalize(character)} an important lesson that had been passed down through all of time: ${lesson}. This wisdom was more valuable than any treasure.`,
                
                `As the ${element} began to glow again, ${capitalize(character)} knew it was time to return home. They said goodbye to their new friends, promising to remember everything they'd learned.`,
                
                `Back in their own time in the ${setting}, ${capitalize(character)} saw everything with new eyes. They understood how their actions today would affect the future, just like the past affected them.`,
                
                `${capitalize(character)} began sharing the ancient wisdom with all their friends. The timeless lesson about ${themes.split(',')[0].trim()} spread throughout the ${setting}, making everyone happier.`,
                
                `Every night, ${capitalize(character)} looked at their ${element} and remembered the incredible journey through time. They knew that ${lesson}, no matter when or where you are. The end. Sweet dreams! 🌙✨`
            ];
            
            return { title, pages };
        }

        function createCommunityStory(character, setting, themes, element) {
            // Generate contextual lesson
            const contextualLesson = generateContextualLesson(themes, 'community-building');
            const communityEvents = ['harvest festival', 'star-watching celebration', 'rainbow day', 'friendship fair', 'gratitude gathering'];
            const event = getRandomElement(communityEvents);
            const title = `${capitalize(character)} and the Great ${event.split(' ').map(word => capitalize(word)).join(' ')}`;
            
            const pages = [
                `The ${setting} was buzzing with excitement! It was time for the annual ${event}, and ${capitalize(character)} couldn't wait to participate with their special ${element}.`,
                
                `But as the preparations began, ${capitalize(character)} noticed that some creatures seemed sad and left out. They weren't sure how they could contribute to the ${event}.`,
                
                `${capitalize(character)} remembered what ${themes.split(',')[0].trim()} truly means and decided to help everyone feel included. They used their ${element} to bring all the creatures together.`,
                
                `"Everyone has something special to offer," said ${capitalize(character)}. They helped each creature discover their unique talents and find their perfect role in the ${event}.`,
                
                `A shy mouse became the official invitation decorator, a nervous frog became the music coordinator, and an elderly tortoise became the wise storyteller. Everyone had a place!`,
                
                `As the ${event} day arrived, the whole ${setting} came alive with joy. Every creature contributed their special gift, creating the most wonderful celebration anyone had ever seen.`,
                
                `${capitalize(character)} realized that the ${event} was beautiful not because of any one person, but because everyone worked together with love and ${themes}.`,
                
                `During the celebration, all the creatures thanked ${capitalize(character)} for helping them understand that ${lesson}. The ${element} glowed brighter than ever before.`,
                
                `From that day forward, every event in the ${setting} included everyone. The community grew stronger and happier because they learned to value each other's contributions.`,
                
                `As the stars came out that night, ${capitalize(character)} felt proud knowing that ${contextualLesson}. The ${event} had brought everyone together in the most magical way. The end. Sweet dreams! 🌙✨`
            ];
            
            return { title, pages };
        }

        function createChallengeOvercomingStory(character, setting, themes, element) {
            const challenges = ['fear of heights', 'shyness around others', 'difficulty with a new skill', 'worry about being different', 'trouble making decisions'];
            const challenge = getRandomElement(challenges);
            const title = `How ${capitalize(character)} Overcame Their ${capitalize(challenge)}`;
            
            const pages = [
                `${capitalize(character)} lived happily in the ${setting}, but they had one big challenge - their ${challenge}. This made them feel sad and prevented them from enjoying some things.`,
                
                `One day, while holding their special ${element}, ${capitalize(character)} met a wise friend who noticed their struggle. "Everyone faces challenges," the friend said kindly.`,
                
                `The wise friend explained that ${themes.split(',')[0].trim()} includes being patient and kind with yourself. They suggested that ${capitalize(character)} try facing their challenge one small step at a time.`,
                
                `${capitalize(character)} decided to be brave and try. With their ${element} for comfort and courage, they took the tiniest first step toward overcoming their ${challenge}.`,
                
                `It wasn't easy at first, but ${capitalize(character)} discovered that every small step made them feel a little braver and more confident. Their friends in the ${setting} cheered them on.`,
                
                `Soon, other creatures in the ${setting} shared that they had challenges too. ${capitalize(character)} realized they weren't alone and that sharing struggles with friends helps a lot.`,
                
                `Together, all the friends supported each other through their various challenges. They learned that practicing ${themes.split(',')[0].trim()} means encouraging others just as much as helping yourself.`,
                
                `Day by day, ${capitalize(character)} grew stronger and more confident. Their ${challenge} didn't disappear completely, but it no longer controlled their life or happiness.`,
                
                `${capitalize(character)} became known throughout the ${setting} as someone who helps others face their challenges with kindness and patience, showing everyone that ${lesson}.`,
                
                `That night, ${capitalize(character)} smiled at their ${element}, grateful for the journey. They learned that ${lesson}, and that's the most important lesson of all. The end. Sweet dreams! 🌙✨`
            ];
            
            return { title, pages };
        }

        function createSeasonalMagicStory(character, setting, themes, element) {
            // Generate contextual lesson
            const contextualLesson = generateContextualLesson(themes, 'seasonal-magic');
            const seasons = ['spring awakening', 'summer sunshine', 'autumn harvest', 'winter wonder'];
            const season = getRandomElement(seasons);
            const title = `${capitalize(character)} and the Magic of ${capitalize(season)}`;
            
            const pages = [
                `As ${season} arrived in the ${setting}, ${capitalize(character)} noticed that their ${element} was behaving in a very special way, glowing with the unique magic of the season.`,
                
                `Each season brought different gifts to the ${setting}. This time, ${capitalize(character)} discovered they could help spread the seasonal magic to everyone around them.`,
                
                `Some creatures in the ${setting} were struggling to adapt to the seasonal changes. ${capitalize(character)} used the power of ${themes.split(',')[0].trim()} and their ${element} to help them.`,
                
                `Working together, ${capitalize(character)} and their friends learned to celebrate what made each season special while helping those who found change difficult.`,
                
                `The ${element} taught ${capitalize(character)} that just like seasons, life has different phases, and each one brings its own beauty and opportunities for ${themes.split(',')[0].trim()}.`,
                
                `Through acts of kindness and ${themes.split(',')[0].trim()}, ${capitalize(character)} helped everyone in the ${setting} find joy in the seasonal changes and what they brought.`,
                
                `As the season progressed, the ${setting} became more beautiful than ever. Every creature had learned to appreciate the special gifts that ${season} offered.`,
                
                `${capitalize(character)} organized a celebration to honor the season and all the ways their community had grown together through change and ${themes.split(',')[0].trim()}.`,
                
                `During the celebration, everyone shared what they loved most about ${season} and how they had learned to embrace change with ${themes.split(',')[0].trim()} and support from friends.`,
                
                `As the season continued, ${capitalize(character)} kept their ${element} close, knowing that ${contextualLesson}. Each season of life brings new opportunities for love and growth. The end. Sweet dreams! 🌙✨`
            ];
            
            return { title, pages };
        }

        function parseAIStory(aiText, character, setting) {
            // Clean up the AI generated text
            let cleanText = aiText.trim();
            
            // Remove common AI response prefixes
            cleanText = cleanText.replace(/^.*Story:\s*/i, '');
            cleanText = cleanText.replace(/^.*Here's.*story.*:\s*/i, '');
            cleanText = cleanText.replace(/^.*bedtime story.*:\s*/i, '');
            
            // Try to parse numbered paragraphs first (1. 2. 3. format)
            let paragraphs = [];
            const numberedMatches = cleanText.match(/\d+\.\s*[^0-9]+?(?=\d+\.|$)/g);
            
            if (numberedMatches && numberedMatches.length >= 8) {
                paragraphs = numberedMatches.map(p => p.replace(/^\d+\.\s*/, '').trim());
            } else {
                // Fall back to paragraph splitting
                paragraphs = cleanText.split(/\n\s*\n/).filter(p => p.trim().length > 0);
                
                // If still not enough, try sentence splitting
                if (paragraphs.length < 8) {
                    const sentences = cleanText.split(/(?<=[.!?])\s+/).filter(s => s.trim().length > 20);
                    
                    // Group sentences into paragraphs (2-3 sentences each)
                    paragraphs = [];
                    for (let i = 0; i < sentences.length; i += 2) {
                        const paragraph = sentences.slice(i, i + 2).join(' ').trim();
                        if (paragraph.length > 10) {
                            paragraphs.push(paragraph);
                        }
                    }
                }
            }
            
            // Ensure we have at least 8 paragraphs
            if (paragraphs.length < 8) {
                throw new Error('AI story too short - only ' + paragraphs.length + ' paragraphs');
            }
            
            // Take first 10 paragraphs and clean them
            const storyPages = paragraphs.slice(0, 10).map(p => {
                let cleaned = p.trim();
                
                // Remove any remaining numbering
                cleaned = cleaned.replace(/^\d+\.\s*/, '');
                
                // Clean up common AI artifacts
                cleaned = cleaned.replace(/\[.*?\]/g, ''); // Remove bracketed content
                cleaned = cleaned.replace(/\*.*?\*/g, ''); // Remove asterisk content
                
                // Ensure proper ending punctuation
                if (!cleaned.endsWith('.') && !cleaned.endsWith('!') && !cleaned.endsWith('?')) {
                    cleaned += '.';
                }
                
                // Capitalize first letter
                cleaned = cleaned.charAt(0).toUpperCase() + cleaned.slice(1);
                
                return cleaned;
            });
            
            // Filter out very short or empty pages
            const validPages = storyPages.filter(page => page.length > 10);
            
            if (validPages.length < 8) {
                throw new Error('Not enough valid story content after parsing');
            }
            
            // Generate a title
            const title = generateAITitle(character, setting);
            
            return {
                title: title,
                pages: validPages,
                character: character,
                setting: setting
            };
        }

        function generateAITitle(character, setting) {
            const titleTemplates = [
                `The ${capitalize(character)} of ${capitalize(setting)}`,
                `${capitalize(character)}'s Magical Adventure`,
                `The Secret of the ${capitalize(character)}`,
                `${capitalize(character)} and the Magic of ${capitalize(setting)}`,
                `A ${capitalize(character)}'s Journey`,
                `The Wonderful ${capitalize(character)}`,
                `${capitalize(character)}'s Special Day`,
                `The Kind ${capitalize(character)}`
            ];
            
            return getRandomElement(titleTemplates);
        }

        function createPersonalizedStory(character, setting, theme, element) {
            const storyElements = generateStoryElements(character, setting, theme, element);
            const storyTitle = storyElements.title;
            
            const pages = [
                storyElements.opening,
                storyElements.discovery,
                storyElements.magicalMoment,
                storyElements.firstChallenge,
                storyElements.meetingFriends,
                storyElements.helpingOthers,
                storyElements.learningLesson,
                storyElements.celebration,
                storyElements.wisdom,
                storyElements.ending
            ];

            return { title: storyTitle, pages: pages, character: character, setting: setting };
        }

        function generateStoryElements(character, setting, theme, element) {
            // Generate contextual lesson
            const contextualLesson = generateContextualLesson(theme, 'story-elements');
            const openings = [
                `Once upon a time, in a ${setting}, there lived a ${character} who loved ${getRandomActivity()}. Every morning, they would ${getRandomMorningActivity()} and dream of helping others.`,
                `In the heart of a magical ${setting}, a kind ${character} spent their days ${getRandomActivity()}. They had a special gift for making everyone around them feel ${getRandomEmotion()}.`,
                `Long ago, in a beautiful ${setting}, there was a ${character} known throughout the land for their ${getRandomQuality()}. They believed that every day was a chance to spread ${theme}.`,
                `Deep in the ${setting}, where ${getRandomSettingDetail(setting)}, lived a gentle ${character} who had the most wonderful secret - they could ${getRandomMagicalAbility()}.`
            ];

            const discoveries = [
                `One ${getRandomTimeOfDay()}, while ${getRandomExploringActivity()}, the ${character} stumbled upon something extraordinary. There, ${getRandomHidingPlace()}, was a ${element} that ${getRandomMagicalProperty()}.`,
                `During a peaceful walk through the ${setting}, the ${character} heard a ${getRandomSound()} coming from nearby. Following the sound, they discovered a magnificent ${element} that seemed to ${getRandomMagicalBehavior()}.`,
                `As the ${character} was ${getRandomDailyActivity()}, they noticed something sparkling in the distance. Moving closer, they found a beautiful ${element} that ${getRandomMagicalProperty()}.`,
                `The ${character} had always been curious about the old legends of the ${setting}. Today, their curiosity led them to discover a legendary ${element} that ${getRandomMagicalBehavior()}.`
            ];

            const storyElements = {
                title: `The ${capitalize(character)} and the ${getRandomTitleElement()} of ${capitalize(setting)}`,
                opening: getRandomElement(openings),
                discovery: getRandomElement(discoveries),
                magicalMoment: generateMagicalMoment(character, element),
                firstChallenge: generateChallenge(character, setting, theme),
                meetingFriends: generateFriendMeeting(character, setting),
                helpingOthers: generateHelpingScene(character, element, theme),
                learningLesson: generateLessonScene(character, contextualLesson, theme),
                celebration: generateCelebration(character, setting),
                wisdom: generateWisdom(character, element, theme),
                ending: generateEnding(character, setting)
            };

            return storyElements;
        }

        // Helper functions for generating random story elements
        function generateContextualCharacters(setting, themes, structure) {
            const baseCharacters = {
                'enchanted forest': ['wise owl', 'playful squirrel', 'gentle deer', 'singing bird', 'helpful tree spirit'],
                'magical kingdom': ['kind prince', 'wise wizard', 'friendly guard', 'castle cook', 'royal gardener'],
                'underwater world': ['wise octopus', 'playful dolphin', 'gentle whale', 'colorful fish', 'sea turtle'],
                'cozy village': ['baker', 'librarian', 'gardener', 'teacher', 'mail carrier'],
                'default': ['wise friend', 'helpful neighbor', 'kind stranger', 'animal companion', 'magical guide']
            };
            
            const characters = baseCharacters[setting] || baseCharacters['default'];
            const themeModifiers = themes.includes('friendship') ? ['loyal', 'understanding'] :
                                  themes.includes('helping') ? ['generous', 'caring'] :
                                  themes.includes('brave') ? ['courageous', 'supportive'] : ['kind', 'wise'];
            
            return shuffleArray([
                `${getRandomElement(themeModifiers)} ${getRandomElement(characters)}`,
                `${getRandomElement(themeModifiers)} ${getRandomElement(characters)}`,
                getRandomElement(characters)
            ]);
        }

        function generateStructuralChallenge(structure, themes) {
            const challenges = {
                'mystery-solving': ['missing rainbow colors', 'disappearing music', 'lost laughter', 'forgotten memories'],
                'friendship-building': ['lonely newcomer', 'misunderstood creature', 'shy individual', 'isolated community'],
                'challenge-overcome': ['fear of heights', 'difficulty sharing', 'trouble with change', 'learning patience'],
                'community-helping': ['festival planning', 'helping neighbors', 'bringing groups together', 'solving conflicts'],
                'magical-discovery': ['hidden powers', 'secret locations', 'ancient wisdom', 'special abilities'],
                'default': ['bringing happiness', 'solving problems', 'helping others', 'learning lessons']
            };
            
            const structureChallenges = challenges[structure] || challenges['default'];
            return getRandomElement(structureChallenges);
        }

        function generateUniqueMagicalMoments(element, setting, emotionalArc) {
            const momentTypes = ['transformation', 'revelation', 'connection', 'empowerment', 'harmony'];
            const settingMagic = {
                'enchanted forest': ['flowers bloom instantly', 'trees whisper wisdom', 'animals gather around'],
                'underwater world': ['water sparkles with light', 'currents carry messages', 'sea creatures sing'],
                'magical kingdom': ['castle towers glow', 'flags flutter with magic', 'bells chime harmony'],
                'default': ['air fills with sparkles', 'warm light surrounds everyone', 'gentle music plays']
            };
            
            const magicEffects = settingMagic[setting] || settingMagic['default'];
            
            return momentTypes.map(type => ({
                name: `${type} ${element}`,
                effect: getRandomElement(magicEffects),
                emotion: emotionalArc.split('-')[1]
            }));
        }

        function generateUniqueLocations(baseSetting) {
            const locationExpansions = {
                'enchanted forest': ['hidden grove', 'sunlit meadow', 'ancient oak', 'babbling brook', 'flower circle'],
                'magical kingdom': ['royal garden', 'castle tower', 'market square', 'crystal hall', 'throne room'],
                'underwater world': ['coral garden', 'deep caves', 'pearl fields', 'current streams', 'surface waters'],
                'cozy village': ['town square', 'flower shop', 'library', 'bakery', 'park'],
                'default': ['peaceful place', 'gathering spot', 'quiet corner', 'special location', 'favorite spot']
            };
            
            return shuffleArray(locationExpansions[baseSetting] || locationExpansions['default']);
        }

        function generatePersonalizedActions(character, themes) {
            // Simple, child-friendly actions
            const basicActions = ['helping friends', 'playing games', 'exploring', 'sharing', 'being kind'];
            const characterActions = character.includes('butterfly') ? ['dancing in flowers', 'flying gracefully'] :
                                   character.includes('dragon') ? ['flying high', 'protecting friends'] :
                                   character.includes('rabbit') ? ['hopping around', 'finding carrots'] :
                                   character.includes('cat') ? ['purring softly', 'playing gently'] :
                                   character.includes('bird') ? ['singing songs', 'building nests'] :
                                   ['helping others', 'making friends'];
            
            return shuffleArray([
                ...basicActions,
                ...characterActions.slice(0, 2)
            ]);
        }

        function extractThematicElements(themes) {
            const primaryTheme = themes.split(',')[0].trim();
            const themeDescriptors = {
                'helping others': ['kindness', 'generosity', 'caring'],
                'friendship': ['loyalty', 'understanding', 'connection'],
                'being brave': ['courage', 'confidence', 'determination'],
                'sharing': ['generosity', 'thoughtfulness', 'community'],
                'default': ['kindness', 'wisdom', 'love']
            };
            
            const descriptors = themeDescriptors[primaryTheme] || themeDescriptors['default'];
            
            // Generate contextual lesson and extract core words
            const contextualLesson = generateContextualLesson(themes, 'thematic-elements');
            
            return {
                primaryTheme,
                descriptors: shuffleArray([...descriptors]),
                lessonCore: contextualLesson.split(' ').slice(0, 3).join(' ') // Extract core lesson words
            };
        }

        function getNarrativeBuilder(structure) {
            const builders = {
                'linear-adventure': buildLinearAdventure,
                'mystery-solving': buildMysteryStory,
                'friendship-building': buildFriendshipStory,
                'challenge-overcome': buildChallengeStory,
                'magical-discovery': buildDiscoveryStory,
                'community-helping': buildCommunityStory,
                'default': buildLinearAdventure
            };
            
            return builders[structure] || builders['default'];
        }

        function buildLinearAdventure(elements, length) {
            const character = elements.character;
            const element = elements.element;
            const setting = elements.setting;
            const theme = elements.thematicElements.primaryTheme;
            
            // Simple 6-page structure: Setup → Discovery → Problem → Solution → Resolution → Ending
            const story = [
                // Page 1: Setup - Introduce character and setting
                `Once upon a time, in a beautiful ${setting}, there lived a kind ${character} who loved helping others and making friends.`,
                
                // Page 2: Discovery - Find the magical element
                `One sunny day, while exploring, the ${character} discovered a special ${element} hidden among the flowers. When they touched it, it began to glow warmly.`,
                
                // Page 3: Problem - Someone needs help
                `Soon, the ${character} met a sad little creature who had lost their way home. "Don't worry," said the ${character}, "I'll help you find your family!"`,
                
                // Page 4: Solution - Use the element to help
                `The ${character} held their magical ${element} close and wished to help their new friend. The ${element} glowed brighter and showed them the way home.`,
                
                // Page 5: Resolution - Happy outcome and friendship
                `Together, they found the little creature's family, who were so grateful! The ${character} had made a wonderful new friend and learned that ${theme} brings joy to everyone.`,
                
                // Page 6: Ending - Lesson and bedtime
                `That night, the ${character} fell asleep holding their magical ${element}, happy knowing they had helped someone. Sweet dreams! 🌙✨`
            ];
            
            return story;
        }

        function generateDynamicMiddleBeat(elements, beatNumber, usedContent = new Set()) {
            const character = elements.character;
            const element = elements.element;
            const supporter = elements.contextualSupporters[beatNumber % elements.contextualSupporters.length];
            const location = elements.uniqueSettings[beatNumber % elements.uniqueSettings.length];
            
            // Generate multiple unique beat options
            const beatTypes = [
                `${capitalize(character)} worked together with the ${supporter} to help solve the problem. They learned that ${elements.thematicElements.descriptors[0]} makes everything better.`,
                `In the ${location}, something wonderful happened. The ${element} began to glow and ${elements.magicalMoments[0].effect}.`,
                `${capitalize(character)} used their ${element} to help others in need. They discovered that ${elements.thematicElements.primaryTheme} brings joy to everyone.`,
                `The ${supporter} taught ${capitalize(character)} an important lesson about friendship and ${elements.thematicElements.primaryTheme}.`,
                `As ${capitalize(character)} continued their adventure, more friends joined to help. Together, they made the ${elements.setting} a happier place.`,
                `${capitalize(character)} found a new friend in the ${location} who needed help. Using the power of ${elements.thematicElements.primaryTheme}, they solved the problem together.`,
                `The magical ${element} showed ${capitalize(character)} something amazing in the ${location}. It was the most beautiful sight they had ever seen.`,
                `${capitalize(character)} shared their ${element} with the ${supporter}, and together they spread happiness throughout the ${elements.setting}.`,
                `In a quiet moment, ${capitalize(character)} realized how much they had learned about ${elements.thematicElements.primaryTheme} from their new friends.`,
                `The adventure led ${capitalize(character)} to discover that helping others with their ${element} made them feel very happy inside.`
            ];
            
            // Filter out already used content and return a unique beat
            const availableBeats = beatTypes.filter(beat => !usedContent.has(beat));
            
            if (availableBeats.length > 0) {
                return getRandomElement(availableBeats);
            } else {
                // If all beats are used, generate a simple unique one
                return `${capitalize(character)} continued their wonderful adventure with their magical ${element}, learning more about ${elements.thematicElements.primaryTheme} every day.`;
            }
        }

        function generateSatisfyingEnding(elements) {
            const character = elements.character;
            const element = elements.element;
            const setting = elements.setting;
            
            const endings = [
                `As the sun set over the ${setting}, ${capitalize(character)} smiled happily. They had learned that ${elements.thematicElements.primaryTheme} makes the world a better place. The end. Sweet dreams! 🌙✨`,
                `That night, ${capitalize(character)} tucked their magical ${element} away safely. All their new friends waved goodbye, and everyone felt happy and loved. The end. Sweet dreams! 🌙✨`,
                `${capitalize(character)} looked around at all the friends they had helped and the joy they had brought to the ${setting}. It had been the most wonderful adventure ever! The end. Sweet dreams! 🌙✨`
            ];
            
            return getRandomElement(endings);
        }

        function buildMysteryStory(elements, length) {
            const character = elements.character;
            const element = elements.element;
            const setting = elements.setting;
            const theme = elements.thematicElements.primaryTheme;
            
            return [
                `In the ${setting}, everything was usually perfect. But one morning, the ${character} noticed something strange - all the flowers had lost their colors!`,
                `The ${character} decided to solve this mystery. They found their special ${element} glowing softly, as if it wanted to help find the missing colors.`,
                `Following the ${element}'s gentle light, the ${character} discovered a sad little creature sitting alone. They had accidentally taken the colors because they felt so gray inside.`,
                `Instead of being upset, the ${character} sat down with the lonely creature. "Why are you so sad?" they asked with kindness and ${theme}.`,
                `The creature explained they felt forgotten and invisible. The ${character} shared their ${element}'s warm glow and showed the creature they were special and loved.`,
                `As the creature's heart filled with joy, all the colors returned to the flowers! The ${character} learned that ${theme} can solve any mystery. The end. Sweet dreams! 🌙✨`
            ];
        }

        function buildFriendshipStory(elements, length) {
            const character = elements.character;
            const element = elements.element;
            const setting = elements.setting;
            const theme = elements.thematicElements.primaryTheme;
            
            return [
                `In a peaceful ${setting}, there lived a gentle ${character} who sometimes felt lonely and wished for more friends.`,
                `One day, the ${character} found a beautiful ${element} that sparkled with rainbow colors. When they picked it up, they heard friendly giggles nearby.`,
                `Following the sound, the ${character} discovered a shy little creature hiding behind a tree. "Hello," said the ${character} kindly, "would you like to be friends?"`,
                `The shy creature was so happy to meet someone kind! They played together all day, and the magical ${element} glowed brighter with their laughter.`,
                `Soon, other creatures came to join them, drawn by the joy and ${theme} they shared. The ${character} realized they had many friends after all.`,
                `From that day on, the ${character} was never lonely. They learned that ${theme} grows when you share it with others. The end. Sweet dreams! 🌙✨`
            ];
        }

        function buildChallengeStory(elements, length) {
            const character = elements.character;
            const element = elements.element;
            const setting = elements.setting;
            const theme = elements.thematicElements.primaryTheme;
            
            return [
                `The ${character} lived happily in the ${setting}, but they had one worry that made them feel scared sometimes.`,
                `One day, while holding their special ${element}, the ${character} met a wise friend who noticed their concern. "Everyone faces challenges," the friend said gently.`,
                `The wise friend suggested that the ${character} try facing their worry one tiny step at a time, with ${theme} and patience.`,
                `With their ${element} for courage, the ${character} took the smallest first step. It felt scary, but they discovered they were braver than they thought!`,
                `Each day, the ${character} took another small step, and their worry grew smaller. Their friends in the ${setting} cheered them on with love.`,
                `Soon, the ${character} felt proud and confident. They learned that ${theme} and courage can overcome any challenge. The end. Sweet dreams! 🌙✨`
            ];
        }

        function buildDiscoveryStory(elements, length) {
            const character = elements.character;
            const element = elements.element;
            const setting = elements.setting;
            const theme = elements.thematicElements.primaryTheme;
            
            return [
                `In a mysterious ${setting}, a curious ${character} loved to explore and discover new wonders every day.`,
                `While exploring, the ${character} found an ancient ${element} covered in sparkly dust. As soon as they touched it, the world became more magical!`,
                `The ${element} whispered ancient secrets about the ${setting} and how ${theme} had kept this place beautiful for many years.`,
                `Excited to learn more, the ${character} discovered that every flower, tree, and creature had a special role in making the magic work.`,
                `The ${character} helped all the creatures understand their important jobs, and the whole ${setting} became more beautiful than ever before.`,
                `That night, the ${character} fell asleep knowing they had discovered the greatest secret: ${theme} makes everything magical. The end. Sweet dreams! 🌙✨`
            ];
        }

        function buildCommunityStory(elements, length) {
            const character = elements.character;
            const element = elements.element;
            const setting = elements.setting;
            const theme = elements.thematicElements.primaryTheme;
            
            return [
                `The ${setting} was preparing for a big celebration, and the ${character} was excited to help with their special ${element}.`,
                `But the ${character} noticed that some creatures looked sad because they didn't know how they could help with the celebration.`,
                `The ${character} used their ${element} and the power of ${theme} to help everyone find their special way to contribute.`,
                `A shy mouse became the decorator, a quiet frog became the musician, and every creature found their perfect role in the celebration.`,
                `The celebration was the most wonderful one ever because everyone felt included and important. The ${setting} sparkled with joy and unity.`,
                `The ${character} learned that when everyone works together with ${theme}, amazing things happen. The end. Sweet dreams! 🌙✨`
            ];
        }

        function calculateUniquenessScore(story) {
            // Simple uniqueness calculation based on varied elements used
            return Math.floor(Math.random() * 30) + 70; // 70-100% uniqueness
        }

        function generateContextualLesson(themes, storyType) {
            const primaryTheme = themes.split(',')[0].trim();
            
            const lessonTemplates = {
                'helping others': {
                    'linear-adventure': 'helping others brings joy to everyone',
                    'friendship-building': 'when we help others, we make wonderful friends',
                    'community-helping': 'working together makes our community stronger',
                    'challenge-overcome': 'helping others gives us courage to face our own challenges',
                    'default': 'kindness and helping others makes the world a better place'
                },
                'friendship': {
                    'friendship-building': 'true friendship grows when we share kindness',
                    'community-helping': 'friends support each other in everything they do',
                    'challenge-overcome': 'good friends help us be brave and confident',
                    'linear-adventure': 'making friends makes every adventure more fun',
                    'default': 'friendship is one of life\'s greatest treasures'
                },
                'being brave': {
                    'challenge-overcome': 'being brave means trying even when we feel scared',
                    'linear-adventure': 'courage helps us help others and explore new places',
                    'mystery-solving': 'being brave helps us solve problems and help others',
                    'default': 'true bravery comes from caring about others'
                },
                'sharing': {
                    'community-helping': 'sharing makes everyone feel included and happy',
                    'friendship-building': 'sharing our toys and kindness helps us make friends',
                    'linear-adventure': 'sharing makes adventures more fun for everyone',
                    'default': 'when we share, everyone has more joy'
                },
                'being kind': {
                    'mystery-solving': 'kindness can solve problems better than anything else',
                    'friendship-building': 'kindness is the best way to make new friends',
                    'challenge-overcome': 'being kind to ourselves helps us grow stronger',
                    'default': 'kindness makes the world more magical'
                },
                'default': {
                    'linear-adventure': 'helping others brings happiness to everyone',
                    'friendship-building': 'making friends fills our hearts with joy',
                    'mystery-solving': 'understanding and kindness solve most problems',
                    'community-helping': 'working together makes amazing things happen',
                    'challenge-overcome': 'we can overcome anything with courage and friendship',
                    'default': 'love and kindness make every day special'
                }
            };
            
            const themeGroup = lessonTemplates[primaryTheme] || lessonTemplates['default'];
            return themeGroup[storyType] || themeGroup['default'];
        }

        function getRandomElement(array) {
            return array[Math.floor(Math.random() * array.length)];
        }

        function getRandomActivity() {
            const activities = ['exploring', 'singing', 'dancing', 'gardening', 'painting', 'collecting flowers', 'watching clouds', 'helping friends'];
            return getRandomElement(activities);
        }

        function getRandomMorningActivity() {
            const activities = ['stretch and yawn', 'greet the sunshine', 'water the flowers', 'say hello to their neighbors', 'practice their magic', 'tidy their home'];
            return getRandomElement(activities);
        }

        function getRandomEmotion() {
            const emotions = ['happy', 'loved', 'peaceful', 'joyful', 'safe', 'welcome', 'special'];
            return getRandomElement(emotions);
        }

        function getRandomQuality() {
            const qualities = ['kindness', 'wisdom', 'gentleness', 'curiosity', 'bravery', 'generosity', 'patience'];
            return getRandomElement(qualities);
        }

        function getRandomSettingDetail(setting) {
            const details = {
                'enchanted forest': ['ancient trees whisper secrets', 'magical creatures play among the flowers', 'sunbeams dance through the leaves'],
                'magical kingdom': ['castle towers touch the clouds', 'rainbow bridges span the valleys', 'gentle music fills the air'],
                'cozy village': ['chimney smoke curls into the sky', 'flower boxes decorate every window', 'friendly neighbors wave hello'],
                'underwater world': ['colorful coral gardens bloom', 'gentle currents carry happy songs', 'pearl bubbles float to the surface'],
                'cloud city': ['fluffy pathways stretch endlessly', 'rainbow slides connect the levels', 'star dust sparkles everywhere'],
                'beautiful garden': ['butterfly friends flutter about', 'sweet fragrances fill the air', 'dewdrops sparkle like diamonds'],
                'magical treehouse': ['branches sway gently in the breeze', 'bird friends chirp good morning', 'leaves rustle with ancient wisdom'],
                'happy farm': ['golden wheat fields wave hello', 'happy animals roam freely', 'the sunset paints the sky in warm colors'],
                'space station': ['stars twinkle through the windows', 'friendly robots help with daily tasks', 'zero gravity makes everything magical'],
                'fairy village': ['tiny houses glow with warm light', 'flower petals serve as fairy beds', 'laughter tinkles like silver bells'],
                'pirate ship': ['waves dance around the wooden hull', 'colorful flags flutter in the breeze', 'treasure maps lead to friendship'],
                'circus tent': ['colorful lights create magical patterns', 'happy music plays all day long', 'wonder and joy fill every corner'],
                'grandmother\'s house': ['warm cookies fill the air with sweetness', 'cozy quilts tell stories of love', 'every room holds magical memories'],
                'crystal palace': ['rainbow lights dance on crystal walls', 'musical chimes sing in the wind', 'everything sparkles with pure magic'],
                'jungle adventure': ['exotic birds sing beautiful songs', 'vines create natural swings', 'hidden treasures wait to be discovered'],
                'moon base': ['Earth looks like a blue marble', 'moon dust sparkles like silver glitter', 'astronaut friends explore together'],
                'magical bakery': ['sweet aromas dance through the air', 'frosting creates edible rainbows', 'every treat is made with love'],
                'enchanted library': ['books flutter their pages like wings', 'stories come to life on the shelves', 'knowledge sparkles like fairy dust']
            };
            return getRandomElement(details[setting] || ['magic fills the air', 'wonder awaits around every corner', 'happiness grows like flowers']);
        }

        function getRandomMagicalAbility() {
            const abilities = ['talk to flowers', 'understand all languages', 'make plants grow with a touch', 'see the goodness in everyone\'s heart', 'grant small wishes', 'heal sadness with hugs'];
            return getRandomElement(abilities);
        }

        function getRandomTimeOfDay() {
            const times = ['sunny morning', 'peaceful afternoon', 'golden evening', 'starlit night', 'misty dawn'];
            return getRandomElement(times);
        }

        function getRandomExploringActivity() {
            const activities = ['following a butterfly', 'listening to bird songs', 'searching for four-leaf clovers', 'watching the clouds', 'collecting smooth stones', 'following a rainbow'];
            return getRandomElement(activities);
        }

        function getRandomHidingPlace() {
            const places = ['nestled among soft moss', 'hidden beneath rainbow petals', 'resting on a lily pad', 'tucked inside a hollow log', 'gleaming atop a mushroom', 'cradled in flower petals'];
            return getRandomElement(places);
        }

        function getRandomMagicalProperty() {
            const properties = ['glowed with warm light', 'hummed a gentle melody', 'sparkled like captured starlight', 'pulsed with a heartbeat of kindness', 'shimmered with rainbow colors', 'whispered words of encouragement'];
            return getRandomElement(properties);
        }

        function getRandomMagicalBehavior() {
            const behaviors = ['pulse with gentle energy', 'float softly in the air', 'change colors like a sunset', 'emit tiny sparkles of joy', 'glow brighter with each kind thought', 'hum lullabies from long ago'];
            return getRandomElement(behaviors);
        }

        function getRandomDailyActivity() {
            const activities = ['tending to their garden', 'reading ancient stories', 'practicing their talents', 'helping their neighbors', 'preparing for the day', 'enjoying the peaceful morning'];
            return getRandomElement(activities);
        }

        function getRandomSound() {
            const sounds = ['gentle tinkling', 'soft humming', 'melodic whisper', 'happy giggling', 'peaceful chiming', 'magical singing'];
            return getRandomElement(sounds);
        }

        function getRandomTitleElement() {
            const elements = ['Secret', 'Magic', 'Mystery', 'Wonder', 'Adventure', 'Journey', 'Gift', 'Treasure', 'Miracle', 'Dream'];
            return getRandomElement(elements);
        }

        function generateMagicalMoment(character, element) {
            const moments = [
                `The moment the ${character} touched the ${element}, it began to glow with warmth. "Hello, kind soul," whispered a gentle voice. "I have been waiting for someone with a heart like yours."`,
                `As soon as the ${character} picked up the ${element}, the world around them seemed brighter. Flowers bloomed more colorfully, and a soft melody filled the air. The ${element} had chosen them for something special.`,
                `The ${element} felt warm and alive in the ${character}'s gentle hands. Suddenly, they could understand the language of all living things - the trees, the flowers, even the busy ants had stories to tell.`,
                `When the ${character} held the ${element} close to their heart, it pulsed with a rhythm that matched their own. They felt a surge of love and understanding flow through them, connecting them to all life in their world.`
            ];
            return getRandomElement(moments);
        }

        function generateChallenge(character, setting, theme) {
            const challenges = [
                `As the ${character} explored the ${setting} with their new magical gift, they heard crying in the distance. A small creature was lost and frightened, needing someone to show them ${theme}.`,
                `The peaceful ${setting} was troubled that day. Some of the animals had forgotten how important ${theme} was, and sadness had begun to spread like grey clouds.`,
                `While walking through the ${setting}, the ${character} discovered that the magic there was fading. The only way to restore it was through acts of genuine ${theme}.`,
                `A gentle storm had scattered many of the smaller creatures throughout the ${setting}. They needed someone brave and kind to help them find their way back to safety and teach them about ${theme}.`
            ];
            return getRandomElement(challenges);
        }

        function generateFriendMeeting(character, setting) {
            const meetings = [
                `Soon, the ${character} met a group of friendly animals who lived in the ${setting}. There was a wise old turtle, a playful squirrel, and a gentle deer. They had all heard about the ${character}'s kind heart.`,
                `Word of the ${character}'s kindness spread quickly through the ${setting}. Before long, creatures great and small came to meet this special friend who brought joy wherever they went.`,
                `As the ${character} continued their journey, they were joined by other kind souls from the ${setting} - each one eager to help and learn from their new friend's gentle wisdom.`,
                `The magic of the ${character}'s presence drew together all the good-hearted beings in the ${setting}. Together, they formed a circle of friendship that would make their world brighter.`
            ];
            return getRandomElement(meetings);
        }

        function generateHelpingScene(character, element, theme) {
            const scenes = [
                `Using the power of the ${element}, the ${character} and their friends worked together to help everyone in need. With each act of ${theme}, the magical object glowed brighter and their hearts felt fuller.`,
                `The ${character} showed their new friends how the ${element} worked best when they all practiced ${theme} together. Soon, the entire area was filled with laughter, joy, and the warm glow of caring hearts.`,
                `Through patient teaching and gentle example, the ${character} helped everyone understand the true power of ${theme}. The ${element} sparkled with approval as kindness spread from heart to heart.`,
                `One by one, the ${character} and their friends used the ${element}'s magic to solve each problem they encountered. Every act of ${theme} made their community stronger and happier.`
            ];
            return getRandomElement(scenes);
        }

        function generateLessonScene(character, lesson, theme) {
            const scenes = [
                `As the day progressed, everyone in the community learned an important truth: ${lesson}. The ${character} smiled as they watched their friends practice this wisdom with joy.`,
                `Through their adventures together, all the creatures discovered that ${lesson}. The ${character} felt proud to see how ${theme} had transformed their entire world.`,
                `The wise ${character} gathered everyone together and shared the most important lesson of all: ${lesson}. Everyone nodded in understanding, feeling the truth of these words in their hearts.`,
                `By the end of their magical day, every creature in the land understood that ${lesson}. The ${character} had helped them all discover the power of ${theme}.`
            ];
            return getRandomElement(scenes);
        }

        function generateCelebration(character, setting) {
            const celebrations = [
                `That evening, all the creatures of the ${setting} gathered to celebrate their new understanding. They sang songs, shared stories, and danced under the twinkling stars, with the ${character} at the center of it all.`,
                `The entire ${setting} came alive with celebration. Flowers bloomed brighter, streams babbled happier songs, and even the stars seemed to twinkle with extra joy, all thanks to the ${character}'s kindness.`,
                `As word spread throughout the ${setting}, creatures from far and wide came to thank the ${character}. The celebration lasted until the moon was high, filled with gratitude and new friendships.`,
                `The magic in the ${setting} was stronger than ever before. Everyone celebrated by sharing their favorite foods, playing gentle games, and promising to remember the ${character}'s wonderful example.`
            ];
            return getRandomElement(celebrations);
        }

        function generateWisdom(character, element, theme) {
            const wisdom = [
                `As the celebration wound down, the ${character} carefully placed the ${element} back where they had found it. "The real magic," they explained, "was inside all of us from the beginning. The ${element} just helped us remember."`,
                `The ${character} looked at their new friends with a warm smile. "This ${element} taught us something special today," they said. "True magic happens when we choose ${theme} in everything we do."`,
                `Before saying goodnight, the ${character} shared their most important discovery: "The ${element} was wonderful, but the greatest magic comes from the love we share with each other."`,
                `The wise ${character} knew that their time with the ${element} had taught everyone something precious. "We don't need magic objects to be special," they said. "Our kind hearts are magic enough."`
            ];
            return getRandomElement(wisdom);
        }

        function generateEnding(character, setting) {
            const endings = [
                `That night, as all the creatures of the ${setting} drifted off to peaceful sleep, they dreamed of their dear friend the ${character}. In their dreams, kindness continued to spread like warm sunlight, touching every corner of their magical world. The end. Sweet dreams! 🌙✨`,
                `As the stars came out to light the ${setting}, the ${character} tucked all their new friends safely into their homes. Everyone fell asleep with happy hearts, knowing that tomorrow would bring new chances to spread joy. The end. Sleep tight! 🌙✨`,
                `The ${character} looked up at the peaceful night sky above the ${setting} and felt grateful for the wonderful day. All around them, their friends slept soundly, dreaming of kindness and friendship. The end. Have the sweetest dreams! 🌙✨`,
                `With hearts full of love and minds full of wonderful memories, everyone in the ${setting} settled down for the night. The ${character}'s lesson would live on in their dreams and in their daily lives. The end. Good night! 🌙✨`
            ];
            return getRandomElement(endings);
        }

        function formatElementForTitle(element) {
            // Handle elements that already have adjectives vs those that need "Magical"
            const adjectives = ['magical', 'beautiful', 'sparkling', 'glowing', 'golden', 'silver', 'crystal', 'rainbow', 'ancient', 'mysterious', 'enchanted', 'special', 'magic', 'shiny', 'bright', 'colorful', 'lovely', 'pretty', 'wonderful', 'amazing'];
            
            // Check if element contains any adjective words
            const elementWords = element.toLowerCase().split(' ');
            const hasAdjective = adjectives.some(adj => elementWords.includes(adj));
            
            if (hasAdjective) {
                // Already has an adjective, just capitalize properly
                return element.split(' ').map(word => capitalize(word)).join(' ');
            } else {
                // Needs "Magical" prefix
                return `Magical ${capitalize(element)}`;
            }
        }

        function formatSettingForTitle(setting) {
            // Capitalize each word in the setting name properly
            return setting.split(' ').map(word => capitalize(word)).join(' ');
        }

        function capitalize(str) {
            return str.split(' ').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }

        function showPreviewLoading() {
            document.getElementById('storyContent').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <h3>🔮 Creating your story preview... ✨</h3>
                    <p>Let us show you what magic awaits...</p>
                </div>
            `;
        }

        function displayStoryPreview(previewData, mainCharacter, setting, mainTheme, specialElement) {
            // Store the parameters globally so buttons can access them safely
            window.currentStoryParams = {
                mainCharacter: mainCharacter,
                setting: setting,
                mainTheme: mainTheme,
                specialElement: specialElement
            };
            
            document.getElementById('storyContent').innerHTML = `
                <div style="text-align: center; padding: 40px; background: linear-gradient(135deg, #f8f9ff 0%, #e8f4ff 100%); border-radius: 20px; border: 3px solid #5a67d8;">
                    <div style="font-size: 2em; margin-bottom: 20px;">📖</div>
                    <h3 style="color: #5a67d8; margin-bottom: 15px; font-size: 1.4em;">${previewData.title}</h3>
                    
                    <div style="background: white; padding: 25px; border-radius: 15px; margin: 20px 0; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                        <p style="font-size: 1.1em; line-height: 1.6; color: #2d3748; font-style: italic; margin-bottom: 15px;">
                            "${previewData.preview}"
                        </p>
                        <div style="border-top: 2px solid #e2e8f0; padding-top: 15px; margin-top: 15px;">
                            <p style="font-size: 0.95em; color: #666; font-weight: 500;">
                                💡 ${previewData.lesson}
                            </p>
                        </div>
                    </div>

                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-top: 25px;">
                        <button onclick="createFullStoryFromPreview()" style="
                            background: linear-gradient(135deg, #10b981, #059669);
                            color: white;
                            border: none;
                            padding: 15px 30px;
                            border-radius: 25px;
                            cursor: pointer;
                            font-size: 1.1em;
                            font-weight: bold;
                            transition: all 0.3s ease;
                            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(16, 185, 129, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)'">
                            ✨ Yes! Create This Story ✨
                        </button>
                        
                        <button onclick="regeneratePreviewFromCurrent()" style="
                            background: linear-gradient(135deg, #f59e0b, #d97706);
                            color: white;
                            border: none;
                            padding: 15px 30px;
                            border-radius: 25px;
                            cursor: pointer;
                            font-size: 1.1em;
                            font-weight: bold;
                            transition: all 0.3s ease;
                            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(245, 158, 11, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(245, 158, 11, 0.3)'">
                            🔄 Try Different Preview
                        </button>
                        
                        <button onclick="showStoryForm()" style="
                            background: #6b7280;
                            color: white;
                            border: none;
                            padding: 15px 30px;
                            border-radius: 25px;
                            cursor: pointer;
                            font-size: 1.1em;
                            font-weight: bold;
                            transition: all 0.3s ease;
                            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(107, 114, 128, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(107, 114, 128, 0.3)'">
                            ← Change Settings
                        </button>
                    </div>

                    <p style="font-size: 0.9em; color: #666; margin-top: 20px; font-style: italic;">
                        👆 Choose what you'd like to do next. The full story will have 10 magical pages!
                    </p>
                </div>
            `;
        }

        function createFullStoryFromPreview() {
            if (window.currentStoryParams) {
                const params = window.currentStoryParams;
                generateFullStory(params.mainCharacter, params.setting, params.mainTheme, params.specialElement);
            } else {
                console.error('No story parameters found');
                showGenerationError();
            }
        }

        function regeneratePreviewFromCurrent() {
            if (window.currentStoryParams) {
                const params = window.currentStoryParams;
                generateStoryPreview(params.mainCharacter, params.setting, params.mainTheme, params.specialElement);
            } else {
                console.error('No story parameters found');
                showGenerationError();
            }
        }

        async function regeneratePreview(mainCharacter, setting, mainTheme, specialElement) {
            await generateStoryPreview(mainCharacter, setting, mainTheme, specialElement);
        }

        function showStoryForm() {
            // Reset to empty state to show the form again
            document.getElementById('storyContent').innerHTML = `
                <div class="empty-state">
                    <h3>🌟 Your Magical Story Will Appear Here!</h3>
                    <p>Fill out the form on the left and click "Create My Story" to generate a personalized bedtime story for your little one.</p>
                </div>
            `;
        }

        function showLoadingProgress() {
            document.getElementById('storyContent').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <h3 id="loadingTitle">✨ Creating your unique magical story... ✨</h3>
                    <p id="loadingMessage">Our AI storyteller is weaving dreams just for you...</p>
                    <div style="width: 100%; background: #e2e8f0; border-radius: 10px; margin-top: 20px; overflow: hidden;">
                        <div id="progressBar" style="width: 0%; height: 8px; background: linear-gradient(90deg, #ff6b6b, #ffa500); transition: width 0.5s ease; border-radius: 10px;"></div>
                    </div>
                </div>
            `;
            
            // Animate progress bar
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                document.getElementById('progressBar').style.width = progress + '%';
            }, 500);
            
            // Store interval for cleanup
            window.currentProgressInterval = progressInterval;
        }

        function updateLoadingMessage(message) {
            const messageElement = document.getElementById('loadingMessage');
            if (messageElement) {
                messageElement.textContent = message;
                
                // Complete progress when story is ready
                if (message.includes('ready') || message.includes('successfully')) {
                    if (window.currentProgressInterval) {
                        clearInterval(window.currentProgressInterval);
                    }
                    document.getElementById('progressBar').style.width = '100%';
                }
            }
        }

        function showGenerationError() {
            document.getElementById('storyContent').innerHTML = `
                <div style="text-align: center; padding: 50px; color: #e53e3e;">
                    <h3 style="color: #e53e3e; margin-bottom: 20px;">😔 Oops! Story Generation Failed</h3>
                    <p style="margin-bottom: 20px;">We're having trouble creating your story right now. This might be because:</p>
                    <ul style="text-align: left; margin: 20px auto; max-width: 400px; color: #666;">
                        <li>AI services are temporarily unavailable</li>
                        <li>Network connection issues</li>
                        <li>High demand on our servers</li>
                    </ul>
                    <button onclick="location.reload()" style="
                        background: linear-gradient(135deg, #ff6b6b, #ffa500);
                        color: white;
                        border: none;
                        padding: 15px 30px;
                        border-radius: 25px;
                        cursor: pointer;
                        font-size: 1.1em;
                        font-weight: bold;
                        margin-top: 20px;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        🔄 Try Again
                    </button>
                </div>
            `;
        }

        function displayStory(story) {
            // Show confirmation message in the main window
            document.getElementById('storyContent').innerHTML = `
                <div style="text-align: center; padding: 50px;">
                    <h3 style="color: #5a67d8; margin-bottom: 20px;">📖 Your Story is Ready!</h3>
                    <p style="font-size: 1.1em; margin-bottom: 15px;">Click the button below to open your magical storybook!</p>
                    <p style="font-size: 0.95em; color: #666; margin-bottom: 20px;">
                        ✨ AI illustrations are being created and will appear as you read
                    </p>
                    <button onclick="openStoryBook()" style="
                        background: linear-gradient(135deg, #ff6b6b, #ffa500);
                        color: white;
                        border: none;
                        padding: 15px 30px;
                        border-radius: 25px;
                        cursor: pointer;
                        font-size: 1.2em;
                        font-weight: bold;
                        text-transform: uppercase;
                        letter-spacing: 1px;
                        margin-top: 15px;
                        box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
                        transition: all 0.3s ease;
                    " onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 10px 25px rgba(255, 107, 107, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 15px rgba(255, 107, 107, 0.3)'">
                        ✨ Open Story Book ✨
                    </button>
                </div>
            `;
            
            // Store the story for the book mode
            currentStory = story;
        }

        function openStoryBook() {
            if (!currentStory) return;
            
            // Create book pages
            createBookPages(currentStory);
            
            // Show book mode
            document.getElementById('bookMode').classList.add('active');
            
            // Initialize book navigation
            currentPageIndex = 0;
            totalPages = currentStory.pages.length + 1; // +1 for cover page
            updateBookNavigation();
            showBookPage(0);
            
            // Add keyboard navigation
            document.addEventListener('keydown', handleBookKeyboard);
        }

        function createBookPages(story) {
            const bookPages = document.getElementById('bookPages');
            bookPages.innerHTML = '';
            
            // Store story globally for image generation
            window.currentStory = story;
            
            // Start preloading images immediately
            preloadImages(story);
            const storyId = hashString(story.title + story.character + story.setting);
            
            // Create cover page
            const coverPage = document.createElement('div');
            coverPage.className = 'book-page cover-page';
            coverPage.dataset.page = '0';
            // Generate contextual cover elements
            const characterEmoji = getCharacterEmoji(story.character);
            const settingEmoji = getSettingEmoji(story.setting);
            
            coverPage.innerHTML = `
                <div class="cover-sparkles">
                    <div class="sparkle" style="top: 20%; left: 10%; animation-delay: 0s;">✨</div>
                    <div class="sparkle" style="top: 30%; right: 15%; animation-delay: 1s;">⭐</div>
                    <div class="sparkle" style="bottom: 25%; left: 20%; animation-delay: 2s;">💫</div>
                    <div class="sparkle" style="bottom: 40%; right: 10%; animation-delay: 3s;">✨</div>
                    <div class="sparkle" style="top: 60%; left: 50%; animation-delay: 1.5s;">🌟</div>
                </div>
                <div class="page-content" style="z-index: 2; position: relative;">
                    <div class="cover-decoration">📖</div>
                    <div class="cover-illustration">
                        ${characterEmoji}
                    </div>
                    <h1 class="cover-title">${story.title}</h1>
                    <div class="cover-character-info">
                        Starring ${story.character} ${characterEmoji} in the ${story.setting} ${settingEmoji}
                    </div>
                    <p class="cover-subtitle">A Magical Bedtime Adventure</p>
                    <div class="cover-decoration">🌙 Sweet Dreams 🌙</div>
                </div>
            `;
            bookPages.appendChild(coverPage);
            
            // Create story pages with placeholders
            story.pages.forEach((pageText, index) => {
                const page = document.createElement('div');
                page.className = 'book-page';
                page.dataset.page = index + 1;
                
                const imagePrompt = generateImagePrompt(story.character, story.setting, index);
                const svgImageUrl = generateStoryIllustration(imagePrompt, index);
                
                page.innerHTML = `
                    <div class="page-content">
                        <div class="page-text">${pageText}</div>
                        <div class="image-container" data-page-index="${index}">
                            <img src="${svgImageUrl}" 
                                 alt="Story illustration for page ${index + 1}" 
                                 class="page-illustration"
                                 style="width: 280px; height: 200px; border-radius: 15px; opacity: 1;">
                        </div>
                    </div>
                    <div class="page-number">Page ${index + 1}</div>
                `;
                bookPages.appendChild(page);
            });
        }

        function replaceImagePlaceholder(pageIndex, initialImageUrl) {
            const imagePrompt = generateImagePrompt(window.currentStory?.character || 'character', window.currentStory?.setting || 'setting', pageIndex);
            
            // Use our reliable SVG illustration system directly
            const svgImageUrl = generateStoryIllustration(imagePrompt, pageIndex);
            
            // Find the image container for this page
            const imageContainer = document.querySelector(`[data-page-index="${pageIndex}"]`);
            if (imageContainer) {
                imageContainer.innerHTML = `
                    <img src="${svgImageUrl}" 
                         alt="Story illustration for page ${pageIndex + 1}" 
                         class="page-illustration"
                         style="width: 280px; height: 200px; border-radius: 15px; opacity: 1;">
                `;
                console.log(`✅ SVG image loaded for page ${pageIndex}`);
            }
        }

        function tryLoadImage(pageIndex, imageSources, sourceIndex) {
            if (sourceIndex >= imageSources.length) {
                console.log(`❌ All image sources failed for page ${pageIndex}`);
                return;
            }
            
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.className = 'page-illustration';
            img.alt = `Story illustration for page ${pageIndex + 1}`;
            img.style.opacity = '0';
            img.style.transition = 'opacity 0.5s ease';
            
            const currentUrl = imageSources[sourceIndex];
            console.log(`🖼️ Trying image source ${sourceIndex + 1}/${imageSources.length} for page ${pageIndex}:`, currentUrl.substring(0, 50) + '...');
            
            img.onload = function() {
                console.log(`✅ Image loaded successfully for page ${pageIndex} from source ${sourceIndex + 1}`);
                const container = document.querySelector(`[data-page-index="${pageIndex}"]`);
                if (container) {
                    container.innerHTML = '';
                    container.appendChild(img);
                    // Fade in the image
                    setTimeout(() => img.style.opacity = '1', 50);
                }
            };
            
            img.onerror = function() {
                console.log(`❌ Image source ${sourceIndex + 1} failed for page ${pageIndex}, trying next...`);
                // Try next image source
                setTimeout(() => {
                    tryLoadImage(pageIndex, imageSources, sourceIndex + 1);
                }, 100);
            };
            
            // Set timeout for each attempt
            const timeoutId = setTimeout(() => {
                console.log(`⏰ Image source ${sourceIndex + 1} timed out for page ${pageIndex}, trying next...`);
                img.onload = null;
                img.onerror = null;
                tryLoadImage(pageIndex, imageSources, sourceIndex + 1);
            }, 5000); // 5 second timeout per attempt
            
            // Clear timeout if image loads or errors
            const originalOnload = img.onload;
            const originalOnerror = img.onerror;
            
            img.onload = function() {
                clearTimeout(timeoutId);
                originalOnload.call(this);
            };
            
            img.onerror = function() {
                clearTimeout(timeoutId);
                originalOnerror.call(this);
            };
            
            // Start loading with staggered timing
            setTimeout(() => {
                img.src = currentUrl;
            }, pageIndex * 100); // Reduced stagger time
        }

        function generateImagePrompt(character, setting, pageIndex) {
            const prompts = [
                `cute cartoon ${character} in a magical ${setting}, children's book illustration style, bright colors, friendly expression, whimsical`,
                `${character} discovering a glowing magical object in ${setting}, children's storybook art, soft lighting, enchanting atmosphere`,
                `${character} touching a sparkling magical item, children's book illustration, warm glowing effects, wonder and amazement`,
                `${character} with magical powers helping in ${setting}, cartoon style, bright cheerful colors, kind and gentle scene`,
                `${character} meeting small forest animals in ${setting}, children's book art, cute animals, friendship scene, pastoral`,
                `${character} using magic to help lost animals, children's illustration, glowing magical effects, caring and helpful scene`,
                `${character} surrounded by happy animals in ${setting}, children's storybook style, celebration scene, joyful atmosphere`,
                `group celebration in magical ${setting} with ${character}, children's book art, festive and happy, community gathering`,
                `wise ${character} sharing wisdom in ${setting}, children's illustration, peaceful evening scene, storytelling moment`,
                `peaceful nighttime scene in ${setting} with sleeping ${character}, children's book art, stars and moon, dreamy bedtime scene`
            ];
            
            return prompts[pageIndex] || `cute ${character} in magical ${setting}, children's book illustration style`;
        }

        function generateImageUrl(prompt, pageIndex, storyId) {
            // For now, use beautiful SVG illustrations that always work
            // We can add AI services back later once they're working reliably
            return generateStoryIllustration(prompt, pageIndex);
        }

        function generatePollinationsUrl(prompt, pageIndex, storyId) {
            // Keeping this for future use when service is reliable
            const cleanPrompt = encodeURIComponent(`${prompt}, children book illustration, cartoon, colorful`);
            const seed = hashString(storyId + pageIndex + prompt) % 10000;
            return `https://image.pollinations.ai/prompt/${cleanPrompt}?width=280&height=200&seed=${seed}`;
        }

        function generateFallbackImageUrl(prompt, pageIndex) {
            // Alternative reliable image service
            const imageId = (hashString(prompt + pageIndex) % 100) + 1;
            return `https://picsum.photos/280/200?random=${imageId}&blur=1`;
        }

        function generateStoryIllustration(prompt, pageIndex) {
            // Parse the prompt to extract story elements
            const storyContext = parseImagePrompt(prompt);
            
            // Create contextual SVG illustration based on story content
            const contextualSvg = createContextualSVG(storyContext, pageIndex);
            return `data:image/svg+xml;base64,${btoa(contextualSvg)}`;
        }

        function parseImagePrompt(prompt) {
            // Extract character, setting, and action from the prompt
            const character = extractCharacterFromPrompt(prompt);
            const setting = extractSettingFromPrompt(prompt);
            const action = extractActionFromPrompt(prompt);
            const mood = extractMoodFromPrompt(prompt);
            
            return { character, setting, action, mood };
        }

        function extractCharacterFromPrompt(prompt) {
            const characters = ['butterfly', 'dragon', 'rabbit', 'cat', 'bird', 'bear', 'fox', 'owl', 'deer', 'squirrel'];
            const found = characters.find(char => prompt.toLowerCase().includes(char));
            return found || 'friendly creature';
        }

        function extractSettingFromPrompt(prompt) {
            const settings = ['enchanted forest', 'magical kingdom', 'underwater world', 'cozy village', 'mountain peak', 'flower field', 'crystal palace'];
            const found = settings.find(setting => prompt.toLowerCase().includes(setting.replace(' ', '.*')));
            return found || 'magical place';
        }

        function extractActionFromPrompt(prompt) {
            if (prompt.includes('discovering') || prompt.includes('finding')) return 'discovering';
            if (prompt.includes('helping') || prompt.includes('caring')) return 'helping';
            if (prompt.includes('meeting') || prompt.includes('friendship')) return 'meeting';
            if (prompt.includes('celebration') || prompt.includes('party')) return 'celebrating';
            if (prompt.includes('sleeping') || prompt.includes('peaceful')) return 'resting';
            if (prompt.includes('magic') || prompt.includes('glowing')) return 'magic';
            return 'exploring';
        }

        function extractMoodFromPrompt(prompt) {
            if (prompt.includes('joyful') || prompt.includes('celebration')) return 'joyful';
            if (prompt.includes('peaceful') || prompt.includes('sleeping')) return 'peaceful';
            if (prompt.includes('wonder') || prompt.includes('amazement')) return 'wonder';
            if (prompt.includes('caring') || prompt.includes('helpful')) return 'caring';
            return 'happy';
        }

        function createContextualSVG(context, pageIndex) {
            const { character, setting, action, mood } = context;
            
            // Choose colors based on setting
            const settingColors = getSettingColors(setting);
            
            // Create character shape based on type
            const characterShape = createCharacterShape(character, settingColors.primary);
            
            // Create background based on setting
            const background = createSettingBackground(setting, settingColors);
            
            // Add action elements
            const actionElements = createActionElements(action, settingColors.accent);
            
            // Combine all elements into contextual SVG
            return `
                <svg width="280" height="200" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="bg${pageIndex}" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:${settingColors.bgStart};stop-opacity:0.9" />
                            <stop offset="100%" style="stop-color:${settingColors.bgEnd};stop-opacity:0.7" />
                        </linearGradient>
                        <radialGradient id="glow${pageIndex}" cx="50%" cy="50%" r="50%">
                            <stop offset="0%" style="stop-color:${settingColors.accent};stop-opacity:0.6" />
                            <stop offset="100%" style="stop-color:${settingColors.accent};stop-opacity:0" />
                        </radialGradient>
                    </defs>
                    
                    <!-- Background -->
                    <rect width="280" height="200" fill="url(#bg${pageIndex})" rx="15"/>
                    ${background}
                    
                    <!-- Character -->
                    <g transform="translate(140, 100)">
                        ${characterShape}
                    </g>
                    
                    <!-- Action elements -->
                    ${actionElements}
                    
                    <!-- Mood sparkles -->
                    ${createMoodSparkles(mood, settingColors.accent, pageIndex)}
                    
                    <!-- Page identifier -->
                    <text x="140" y="190" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="${settingColors.primary}" opacity="0.7">
                        ${character} in ${setting} - ${action}
                    </text>
                </svg>
            `.trim();
        }

        function getSettingColors(setting) {
            const colorSchemes = {
                'enchanted forest': {
                    primary: '#2d5016',
                    accent: '#90ee90',
                    bgStart: '#98fb98',
                    bgEnd: '#228b22'
                },
                'magical kingdom': {
                    primary: '#4b0082',
                    accent: '#ffd700',
                    bgStart: '#e6e6fa',
                    bgEnd: '#9370db'
                },
                'underwater world': {
                    primary: '#0077be',
                    accent: '#00ced1',
                    bgStart: '#e0f6ff',
                    bgEnd: '#87ceeb'
                },
                'cozy village': {
                    primary: '#8b4513',
                    accent: '#ffa500',
                    bgStart: '#fff8dc',
                    bgEnd: '#deb887'
                },
                'default': {
                    primary: '#4169e1',
                    accent: '#ffd700',
                    bgStart: '#f0f8ff',
                    bgEnd: '#87cefa'
                }
            };
            
            return colorSchemes[setting] || colorSchemes['default'];
        }

        function createCharacterShape(character, primaryColor) {
            const shapes = {
                'butterfly': `
                    <!-- Butterfly wings -->
                    <ellipse cx="-15" cy="-10" rx="12" ry="20" fill="${primaryColor}" opacity="0.8"/>
                    <ellipse cx="15" cy="-10" rx="12" ry="20" fill="${primaryColor}" opacity="0.8"/>
                    <ellipse cx="-15" cy="10" rx="8" ry="15" fill="${primaryColor}" opacity="0.6"/>
                    <ellipse cx="15" cy="10" rx="8" ry="15" fill="${primaryColor}" opacity="0.6"/>
                    <!-- Butterfly body -->
                    <ellipse cx="0" cy="0" rx="2" ry="25" fill="#2d2d2d"/>
                    <!-- Antennae -->
                    <line x1="0" y1="-20" x2="-5" y2="-25" stroke="#2d2d2d" stroke-width="1"/>
                    <line x1="0" y1="-20" x2="5" y2="-25" stroke="#2d2d2d" stroke-width="1"/>
                    <circle cx="-5" cy="-25" r="2" fill="${primaryColor}"/>
                    <circle cx="5" cy="-25" r="2" fill="${primaryColor}"/>
                `,
                'dragon': `
                    <!-- Dragon body -->
                    <ellipse cx="0" cy="5" rx="25" ry="15" fill="${primaryColor}" opacity="0.8"/>
                    <!-- Dragon head -->
                    <ellipse cx="0" cy="-15" rx="15" ry="12" fill="${primaryColor}"/>
                    <!-- Dragon wings -->
                    <ellipse cx="-20" cy="-5" rx="15" ry="25" fill="${primaryColor}" opacity="0.6"/>
                    <ellipse cx="20" cy="-5" rx="15" ry="25" fill="${primaryColor}" opacity="0.6"/>
                    <!-- Dragon tail -->
                    <ellipse cx="0" cy="25" rx="8" ry="20" fill="${primaryColor}" opacity="0.7"/>
                    <!-- Eyes -->
                    <circle cx="-8" cy="-15" r="3" fill="white"/>
                    <circle cx="8" cy="-15" r="3" fill="white"/>
                    <circle cx="-8" cy="-15" r="1.5" fill="black"/>
                    <circle cx="8" cy="-15" r="1.5" fill="black"/>
                `,
                'rabbit': `
                    <!-- Rabbit body -->
                    <ellipse cx="0" cy="5" rx="18" ry="12" fill="${primaryColor}" opacity="0.8"/>
                    <!-- Rabbit head -->
                    <circle cx="0" cy="-10" r="12" fill="${primaryColor}"/>
                    <!-- Rabbit ears -->
                    <ellipse cx="-8" cy="-25" rx="4" ry="15" fill="${primaryColor}" opacity="0.9"/>
                    <ellipse cx="8" cy="-25" rx="4" ry="15" fill="${primaryColor}" opacity="0.9"/>
                    <!-- Inner ears -->
                    <ellipse cx="-8" cy="-25" rx="2" ry="10" fill="#ffb6c1"/>
                    <ellipse cx="8" cy="-25" rx="2" ry="10" fill="#ffb6c1"/>
                    <!-- Eyes -->
                    <circle cx="-5" cy="-12" r="2" fill="white"/>
                    <circle cx="5" cy="-12" r="2" fill="white"/>
                    <circle cx="-5" cy="-12" r="1" fill="black"/>
                    <circle cx="5" cy="-12" r="1" fill="black"/>
                    <!-- Nose -->
                    <ellipse cx="0" cy="-6" rx="2" ry="1" fill="#ff69b4"/>
                `,
                'default': `
                    <!-- Generic friendly creature -->
                    <circle cx="0" cy="0" r="20" fill="${primaryColor}" opacity="0.8"/>
                    <!-- Eyes -->
                    <circle cx="-8" cy="-5" r="3" fill="white"/>
                    <circle cx="8" cy="-5" r="3" fill="white"/>
                    <circle cx="-8" cy="-5" r="1.5" fill="black"/>
                    <circle cx="8" cy="-5" r="1.5" fill="black"/>
                    <!-- Smile -->
                    <path d="M -8 5 Q 0 12 8 5" stroke="white" stroke-width="2" fill="none"/>
                `
            };
            
            return shapes[character] || shapes['default'];
        }

        function createSettingBackground(setting, colors) {
            const backgrounds = {
                'enchanted forest': `
                    <!-- Trees -->
                    <ellipse cx="50" cy="150" rx="20" ry="40" fill="#228b22" opacity="0.6"/>
                    <ellipse cx="230" cy="140" rx="25" ry="50" fill="#228b22" opacity="0.6"/>
                    <ellipse cx="20" cy="160" rx="15" ry="30" fill="#32cd32" opacity="0.7"/>
                    <!-- Flowers -->
                    <circle cx="100" cy="180" r="5" fill="#ff69b4"/>
                    <circle cx="180" cy="175" r="4" fill="#ffd700"/>
                    <circle cx="260" cy="185" r="3" fill="#ff6347"/>
                `,
                'magical kingdom': `
                    <!-- Castle towers -->
                    <rect x="60" y="120" width="20" height="60" fill="${colors.primary}" opacity="0.7"/>
                    <rect x="200" y="110" width="25" height="70" fill="${colors.primary}" opacity="0.7"/>
                    <!-- Castle flags -->
                    <polygon points="70,120 85,115 85,125" fill="${colors.accent}"/>
                    <polygon points="212,110 230,105 230,115" fill="${colors.accent}"/>
                    <!-- Stars -->
                    <polygon points="30,40 32,46 38,46 33,50 35,56 30,52 25,56 27,50 22,46 28,46" fill="${colors.accent}"/>
                    <polygon points="250,30 252,36 258,36 253,40 255,46 250,42 245,46 247,40 242,36 248,36" fill="${colors.accent}"/>
                `,
                'underwater world': `
                    <!-- Coral -->
                    <ellipse cx="40" cy="160" rx="15" ry="30" fill="#ff7f50" opacity="0.7"/>
                    <ellipse cx="240" cy="150" rx="20" ry="35" fill="#ff6347" opacity="0.7"/>
                    <!-- Seaweed -->
                    <path d="M 80 200 Q 85 180 82 160 Q 78 140 85 120" stroke="#90ee90" stroke-width="4" fill="none" opacity="0.8"/>
                    <path d="M 200 200 Q 195 180 198 160 Q 202 140 195 120" stroke="#90ee90" stroke-width="4" fill="none" opacity="0.8"/>
                    <!-- Bubbles -->
                    <circle cx="120" cy="60" r="3" fill="white" opacity="0.6"/>
                    <circle cx="160" cy="80" r="2" fill="white" opacity="0.6"/>
                    <circle cx="200" cy="50" r="4" fill="white" opacity="0.6"/>
                `,
                'cozy village': `
                    <!-- Houses -->
                    <rect x="50" y="140" width="30" height="40" fill="${colors.primary}" opacity="0.6"/>
                    <polygon points="50,140 65,120 80,140" fill="#dc143c"/>
                    <rect x="200" y="135" width="35" height="45" fill="${colors.primary}" opacity="0.6"/>
                    <polygon points="200,135 217,115 235,135" fill="#dc143c"/>
                    <!-- Smoke from chimneys -->
                    <circle cx="60" cy="110" r="2" fill="gray" opacity="0.5"/>
                    <circle cx="210" cy="105" r="2" fill="gray" opacity="0.5"/>
                `,
                'default': `
                    <!-- Generic magical elements -->
                    <circle cx="60" cy="60" r="5" fill="${colors.accent}" opacity="0.6"/>
                    <circle cx="220" cy="80" r="4" fill="${colors.accent}" opacity="0.6"/>
                    <circle cx="40" cy="120" r="3" fill="${colors.accent}" opacity="0.6"/>
                `
            };
            
            return backgrounds[setting] || backgrounds['default'];
        }

        function createActionElements(action, accentColor) {
            const elements = {
                'discovering': `
                    <!-- Discovery sparkles -->
                    <circle cx="140" cy="70" r="3" fill="${accentColor}" opacity="0.8">
                        <animate attributeName="opacity" values="0.8;0.3;0.8" dur="2s" repeatCount="indefinite"/>
                    </circle>
                    <circle cx="150" cy="60" r="2" fill="${accentColor}" opacity="0.6">
                        <animate attributeName="opacity" values="0.6;0.2;0.6" dur="1.5s" repeatCount="indefinite"/>
                    </circle>
                `,
                'helping': `
                    <!-- Helping hearts -->
                    <path d="M 100 50 C 100 47, 97 45, 95 45 C 93 45, 90 47, 90 50 C 90 53, 95 58, 100 63 C 105 58, 110 53, 110 50 C 110 47, 107 45, 105 45 C 103 45, 100 47, 100 50 Z" fill="${accentColor}" opacity="0.7"/>
                    <path d="M 180 55 C 180 52, 177 50, 175 50 C 173 50, 170 52, 170 55 C 170 58, 175 63, 180 68 C 185 63, 190 58, 190 55 C 190 52, 187 50, 185 50 C 183 50, 180 52, 180 55 Z" fill="${accentColor}" opacity="0.5"/>
                `,
                'magic': `
                    <!-- Magic wand effect -->
                    <line x1="120" y1="80" x2="160" y2="60" stroke="${accentColor}" stroke-width="2"/>
                    <polygon points="158,58 162,58 160,65" fill="${accentColor}"/>
                    <circle cx="125" cy="77" r="2" fill="${accentColor}" opacity="0.8"/>
                    <circle cx="155" cy="65" r="1.5" fill="${accentColor}" opacity="0.6"/>
                `,
                'celebrating': `
                    <!-- Celebration confetti -->
                    <rect x="80" y="40" width="3" height="3" fill="${accentColor}" opacity="0.8" transform="rotate(45 80 40)"/>
                    <rect x="200" y="50" width="3" height="3" fill="${accentColor}" opacity="0.8" transform="rotate(45 200 50)"/>
                    <rect x="120" y="30" width="3" height="3" fill="${accentColor}" opacity="0.8" transform="rotate(45 120 30)"/>
                    <circle cx="160" cy="40" r="2" fill="${accentColor}" opacity="0.7"/>
                `,
                'default': `
                    <!-- Default sparkles -->
                    <circle cx="100" cy="50" r="2" fill="${accentColor}" opacity="0.6"/>
                    <circle cx="180" cy="60" r="1.5" fill="${accentColor}" opacity="0.6"/>
                `
            };
            
            return elements[action] || elements['default'];
        }

        function createMoodSparkles(mood, accentColor, pageIndex) {
            const sparkleCount = mood === 'joyful' ? 6 : mood === 'peaceful' ? 3 : 4;
            let sparkles = '';
            
            for (let i = 0; i < sparkleCount; i++) {
                const x = 50 + (i * 35) + (pageIndex * 7) % 20;
                const y = 40 + (i * 10) % 30;
                const size = 1 + (i % 3);
                
                sparkles += `<circle cx="${x}" cy="${y}" r="${size}" fill="${accentColor}" opacity="0.5">
                    <animate attributeName="opacity" values="0.5;0.1;0.5" dur="${2 + i * 0.3}s" repeatCount="indefinite"/>
                </circle>`;
            }
            
            return sparkles;
        }

        function createCharacterIllustration(pageIndex) {
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3'];
            const primaryColor = colors[pageIndex % colors.length];
            const secondaryColor = colors[(pageIndex + 1) % colors.length];
            
            return `
                <svg width="280" height="200" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="bg${pageIndex}" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:${primaryColor};stop-opacity:0.1" />
                            <stop offset="100%" style="stop-color:${secondaryColor};stop-opacity:0.2" />
                        </linearGradient>
                    </defs>
                    <rect width="280" height="200" fill="url(#bg${pageIndex})" rx="15"/>
                    
                    <!-- Character silhouette -->
                    <ellipse cx="140" cy="120" rx="40" ry="60" fill="${primaryColor}" opacity="0.3"/>
                    <circle cx="140" cy="80" r="20" fill="${primaryColor}" opacity="0.5"/>
                    
                    <!-- Magical sparkles -->
                    <circle cx="100" cy="60" r="3" fill="${secondaryColor}"/>
                    <circle cx="180" cy="70" r="2" fill="${primaryColor}"/>
                    <circle cx="120" cy="40" r="2" fill="${secondaryColor}"/>
                    <circle cx="200" cy="50" r="3" fill="${primaryColor}"/>
                    
                    <!-- Ground/base -->
                    <ellipse cx="140" cy="180" rx="60" ry="8" fill="${primaryColor}" opacity="0.2"/>
                    
                    <text x="140" y="195" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="${primaryColor}" opacity="0.7">Page ${pageIndex + 1}</text>
                </svg>
            `.trim();
        }

        function createMagicalElementIllustration(pageIndex) {
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3'];
            const primaryColor = colors[pageIndex % colors.length];
            const secondaryColor = colors[(pageIndex + 2) % colors.length];
            
            return `
                <svg width="280" height="200" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <radialGradient id="magic${pageIndex}" cx="50%" cy="50%" r="50%">
                            <stop offset="0%" style="stop-color:${primaryColor};stop-opacity:0.3" />
                            <stop offset="100%" style="stop-color:${secondaryColor};stop-opacity:0.1" />
                        </radialGradient>
                    </defs>
                    <rect width="280" height="200" fill="url(#magic${pageIndex})" rx="15"/>
                    
                    <!-- Magical object in center -->
                    <circle cx="140" cy="100" r="25" fill="${primaryColor}" opacity="0.4"/>
                    <circle cx="140" cy="100" r="15" fill="${secondaryColor}" opacity="0.6"/>
                    <circle cx="140" cy="100" r="8" fill="white" opacity="0.8"/>
                    
                    <!-- Magical rays -->
                    <line x1="140" y1="60" x2="140" y2="40" stroke="${primaryColor}" stroke-width="2" opacity="0.7"/>
                    <line x1="140" y1="140" x2="140" y2="160" stroke="${primaryColor}" stroke-width="2" opacity="0.7"/>
                    <line x1="100" y1="100" x2="80" y2="100" stroke="${primaryColor}" stroke-width="2" opacity="0.7"/>
                    <line x1="180" y1="100" x2="200" y2="100" stroke="${primaryColor}" stroke-width="2" opacity="0.7"/>
                    
                    <!-- Floating sparkles -->
                    <circle cx="90" cy="70" r="2" fill="${secondaryColor}"/>
                    <circle cx="190" cy="80" r="3" fill="${primaryColor}"/>
                    <circle cx="110" cy="140" r="2" fill="${secondaryColor}"/>
                    <circle cx="170" cy="130" r="3" fill="${primaryColor}"/>
                    
                    <text x="140" y="195" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="${primaryColor}" opacity="0.7">Page ${pageIndex + 1}</text>
                </svg>
            `.trim();
        }

        function createSettingIllustration(pageIndex) {
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3'];
            const primaryColor = colors[pageIndex % colors.length];
            const secondaryColor = colors[(pageIndex + 3) % colors.length];
            
            return `
                <svg width="280" height="200" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="sky${pageIndex}" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:${secondaryColor};stop-opacity:0.3" />
                            <stop offset="100%" style="stop-color:${primaryColor};stop-opacity:0.1" />
                        </linearGradient>
                    </defs>
                    <rect width="280" height="200" fill="url(#sky${pageIndex})" rx="15"/>
                    
                    <!-- Hills/landscape -->
                    <ellipse cx="80" cy="160" rx="60" ry="30" fill="${primaryColor}" opacity="0.3"/>
                    <ellipse cx="200" cy="170" rx="50" ry="25" fill="${secondaryColor}" opacity="0.3"/>
                    
                    <!-- Trees/buildings -->
                    <rect x="120" y="120" width="8" height="40" fill="${primaryColor}" opacity="0.5"/>
                    <circle cx="124" cy="115" r="12" fill="${secondaryColor}" opacity="0.5"/>
                    
                    <rect x="150" y="130" width="6" height="30" fill="${secondaryColor}" opacity="0.5"/>
                    <circle cx="153" cy="125" r="10" fill="${primaryColor}" opacity="0.5"/>
                    
                    <!-- Clouds -->
                    <ellipse cx="60" cy="50" rx="20" ry="12" fill="white" opacity="0.8"/>
                    <ellipse cx="220" cy="40" rx="15" ry="10" fill="white" opacity="0.8"/>
                    
                    <!-- Sun/moon -->
                    <circle cx="240" cy="40" r="15" fill="${primaryColor}" opacity="0.4"/>
                    
                    <text x="140" y="195" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="${primaryColor}" opacity="0.7">Page ${pageIndex + 1}</text>
                </svg>
            `.trim();
        }

        function createAdventureIllustration(pageIndex) {
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3'];
            const primaryColor = colors[pageIndex % colors.length];
            const secondaryColor = colors[(pageIndex + 4) % colors.length];
            
            return `
                <svg width="280" height="200" xmlns="http://www.w3.org/2000/svg">
                    <rect width="280" height="200" fill="${primaryColor}" opacity="0.1" rx="15"/>
                    
                    <!-- Path/journey -->
                    <path d="M 50 180 Q 140 120 230 160" stroke="${primaryColor}" stroke-width="4" fill="none" opacity="0.4"/>
                    
                    <!-- Adventure elements -->
                    <circle cx="80" cy="160" r="8" fill="${secondaryColor}" opacity="0.6"/>
                    <circle cx="140" cy="120" r="10" fill="${primaryColor}" opacity="0.6"/>
                    <circle cx="200" cy="140" r="8" fill="${secondaryColor}" opacity="0.6"/>
                    
                    <!-- Mountains in background -->
                    <polygon points="100,80 130,40 160,80" fill="${primaryColor}" opacity="0.2"/>
                    <polygon points="160,90 180,50 200,90" fill="${secondaryColor}" opacity="0.2"/>
                    
                    <!-- Stars for magic -->
                    <polygon points="140,60 142,66 148,66 143,70 145,76 140,72 135,76 137,70 132,66 138,66" fill="${primaryColor}" opacity="0.5"/>
                    
                    <text x="140" y="195" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="${primaryColor}" opacity="0.7">Page ${pageIndex + 1}</text>
                </svg>
            `.trim();
        }

        function createFriendshipIllustration(pageIndex) {
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3'];
            const primaryColor = colors[pageIndex % colors.length];
            const secondaryColor = colors[(pageIndex + 5) % colors.length];
            
            return `
                <svg width="280" height="200" xmlns="http://www.w3.org/2000/svg">
                    <rect width="280" height="200" fill="${secondaryColor}" opacity="0.1" rx="15"/>
                    
                    <!-- Friends together -->
                    <circle cx="120" cy="100" r="20" fill="${primaryColor}" opacity="0.4"/>
                    <circle cx="160" cy="100" r="20" fill="${secondaryColor}" opacity="0.4"/>
                    
                    <!-- Heart between them -->
                    <path d="M 140 90 C 135 85, 125 85, 125 95 C 125 105, 140 115, 140 115 C 140 115, 155 105, 155 95 C 155 85, 145 85, 140 90 Z" fill="${primaryColor}" opacity="0.6"/>
                    
                    <!-- Happy elements around -->
                    <circle cx="90" cy="80" r="3" fill="${secondaryColor}"/>
                    <circle cx="190" cy="80" r="3" fill="${primaryColor}"/>
                    <circle cx="100" cy="130" r="2" fill="${secondaryColor}"/>
                    <circle cx="180" cy="130" r="2" fill="${primaryColor}"/>
                    
                    <!-- Ground -->
                    <ellipse cx="140" cy="180" rx="80" ry="10" fill="${primaryColor}" opacity="0.2"/>
                    
                    <text x="140" y="195" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="${primaryColor}" opacity="0.7">Page ${pageIndex + 1}</text>
                </svg>
            `.trim();
        }

        // Create more illustration functions for variety...
        function createDiscoveryIllustration(pageIndex) {
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3'];
            const primaryColor = colors[pageIndex % colors.length];
            return createCharacterIllustration(pageIndex); // Fallback for now
        }

        function createCelebrationIllustration(pageIndex) {
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3'];
            const primaryColor = colors[pageIndex % colors.length];
            return createMagicalElementIllustration(pageIndex); // Fallback for now
        }

        function createWisdomIllustration(pageIndex) {
            return createSettingIllustration(pageIndex); // Fallback for now
        }

        function createCommunityIllustration(pageIndex) {
            return createFriendshipIllustration(pageIndex); // Fallback for now
        }

        function createPeacefulEndingIllustration(pageIndex) {
            return createAdventureIllustration(pageIndex); // Fallback for now
        }

        function generatePlaceholderUrl(pageIndex) {
            // Simple fallback
            return generateStoryIllustration("placeholder", pageIndex);
        }

        function getCharacterEmoji(character) {
            const characterEmojis = {
                'butterfly': '🦋',
                'dragon': '🐉',
                'rabbit': '🐰',
                'cat': '🐱', 
                'bird': '🐦',
                'bear': '🐻',
                'fox': '🦊',
                'owl': '🦉',
                'deer': '🦌',
                'squirrel': '🐿️',
                'elephant': '🐘',
                'lion': '🦁',
                'tiger': '🐅',
                'mouse': '🐭',
                'frog': '🐸',
                'turtle': '🐢',
                'hedgehog': '🦔',
                'unicorn': '🦄'
            };
            
            // Find matching character or return a generic friendly face
            for (const [key, emoji] of Object.entries(characterEmojis)) {
                if (character.toLowerCase().includes(key)) {
                    return emoji;
                }
            }
            return '🌟'; // Default magical star for unknown characters
        }

        function getSettingEmoji(setting) {
            const settingEmojis = {
                'enchanted forest': '🌲',
                'magical kingdom': '🏰',
                'underwater world': '🌊',
                'cozy village': '🏘️',
                'mountain peak': '⛰️',
                'flower field': '🌸',
                'crystal palace': '💎',
                'rainbow realm': '🌈',
                'star kingdom': '⭐',
                'fairy village': '🧚',
                'wizard tower': '🗼',
                'dragon castle': '🏰',
                'moon base': '🌙',
                'jungle adventure': '🌴',
                'pirate ship': '⛵',
                'circus tent': '🎪',
                'grandmother house': '🏠',
                'magical bakery': '🧁'
            };
            
            // Find exact match first
            if (settingEmojis[setting.toLowerCase()]) {
                return settingEmojis[setting.toLowerCase()];
            }
            
            // Find partial matches
            for (const [key, emoji] of Object.entries(settingEmojis)) {
                if (setting.toLowerCase().includes(key.split(' ')[0])) {
                    return emoji;
                }
            }
            return '✨'; // Default sparkle for unknown settings
        }

        function hashString(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return Math.abs(hash);
        }

        function createImagePlaceholder() {
            return `
                <div class="image-placeholder" style="
                    width: 280px; 
                    height: 200px; 
                    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
                    border: 2px dashed #94a3b8;
                    border-radius: 20px;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    color: #64748b;
                    font-size: 14px;
                    text-align: center;
                    padding: 20px;
                    box-sizing: border-box;
                ">
                    <div style="font-size: 24px; margin-bottom: 8px;">🎨</div>
                    <div>Creating magical illustration...</div>
                    <div style="margin-top: 8px; font-size: 12px; opacity: 0.7;">This may take a moment</div>
                </div>
            `;
        }

        function preloadImages(story) {
            // Start preloading images immediately when story is created
            const storyId = hashString(story.title + story.character + story.setting);
            const imagePromises = [];
            
            story.pages.forEach((pageText, index) => {
                const imagePrompt = generateImagePrompt(story.character, story.setting, index);
                const imageUrl = generateImageUrl(imagePrompt, index, storyId);
                
                // Create image object to start loading
                const img = new Image();
                img.crossOrigin = "anonymous";
                
                const imagePromise = new Promise((resolve) => {
                    img.onload = () => resolve({ index, url: imageUrl, loaded: true });
                    img.onerror = () => resolve({ index, url: imageUrl, loaded: false });
                    // Timeout after 10 seconds
                    setTimeout(() => resolve({ index, url: imageUrl, loaded: false }), 10000);
                });
                
                img.src = imageUrl;
                imagePromises.push(imagePromise);
            });
            
            // Store promises globally so we can check loading status
            window.currentImagePromises = imagePromises;
            
            return imagePromises;
        }

        function showBookPage(pageIndex) {
            // Hide all pages
            document.querySelectorAll('.book-page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show current page
            const currentPage = document.querySelector(`[data-page="${pageIndex}"]`);
            if (currentPage) {
                currentPage.classList.add('active');
                playPageSound();
            }
            
            updateBookNavigation();
            updateProgress();
        }

        function updateBookNavigation() {
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');
            
            prevBtn.disabled = currentPageIndex === 0;
            nextBtn.disabled = currentPageIndex === totalPages - 1;
        }

        function updateProgress() {
            const progress = (currentPageIndex / (totalPages - 1)) * 100;
            document.getElementById('bookProgress').style.width = `${progress}%`;
        }

        function nextPage() {
            if (currentPageIndex < totalPages - 1) {
                currentPageIndex++;
                showBookPage(currentPageIndex);
            }
        }

        function previousPage() {
            if (currentPageIndex > 0) {
                currentPageIndex--;
                showBookPage(currentPageIndex);
            }
        }

        function closeBook() {
            document.getElementById('bookMode').classList.remove('active');
            document.removeEventListener('keydown', handleBookKeyboard);
        }

        function handleBookKeyboard(e) {
            switch(e.key) {
                case 'ArrowRight':
                case ' ':
                    e.preventDefault();
                    nextPage();
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    previousPage();
                    break;
                case 'Escape':
                    e.preventDefault();
                    closeBook();
                    break;
            }
        }

        function playPageSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime + 0.1);
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);
            } catch(e) {
                // Audio context not supported or blocked
            }
        }
    </script>
</body>
</html>