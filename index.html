<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magical Bedtime Story Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            transition: all 0.8s ease;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            transition: all 0.8s ease;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            align-items: start;
            transition: all 0.8s ease;
        }

        .form-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            transition: all 0.8s ease;
        }

        .story-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            min-height: 600px;
            position: relative;
            transition: all 0.8s ease;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #5a67d8;
            font-size: 1.1em;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #5a67d8;
            box-shadow: 0 0 0 3px rgba(90, 103, 216, 0.1);
            transform: translateY(-2px);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: #f7fafc;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .checkbox-item:hover {
            background: #edf2f7;
            transform: translateY(-1px);
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        .generate-btn {
            background: linear-gradient(135deg, #ff6b6b, #ffa500);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2em;
            font-weight: bold;
            border-radius: 25px;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .generate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(255, 107, 107, 0.4);
        }

        .generate-btn:active {
            transform: translateY(0);
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #5a67d8;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .empty-state h3 {
            margin-bottom: 15px;
            color: #5a67d8;
        }

        /* Book Mode Styles */
        .book-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #2D3748 0%, #1A202C 100%);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.8s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .book-mode.active {
            display: flex;
        }

        .book-container {
            width: 90vw;
            max-width: 1000px;
            height: 85vh;
            max-height: 700px;
            position: relative;
            perspective: 1200px;
        }

        .book {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            background: #8B4513;
            border-radius: 15px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            animation: bookOpen 1s ease 0.5s both;
        }

        @keyframes bookOpen {
            from { 
                transform: rotateY(-30deg) scale(0.8);
                opacity: 0;
            }
            to { 
                transform: rotateY(0deg) scale(1);
                opacity: 1;
            }
        }

        .book-spine {
            position: absolute;
            left: -8px;
            top: 0;
            width: 16px;
            height: 100%;
            background: linear-gradient(to right, #654321, #8B4513);
            border-radius: 8px 0 0 8px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
        }

        .book-page {
            position: absolute;
            width: 100%;
            height: 100%;
            background: #FFFFFF !important;
            border-radius: 12px;
            padding: 50px;
            display: none;
            flex-direction: column;
            overflow-y: auto;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.03);
            background-image: none !important;
            background-size: 40px 40px;
        }

        .book-page.active {
            display: flex;
            animation: pageFlip 0.6s ease;
            background: #FFFFFF !important;
        }

        .book-page.cover-page {
            background: linear-gradient(135deg, #FFE5B4 0%, #E6F3FF 100%) !important;
            background-image: none !important;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .book-page:not(.cover-page) {
            background: #FFFFFF !important;
            background-image: none !important;
        }

        .book-page:not(.cover-page) .page-content {
            display: grid;
            grid-template-columns: 1fr 280px;
            gap: 40px;
            align-items: start;
            flex: 1;
        }

        @keyframes pageFlip {
            0% { transform: rotateY(-90deg); opacity: 0; }
            50% { transform: rotateY(-45deg); opacity: 0.5; }
            100% { transform: rotateY(0deg); opacity: 1; }
        }

        .page-text {
            font-size: 1.4em;
            line-height: 1.8;
            color: #2d3748;
            text-align: justify;
            text-indent: 2em;
        }

        .page-illustration {
            width: 280px;
            height: 200px;
            border-radius: 20px;
            object-fit: cover;
            border: 5px solid #e2e8f0;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            align-self: center;
            transition: transform 0.3s ease;
        }

        .page-illustration:hover {
            transform: scale(1.05);
        }

        .page-number {
            position: absolute;
            bottom: 20px;
            right: 30px;
            background: rgba(90, 103, 216, 0.1);
            color: #5a67d8;
            padding: 10px 18px;
            border-radius: 25px;
            font-size: 1em;
            font-weight: bold;
            backdrop-filter: blur(10px);
        }

        .book-navigation {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 25px;
            z-index: 1001;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.95);
            border: 3px solid #5a67d8;
            color: #5a67d8;
            padding: 15px 25px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s ease;
            backdrop-filter: blur(15px);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nav-btn:hover:not(:disabled) {
            background: #5a67d8;
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(90, 103, 216, 0.4);
        }

        .nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .close-book {
            background: linear-gradient(135deg, #ff6b6b, #ffa500) !important;
            color: white !important;
            border: none !important;
        }

        .close-book:hover {
            background: linear-gradient(135deg, #ff5252, #ff9800) !important;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.4);
        }

        .progress-indicator {
            position: absolute;
            top: 20px;
            left: 30px;
            right: 30px;
            height: 6px;
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #ffa500);
            width: 0%;
            transition: width 0.6s ease;
            border-radius: 3px;
        }

        .magical-bookmark {
            position: absolute;
            top: -15px;
            right: 120px;
            width: 40px;
            height: 100px;
            background: linear-gradient(135deg, #ff6b6b, #ffa500);
            clip-path: polygon(0 0, 100% 0, 100% 85%, 50% 70%, 0 85%);
            box-shadow: 3px 3px 12px rgba(0,0,0,0.3);
            z-index: 1002;
        }

        .cover-decoration {
            font-size: 4em;
            margin: 30px 0;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
        }

        .cover-title {
            font-size: 3em;
            color: #5a67d8;
            margin-bottom: 20px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.2);
        }

        .cover-subtitle {
            font-size: 1.4em;
            color: #666;
            margin-bottom: 40px;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .container {
                padding: 15px;
            }

            .book-page {
                padding: 30px 20px;
            }
            
            .page-content {
                grid-template-columns: 1fr;
                text-align: center;
            }
            
            .page-illustration {
                width: 250px;
                height: 180px;
                margin: 20px auto;
            }
            
            .page-text {
                font-size: 1.2em;
                text-indent: 0;
            }

            .book-navigation {
                flex-wrap: wrap;
                gap: 15px;
            }

            .nav-btn {
                padding: 12px 20px;
                font-size: 1em;
            }
        }

        .magical-elements {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }

        .star {
            position: absolute;
            color: #ffd700;
            animation: twinkle 2s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="magical-elements">
        <div class="star" style="top: 10%; left: 10%; font-size: 20px;">⭐</div>
        <div class="star" style="top: 20%; right: 15%; font-size: 16px;">✨</div>
        <div class="star" style="top: 60%; left: 5%; font-size: 18px;">🌟</div>
        <div class="star" style="bottom: 20%; right: 10%; font-size: 22px;">⭐</div>
        <div class="star" style="bottom: 40%; left: 20%; font-size: 14px;">✨</div>
    </div>

    <div class="container" id="mainContainer">
        <div class="header" id="mainHeader">
            <h1>🌙 Magical Bedtime Story Generator ✨</h1>
            <p>Create personalized bedtime stories for your little ones (ages 2-5)</p>
        </div>

        <div class="main-content" id="mainContent">
            <div class="form-container">
                <form id="storyForm">
                    <div class="form-group">
                        <label for="mainCharacter">Main Character:</label>
                        <select id="mainCharacter" name="mainCharacter">
                            <option value="">Choose a character...</option>
                            <optgroup label="🐲 Dragons & Magical Creatures">
                                <option value="friendly dragon">Friendly Dragon</option>
                                <option value="baby dragon">Baby Dragon</option>
                                <option value="rainbow dragon">Rainbow Dragon</option>
                                <option value="cloud dragon">Cloud Dragon</option>
                                <option value="magical unicorn">Magical Unicorn</option>
                                <option value="flying pegasus">Flying Pegasus</option>
                                <option value="gentle phoenix">Gentle Phoenix</option>
                            </optgroup>
                            <optgroup label="🧚‍♀️ Fairies & Magic Folk">
                                <option value="magical fairy">Magical Fairy</option>
                                <option value="flower fairy">Flower Fairy</option>
                                <option value="star fairy">Star Fairy</option>
                                <option value="forest sprite">Forest Sprite</option>
                                <option value="moon fairy">Moon Fairy</option>
                                <option value="butterfly fairy">Butterfly Fairy</option>
                                <option value="kind wizard">Kind Wizard</option>
                                <option value="magical elf">Magical Elf</option>
                            </optgroup>
                            <optgroup label="🐾 Animal Friends">
                                <option value="talking animal">Talking Animal</option>
                                <option value="playful puppy">Playful Puppy</option>
                                <option value="curious kitten">Curious Kitten</option>
                                <option value="wise owl">Wise Owl</option>
                                <option value="friendly bear">Friendly Bear</option>
                                <option value="bouncy bunny">Bouncy Bunny</option>
                                <option value="singing bird">Singing Bird</option>
                                <option value="dancing fox">Dancing Fox</option>
                                <option value="gentle deer">Gentle Deer</option>
                                <option value="happy elephant">Happy Elephant</option>
                                <option value="clever monkey">Clever Monkey</option>
                                <option value="kind turtle">Kind Turtle</option>
                            </optgroup>
                            <optgroup label="👑 People & Heroes">
                                <option value="brave knight">Brave Knight</option>
                                <option value="kind princess">Kind Princess</option>
                                <option value="helpful prince">Helpful Prince</option>
                                <option value="young explorer">Young Explorer</option>
                                <option value="little gardener">Little Gardener</option>
                                <option value="star keeper">Star Keeper</option>
                                <option value="dream weaver">Dream Weaver</option>
                            </optgroup>
                            <optgroup label="🌟 Special Characters">
                                <option value="gentle giant">Gentle Giant</option>
                                <option value="friendly robot">Friendly Robot</option>
                                <option value="magical teddy bear">Magical Teddy Bear</option>
                                <option value="singing angel">Singing Angel</option>
                                <option value="rainbow spirit">Rainbow Spirit</option>
                                <option value="cloud shepherd">Cloud Shepherd</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="setting">Story Setting:</label>
                        <select id="setting" name="setting">
                            <option value="">Choose a setting...</option>
                            <optgroup label="🌲 Forest & Nature">
                                <option value="enchanted forest">Enchanted Forest</option>
                                <option value="magical woodland">Magical Woodland</option>
                                <option value="secret garden">Secret Garden</option>
                                <option value="flower meadow">Flower Meadow</option>
                                <option value="crystal cave">Crystal Cave</option>
                                <option value="rainbow valley">Rainbow Valley</option>
                                <option value="whispering woods">Whispering Woods</option>
                            </optgroup>
                            <optgroup label="🏰 Magical Places">
                                <option value="magical kingdom">Magical Kingdom</option>
                                <option value="fairy castle">Fairy Castle</option>
                                <option value="floating island">Floating Island</option>
                                <option value="crystal palace">Crystal Palace</option>
                                <option value="enchanted tower">Enchanted Tower</option>
                                <option value="magic library">Magic Library</option>
                                <option value="wizard's workshop">Wizard's Workshop</option>
                            </optgroup>
                            <optgroup label="☁️ Sky & Space">
                                <option value="cloud city">Cloud City</option>
                                <option value="star kingdom">Star Kingdom</option>
                                <option value="moon palace">Moon Palace</option>
                                <option value="rainbow bridge">Rainbow Bridge</option>
                                <option value="sky islands">Sky Islands</option>
                                <option value="dream realm">Dream Realm</option>
                            </optgroup>
                            <optgroup label="🌊 Water Worlds">
                                <option value="underwater world">Underwater World</option>
                                <option value="mermaid lagoon">Mermaid Lagoon</option>
                                <option value="coral castle">Coral Castle</option>
                                <option value="magical lake">Magical Lake</option>
                                <option value="singing river">Singing River</option>
                                <option value="pearl palace">Pearl Palace</option>
                            </optgroup>
                            <optgroup label="🏡 Cozy Places">
                                <option value="cozy village">Cozy Village</option>
                                <option value="magical treehouse">Magical Treehouse</option>
                                <option value="happy farm">Happy Farm</option>
                                <option value="candy cottage">Candy Cottage</option>
                                <option value="toy workshop">Toy Workshop</option>
                                <option value="music box town">Music Box Town</option>
                                <option value="storybook village">Storybook Village</option>
                            </optgroup>
                            <optgroup label="🎪 Adventure Places">
                                <option value="magical circus">Magical Circus</option>
                                <option value="traveling carnival">Traveling Carnival</option>
                                <option value="pirate ship">Friendly Pirate Ship</option>
                                <option value="treasure island">Treasure Island</option>
                                <option value="adventure playground">Adventure Playground</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Story Themes (select all that apply):</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="friendship" name="themes" value="friendship">
                                <label for="friendship">Friendship</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="kindness" name="themes" value="kindness">
                                <label for="kindness">Kindness</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="courage" name="themes" value="courage">
                                <label for="courage">Courage</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="sharing" name="themes" value="sharing">
                                <label for="sharing">Sharing</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="helping" name="themes" value="helping others">
                                <label for="helping">Helping Others</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="adventure" name="themes" value="adventure">
                                <label for="adventure">Adventure</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="creativity" name="themes" value="creativity">
                                <label for="creativity">Creativity</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="patience" name="themes" value="patience">
                                <label for="patience">Patience</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="honesty" name="themes" value="honesty">
                                <label for="honesty">Honesty</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="gratitude" name="themes" value="gratitude">
                                <label for="gratitude">Gratitude</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="perseverance" name="themes" value="perseverance">
                                <label for="perseverance">Never Giving Up</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="teamwork" name="themes" value="teamwork">
                                <label for="teamwork">Teamwork</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="empathy" name="themes" value="empathy">
                                <label for="empathy">Understanding Others</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="responsibility" name="themes" value="responsibility">
                                <label for="responsibility">Being Responsible</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="diversity" name="themes" value="celebrating differences">
                                <label for="diversity">Celebrating Differences</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="family" name="themes" value="family love">
                                <label for="family">Family Love</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="nature" name="themes" value="caring for nature">
                                <label for="nature">Caring for Nature</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="music" name="themes" value="music and joy">
                                <label for="music">Music & Joy</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="specialElement">Special Element (optional):</label>
                        <input type="text" id="specialElement" name="specialElement" placeholder="e.g., magic wand, flying carpet, talking tree, rainbow crystal">
                    </div>

                    <div class="form-group">
                        <label for="lesson">What lesson should the story teach?</label>
                        <textarea id="lesson" name="lesson" placeholder="e.g., It's important to be kind to others, or sharing makes everyone happy"></textarea>
                    </div>

                    <button type="submit" class="generate-btn">✨ Create My Story ✨</button>
                </form>
            </div>

            <div class="story-container">
                <div id="storyContent" class="empty-state">
                    <h3>🌟 Your Magical Story Will Appear Here!</h3>
                    <p>Fill out the form on the left and click "Create My Story" to generate a personalized bedtime story for your little one.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Book Mode Overlay -->
    <div class="book-mode" id="bookMode">
        <div class="book-container">
            <div class="book">
                <div class="book-spine"></div>
                <div class="magical-bookmark"></div>
                <div class="progress-indicator">
                    <div class="progress-fill" id="bookProgress"></div>
                </div>
                
                <!-- Book pages will be dynamically inserted here -->
                <div id="bookPages"></div>
            </div>
            
            <div class="book-navigation">
                <button class="nav-btn" id="prevPage" onclick="previousPage()">📖 Previous</button>
                <button class="nav-btn" id="nextPage" onclick="nextPage()">Next 📖</button>
                <button class="nav-btn close-book" onclick="closeBook()">Close Book ✨</button>
            </div>
        </div>
    </div>

    <script>
        let currentStory = null;
        let currentPageIndex = 0;
        let totalPages = 0;

        document.getElementById('storyForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await generateStory();
        });

        async function generateStory() {
            const formData = new FormData(document.getElementById('storyForm'));
            const mainCharacter = formData.get('mainCharacter') || 'friendly dragon';
            const setting = formData.get('setting') || 'enchanted forest';
            const specialElement = formData.get('specialElement') || 'magic star';
            const lesson = formData.get('lesson') || 'being kind to others makes the world a better place';
            
            const themes = [];
            document.querySelectorAll('input[name="themes"]:checked').forEach(checkbox => {
                themes.push(checkbox.value);
            });
            const mainTheme = themes.length > 0 ? themes.join(', ') : 'friendship';

            // Show loading state
            document.getElementById('storyContent').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <h3>✨ Creating your unique bedtime story... ✨</h3>
                    <p>Our AI storyteller is crafting something special just for you!</p>
                </div>
            `;

            try {
                console.log('Attempting AI story generation...');
                const story = await createAIStory(mainCharacter, setting, mainTheme, specialElement, lesson);
                displayStory(story);
            } catch (error) {
                console.log('AI generation failed:', error);
                
                // Show error message instead of fallback
                document.getElementById('storyContent').innerHTML = `
                    <div style="text-align: center; padding: 50px;">
                        <h3 style="color: #ff6b6b; margin-bottom: 20px;">🤖 Our AI Storyteller is Taking a Break!</h3>
                        <p style="font-size: 1.1em; margin-bottom: 20px;">The AI service is temporarily unavailable. Please try again in a few moments!</p>
                        <button onclick="generateStory()" style="
                            background: linear-gradient(135deg, #667eea, #764ba2);
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 20px;
                            cursor: pointer;
                            font-size: 1em;
                            margin-top: 15px;
                        ">🔄 Try Again</button>
                    </div>
                `;
            }
        }

        function createStoryPrompt(character, setting, themes, element, lesson) {
            // Generate unique story elements
            const storyMood = getRandomElement([
                'gentle and dreamy', 'playful and adventurous', 'cozy and heartwarming', 
                'magical and mysterious', 'cheerful and uplifting', 'whimsical and fun'
            ]);

            const storyOpening = getRandomElement([
                `Start with ${character} in the middle of an interesting activity`,
                `Begin with ${character} noticing something unusual in their world`,
                `Open with ${character} meeting someone new unexpectedly`,
                `Start with ${character} trying to solve a small mystery`,
                `Begin with ${character} preparing for something special`,
                `Open with ${character} discovering ${element} in an unexpected place`
            ]);

            const storyStructure = getRandomElement([
                'Problem → Journey → Solution → Happy Ending',
                'Discovery → Adventure → Learning → Peaceful Conclusion',
                'Meeting → Challenge → Cooperation → Celebration',
                'Mystery → Investigation → Understanding → Resolution',
                'Invitation → Quest → Achievement → Return Home'
            ]);

            return `Write a complete bedtime story for children ages 2-5. This must be a SHORT, SIMPLE story with clear structure.

CHARACTER & SETTING:
- Main character: ${character} 
- Location: ${setting}
- Key themes: ${themes}
- Important object: ${element}
- Lesson to teach: ${lesson}

STORY REQUIREMENTS:
- Length: EXACTLY 8 short paragraphs (not 10!)
- Each paragraph: 2-3 simple sentences maximum
- Story mood: ${storyMood}
- Opening approach: ${storyOpening}
- Structure: ${storyStructure}

STORY STRUCTURE (MANDATORY):
Paragraph 1-2: BEGINNING - Introduce character and situation
Paragraph 3-4: MIDDLE PART 1 - Present gentle challenge or discovery  
Paragraph 5-6: MIDDLE PART 2 - Show character learning and growing
Paragraph 7-8: END - Resolve peacefully with lesson learned

WRITING STYLE:
- Use simple, clear language for young children
- Include dialogue with "quotes"
- Add sensory details (what they see, hear, feel)
- Make it original and creative - avoid fairy tale clichés
- Keep it gentle and suitable for bedtime
- End on a calm, sleepy note

FORBIDDEN:
- Don't use "Once upon a time" or "Long ago"
- Don't make it scary or intense
- Don't use complex vocabulary
- Don't write more than 8 paragraphs

Write a complete, original story now:`;
        }

        async function createAIStory(character, setting, themes, element, lesson) {
            const prompt = createStoryPrompt(character, setting, themes, element, lesson);
            
            // Use better models and improved parameters
            const models = [
                "microsoft/DialoGPT-medium",
                "facebook/blenderbot-400M-distill",
                "EleutherAI/gpt-neo-1.3B"
            ];
            
            for (const model of models) {
                try {
                    console.log(`Trying AI model: ${model}`);
                    const response = await fetch(`https://api-inference.huggingface.co/models/${model}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            inputs: prompt,
                            parameters: {
                                max_new_tokens: 800,  // Shorter for 8 paragraphs
                                temperature: 1.0,     // More creative
                                top_p: 0.95,
                                do_sample: true,
                                return_full_text: false,
                                repetition_penalty: 1.3,  // Stronger anti-repetition
                                length_penalty: 1.0
                            },
                            options: {
                                wait_for_model: true,
                                use_cache: false
                            }
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log('AI Response received:', result);
                        
                        if (result && result[0] && result[0].generated_text && result[0].generated_text.trim().length > 300) {
                            const story = parseAIStory(result[0].generated_text, character, setting);
                            console.log('Story parsed successfully:', story);
                            return story;
                        } else {
                            console.log('AI response too short or empty');
                        }
                    } else {
                        const errorText = await response.text();
                        console.log(`Model ${model} failed:`, errorText);
                    }
                } catch (error) {
                    console.log(`Model ${model} error:`, error);
                    continue;
                }
            }
            
            throw new Error('All AI models failed to generate story');
        }

        function parseAIStory(aiText, character, setting) {
            let cleanText = aiText.trim();
            
            // Clean up the AI text
            cleanText = cleanText.replace(/^.*Write a complete.*story now:\s*/i, '');
            cleanText = cleanText.replace(/^Story:\s*/i, '');
            
            // Split into paragraphs more intelligently
            let paragraphs = cleanText.split(/\n\s*\n/).filter(p => p.trim().length > 20);
            
            // If we don't have enough, try different splitting
            if (paragraphs.length < 6) {
                paragraphs = cleanText.split(/\.\s+/).filter(p => p.trim().length > 40);
                // Rejoin sentences that belong together
                const betterParagraphs = [];
                for (let i = 0; i < paragraphs.length; i += 2) {
                    if (paragraphs[i + 1]) {
                        betterParagraphs.push(paragraphs[i] + '. ' + paragraphs[i + 1] + '.');
                    } else {
                        betterParagraphs.push(paragraphs[i] + '.');
                    }
                }
                paragraphs = betterParagraphs;
            }
            
            // Ensure we have 8 paragraphs for consistency
            while (paragraphs.length < 8 && paragraphs.length > 0) {
                // Split longer paragraphs
                const longest = paragraphs.reduce((a, b) => a.length > b.length ? a : b);
                const idx = paragraphs.indexOf(longest);
                const sentences = longest.split('. ');
                if (sentences.length > 1) {
                    paragraphs[idx] = sentences.slice(0, Math.ceil(sentences.length/2)).join('. ') + '.';
                    paragraphs.splice(idx + 1, 0, sentences.slice(Math.ceil(sentences.length/2)).join('. '));
                } else {
                    break;
                }
            }
            
            // Take first 8 paragraphs and clean them
            const storyPages = paragraphs.slice(0, 8).map(p => {
                let cleaned = p.trim();
                if (!cleaned.endsWith('.') && !cleaned.endsWith('!') && !cleaned.endsWith('?')) {
                    cleaned += '.';
                }
                return cleaned;
            });
            
            // Generate a creative title
            const titleWords = [
                'Adventure', 'Journey', 'Secret', 'Magic', 'Wonder', 'Dream', 
                'Mystery', 'Tale', 'Story', 'Quest', 'Discovery', 'Gift'
            ];
            const title = `The ${capitalize(character)}'s ${getRandomElement(titleWords)}`;
            
            return {
                title: title,
                pages: storyPages,
                character: character,
                setting: setting
            };
        }

        async function createAIStory(character, setting, themes, element, lesson) {
            const prompt = createStoryPrompt(character, setting, themes, element, lesson);
            
            // Try multiple Hugging Face models for reliability
            const models = [
                "microsoft/DialoGPT-medium",
                "gpt2-medium", 
                "EleutherAI/gpt-neo-1.3B",
                "facebook/blenderbot-400M-distill"
            ];
            
            for (const model of models) {
                try {
                    console.log(`Trying AI model: ${model}`);
                    const response = await fetch(`https://api-inference.huggingface.co/models/${model}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            inputs: prompt,
                            parameters: {
                                max_new_tokens: 1500,
                                temperature: 0.9,
                                top_p: 0.95,
                                do_sample: true,
                                return_full_text: false,
                                repetition_penalty: 1.2
                            },
                            options: {
                                wait_for_model: true,
                                use_cache: false
                            }
                        })
                    });

                    console.log(`Response status: ${response.status}`);
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('AI Response:', result);
                        
                        if (result && result[0] && result[0].generated_text && result[0].generated_text.trim().length > 200) {
                            console.log('AI story generated successfully!');
                            return parseAIStory(result[0].generated_text, character, setting);
                        } else {
                            console.log('AI response too short or empty');
                        }
                    } else {
                        const errorText = await response.text();
                        console.log(`Model ${model} failed with status ${response.status}: ${errorText}`);
                    }
                } catch (error) {
                    console.log(`Model ${model} failed with error:`, error);
                    continue;
                }
            }
            
            console.log('All AI models failed, using template fallback');
            throw new Error('All AI models failed');
        }

        function createStoryPrompt(character, setting, themes, element, lesson) {
            // Generate random creative elements for uniqueness
            const storyStyle = getRandomElement([
                'adventure story with unexpected twists',
                'gentle mystery that unfolds slowly',
                'heartwarming tale of discovery',
                'magical journey with meaningful encounters',
                'whimsical story full of wonder',
                'cozy tale with delightful surprises',
                'enchanting story with talking objects',
                'uplifting adventure about overcoming challenges'
            ]);

            const narrativeVoice = getRandomElement([
                'warm and conversational, like a grandparent telling a story',
                'playful and energetic, with lots of descriptive details',
                'gentle and soothing, perfect for bedtime',
                'curious and wondering, asking gentle questions',
                'wise and thoughtful, with deeper meanings',
                'cheerful and optimistic, celebrating small joys'
            ]);

            const uniqueElements = getRandomElement([
                'Include at least 3 different magical creatures as supporting characters',
                'Add sensory details - what things smell, sound, feel, and look like',
                'Include a gentle problem that requires creative thinking to solve',
                'Add moments of humor and playfulness throughout',
                'Include weather or seasonal elements that affect the story',
                'Feature a special celebration or gathering'
            ]);

            const characterPersonality = generateCharacterPersonality(character);
            const settingDetails = generateSettingDetails(setting);

            // Force completely different story openings
            const storyOpening = getRandomElement([
                `Start with ${character} in the middle of doing something unusual (like painting with moonbeams or having a tea party with clouds)`,
                `Begin with ${character} waking up to find something completely different about their world`,
                `Open with ${character} receiving a mysterious invitation or message`,
                `Start with ${character} overhearing a conversation between two unlikely creatures`,
                `Begin with ${character} following a strange sound, smell, or light`,
                `Open with ${character} finding that their favorite place has magically changed overnight`,
                `Start with ${character} trying to solve a puzzle or riddle they discovered`,
                `Begin with ${character} preparing for an important event or celebration`,
                `Open with ${character} meeting someone completely unexpected`,
                `Start with ${character} noticing that something they use every day has started acting magical`,
                `Begin with ${character} getting lost in a familiar place that's become unfamiliar`,
                `Open with ${character} discovering they have a new ability they didn't know about`,
                `Start during a storm, unusual weather, or magical phenomenon`,
                `Begin with ${character} helping someone else with their problem first`,
                `Open with ${character} finding an object that doesn't belong in their world`
            ]);

            const firstParagraphStyle = getRandomElement([
                'Start with action - show the character already doing something interesting',
                'Begin with dialogue - let someone speak first, then reveal who they are',
                'Open with a sensory detail - a sound, smell, or sight that draws us in',
                'Start with a question the character is wondering about',
                'Begin by describing something magical happening right now',
                'Open with the character making a discovery',
                'Start with an emotional moment - joy, curiosity, or gentle concern'
            ]);

            const timeOfDay = getRandomElement([
                'during a purple-pink sunrise when everything looks different',
                'at the golden hour when shadows are long and magical',
                'during a gentle afternoon when the light is warm and sleepy',
                'in the deep blue twilight when stars are just appearing',
                'during a misty early morning when everything is soft and quiet',
                'at midnight when only magical creatures are awake',
                'during a rainbow-filled moment after gentle rain'
            ]);

            return `You are a master children's storyteller creating a unique bedtime story. This story must start completely differently from typical children's stories.

STORY REQUIREMENTS:
- Main Character: ${character} (${characterPersonality})
- Setting: ${setting} (${settingDetails})
- Themes to weave throughout: ${themes}
- Special magical element: ${element}
- Important lesson: ${lesson}
- Story Style: ${storyStyle}
- Narrative Voice: ${narrativeVoice}
- Unique Elements: ${uniqueElements}
- Time Setting: ${timeOfDay}

CRITICAL OPENING REQUIREMENTS:
- Opening Strategy: ${storyOpening}
- First Paragraph Style: ${firstParagraphStyle}
- NEVER use "Once upon a time" or "Long ago" or "In a faraway land"
- NEVER start with "There was/lived a..."
- DO NOT start by introducing the character's background or location first
- Jump directly into action, dialogue, or an intriguing moment
- Make the first sentence grab attention immediately

CREATIVE GUIDELINES:
- Write exactly 10 paragraphs, each 3-4 sentences long
- Use vivid, child-friendly imagery and metaphors
- Include dialogue from characters (use "quotes")
- Vary sentence structure - some short, some longer
- Add specific details that make this story unique (unusual colors, interesting sounds, special textures)
- Include emotional moments - joy, wonder, gentle challenges, triumph
- Make the ${element} central to the plot, not just mentioned
- Show don't tell - let actions demonstrate the lesson
- End with a satisfying, peaceful conclusion perfect for bedtime

FORBIDDEN OPENING PHRASES:
- "Once upon a time"
- "Long ago"
- "In a faraway land"
- "There was a"
- "There lived a"
- "[Character name] was a"
- "In the [setting]"

TONE: Magical yet grounded, imaginative yet believable, gentle yet engaging

Create a story that starts with immediate intrigue and feels completely fresh!

Story:`;
        }

        function generateCharacterPersonality(character) {
            const personalities = {
                'friendly dragon': getRandomElement(['loves collecting shiny pebbles and making music with them', 'enjoys baking cloud cookies for friends', 'has a talent for growing rainbow flowers']),
                'baby dragon': getRandomElement(['is learning to fly and sometimes hiccups sparkles', 'loves bedtime stories and warm milk', 'enjoys playing hide-and-seek in flower petals']),
                'rainbow dragon': getRandomElement(['paints the sky with different emotions each day', 'can only speak in colors until evening', 'leaves rainbow footprints wherever they walk']),
                'magical unicorn': getRandomElement(['has a mane that changes with the seasons', 'can heal sadness with gentle touches', 'loves dancing in moonbeams']),
                'flower fairy': getRandomElement(['speaks only through flower fragrances', 'makes tiny houses from acorn caps', 'can make plants grow by singing to them']),
                'wise owl': getRandomElement(['collects stories in hollow trees', 'can see the good in everyone\'s heart', 'loves stargazing and making wishes']),
                'friendly bear': getRandomElement(['gives the best warm hugs in the forest', 'makes honey tea for friends', 'knows every secret path through the woods']),
                'singing bird': getRandomElement(['carries messages between the clouds', 'wakes up flowers with morning songs', 'can imitate any sound in nature']),
                'kind princess': getRandomElement(['prefers gardening to wearing crowns', 'talks to animals and understands their worries', 'loves making toys for children']),
                'magical fairy': getRandomElement(['specializes in fixing broken things with stardust', 'can shrink to ant-size or grow to tree-height', 'keeps a library of wishes in dewdrops'])
            };
            
            return personalities[character] || getRandomElement([
                'has a special talent for making others smile',
                'loves helping those in need',
                'enjoys discovering new things every day',
                'has a heart full of kindness and wonder'
            ]);
        }

        function generateSettingDetails(setting) {
            const details = {
                'enchanted forest': getRandomElement(['where the trees whisper ancient secrets and fireflies write stories in the air', 'filled with musical streams and flowers that glow different colors based on emotions', 'where each path leads to a different season and time moves like honey']),
                'magical kingdom': getRandomElement(['where the castle is built from crystallized laughter and the gardens grow in spirals', 'with bridges made of hardened rainbows and fountains that sing lullabies', 'where the towers are libraries and every room tells a different story']),
                'cloud city': getRandomElement(['where buildings are made of spun silver clouds and rain is always warm', 'with fluffy pathways that bounce and stars that serve as streetlights', 'where the weather changes based on the citizens\' moods']),
                'secret garden': getRandomElement(['hidden behind a waterfall of liquid starlight', 'where every flower grants a small wish when treated with kindness', 'that only appears to those who truly need its magic']),
                'underwater world': getRandomElement(['where coral sings in harmonies and fish paint with their scales', 'filled with gentle currents that carry whispered dreams', 'where sea glass windows show memories of the ocean']),
                'magical treehouse': getRandomElement(['built in a tree so tall its branches touch different cloud kingdoms', 'with rooms that rearrange themselves based on what you need most', 'where the tree grows different fruits depending on the season of your heart']),
                'crystal cave': getRandomElement(['where each crystal holds a different color of light and hums a unique melody', 'that grows new rooms whenever someone with a kind heart enters', 'where the walls show reflections of your happiest memories'])
            };
            
            return details[setting] || getRandomElement([
                'a place where magic feels as natural as breathing',
                'somewhere that changes to reflect the kindness of its visitors',
                'a location where ordinary things become extraordinary through love'
            ]);
        }

        function parseAIStory(aiText, character, setting) {
            // Clean up the AI generated text
            let cleanText = aiText.trim();
            
            // Remove the prompt if it was included
            cleanText = cleanText.replace(/^.*Story:\s*/i, '');
            
            // Split into paragraphs
            let paragraphs = cleanText.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            
            // If we don't have enough paragraphs, split by periods or other delimiters
            if (paragraphs.length < 8) {
                paragraphs = cleanText.split(/\.\s+/).filter(p => p.trim().length > 30);
            }
            
            // Ensure we have at least 8-10 paragraphs
            if (paragraphs.length < 8) {
                // Fallback to template system
                throw new Error('AI story too short');
            }
            
            // Take first 10 paragraphs and clean them
            const storyPages = paragraphs.slice(0, 10).map(p => {
                let cleaned = p.trim();
                // Add period if missing
                if (!cleaned.endsWith('.') && !cleaned.endsWith('!') && !cleaned.endsWith('?')) {
                    cleaned += '.';
                }
                return cleaned;
            });
            
            // Generate a title
            const title = generateAITitle(character, setting);
            
            return {
                title: title,
                pages: storyPages,
                character: character,
                setting: setting
            };
        }

        function generateAITitle(character, setting) {
            const titleTemplates = [
                `The ${capitalize(character)} of ${capitalize(setting)}`,
                `${capitalize(character)}'s Magical Adventure`,
                `The Secret of the ${capitalize(character)}`,
                `${capitalize(character)} and the Magic of ${capitalize(setting)}`,
                `A ${capitalize(character)}'s Journey`,
                `The Wonderful ${capitalize(character)}`,
                `${capitalize(character)}'s Special Day`,
                `The Kind ${capitalize(character)}`
            ];
            
            return getRandomElement(titleTemplates);
        }

        function createPersonalizedStory(character, setting, theme, element, lesson) {
            const storyElements = generateStoryElements(character, setting, theme, element, lesson);
            const storyTitle = storyElements.title;
            
            const pages = [
                storyElements.opening,
                storyElements.discovery,
                storyElements.magicalMoment,
                storyElements.firstChallenge,
                storyElements.meetingFriends,
                storyElements.helpingOthers,
                storyElements.learningLesson,
                storyElements.celebration,
                storyElements.wisdom,
                storyElements.ending
            ];

            return { title: storyTitle, pages: pages, character: character, setting: setting };
        }

        function generateStoryElements(character, setting, theme, element, lesson) {
            const openings = [
                `Once upon a time, in a ${setting}, there lived a ${character} who loved ${getRandomActivity()}. Every morning, they would ${getRandomMorningActivity()} and dream of helping others.`,
                `In the heart of a magical ${setting}, a kind ${character} spent their days ${getRandomActivity()}. They had a special gift for making everyone around them feel ${getRandomEmotion()}.`,
                `Long ago, in a beautiful ${setting}, there was a ${character} known throughout the land for their ${getRandomQuality()}. They believed that every day was a chance to spread ${theme}.`,
                `Deep in the ${setting}, where ${getRandomSettingDetail(setting)}, lived a gentle ${character} who had the most wonderful secret - they could ${getRandomMagicalAbility()}.`
            ];

            const discoveries = [
                `One ${getRandomTimeOfDay()}, while ${getRandomExploringActivity()}, the ${character} stumbled upon something extraordinary. There, ${getRandomHidingPlace()}, was a ${element} that ${getRandomMagicalProperty()}.`,
                `During a peaceful walk through the ${setting}, the ${character} heard a ${getRandomSound()} coming from nearby. Following the sound, they discovered a magnificent ${element} that seemed to ${getRandomMagicalBehavior()}.`,
                `As the ${character} was ${getRandomDailyActivity()}, they noticed something sparkling in the distance. Moving closer, they found a beautiful ${element} that ${getRandomMagicalProperty()}.`,
                `The ${character} had always been curious about the old legends of the ${setting}. Today, their curiosity led them to discover a legendary ${element} that ${getRandomMagicalBehavior()}.`
            ];

            const storyElements = {
                title: `The ${capitalize(character)} and the ${getRandomTitleElement()} of ${capitalize(setting)}`,
                opening: getRandomElement(openings),
                discovery: getRandomElement(discoveries),
                magicalMoment: generateMagicalMoment(character, element),
                firstChallenge: generateChallenge(character, setting, theme),
                meetingFriends: generateFriendMeeting(character, setting),
                helpingOthers: generateHelpingScene(character, element, theme),
                learningLesson: generateLessonScene(character, lesson, theme),
                celebration: generateCelebration(character, setting),
                wisdom: generateWisdom(character, element, theme),
                ending: generateEnding(character, setting)
            };

            return storyElements;
        }

        // Helper functions for generating random story elements
        function getRandomElement(array) {
            return array[Math.floor(Math.random() * array.length)];
        }

        function getRandomActivity() {
            const activities = ['exploring', 'singing', 'dancing', 'gardening', 'painting', 'collecting flowers', 'watching clouds', 'helping friends'];
            return getRandomElement(activities);
        }

        function getRandomMorningActivity() {
            const activities = ['stretch and yawn', 'greet the sunshine', 'water the flowers', 'say hello to their neighbors', 'practice their magic', 'tidy their home'];
            return getRandomElement(activities);
        }

        function getRandomEmotion() {
            const emotions = ['happy', 'loved', 'peaceful', 'joyful', 'safe', 'welcome', 'special'];
            return getRandomElement(emotions);
        }

        function getRandomQuality() {
            const qualities = ['kindness', 'wisdom', 'gentleness', 'curiosity', 'bravery', 'generosity', 'patience'];
            return getRandomElement(qualities);
        }

        function getRandomSettingDetail(setting) {
            const details = {
                'enchanted forest': ['ancient trees whisper secrets', 'magical creatures play among the flowers', 'sunbeams dance through the leaves'],
                'magical kingdom': ['castle towers touch the clouds', 'rainbow bridges span the valleys', 'gentle music fills the air'],
                'cozy village': ['chimney smoke curls into the sky', 'flower boxes decorate every window', 'friendly neighbors wave hello'],
                'underwater world': ['colorful coral gardens bloom', 'gentle currents carry happy songs', 'pearl bubbles float to the surface'],
                'cloud city': ['fluffy pathways stretch endlessly', 'rainbow slides connect the levels', 'star dust sparkles everywhere'],
                'secret garden': ['butterfly friends flutter about', 'sweet fragrances fill the air', 'dewdrops sparkle like diamonds'],
                'magical treehouse': ['branches sway gently in the breeze', 'bird friends chirp good morning', 'leaves rustle with ancient wisdom'],
                'happy farm': ['golden wheat fields wave hello', 'happy animals roam freely', 'the sunset paints the sky in warm colors']
            };
            return getRandomElement(details[setting] || ['magic fills the air', 'wonder awaits around every corner', 'happiness grows like flowers']);
        }

        function getRandomMagicalAbility() {
            const abilities = ['talk to flowers', 'understand all languages', 'make plants grow with a touch', 'see the goodness in everyone\'s heart', 'grant small wishes', 'heal sadness with hugs'];
            return getRandomElement(abilities);
        }

        function getRandomTimeOfDay() {
            const times = ['sunny morning', 'peaceful afternoon', 'golden evening', 'starlit night', 'misty dawn'];
            return getRandomElement(times);
        }

        function getRandomExploringActivity() {
            const activities = ['following a butterfly', 'listening to bird songs', 'searching for four-leaf clovers', 'watching the clouds', 'collecting smooth stones', 'following a rainbow'];
            return getRandomElement(activities);
        }

        function getRandomHidingPlace() {
            const places = ['nestled among soft moss', 'hidden beneath rainbow petals', 'resting on a lily pad', 'tucked inside a hollow log', 'gleaming atop a mushroom', 'cradled in flower petals'];
            return getRandomElement(places);
        }

        function getRandomMagicalProperty() {
            const properties = ['glowed with warm light', 'hummed a gentle melody', 'sparkled like captured starlight', 'pulsed with a heartbeat of kindness', 'shimmered with rainbow colors', 'whispered words of encouragement'];
            return getRandomElement(properties);
        }

        function getRandomMagicalBehavior() {
            const behaviors = ['pulse with gentle energy', 'float softly in the air', 'change colors like a sunset', 'emit tiny sparkles of joy', 'glow brighter with each kind thought', 'hum lullabies from long ago'];
            return getRandomElement(behaviors);
        }

        function getRandomDailyActivity() {
            const activities = ['tending to their garden', 'reading ancient stories', 'practicing their talents', 'helping their neighbors', 'preparing for the day', 'enjoying the peaceful morning'];
            return getRandomElement(activities);
        }

        function getRandomSound() {
            const sounds = ['gentle tinkling', 'soft humming', 'melodic whisper', 'happy giggling', 'peaceful chiming', 'magical singing'];
            return getRandomElement(sounds);
        }

        function getRandomTitleElement() {
            const elements = ['Secret', 'Magic', 'Mystery', 'Wonder', 'Adventure', 'Journey', 'Gift', 'Treasure', 'Miracle', 'Dream'];
            return getRandomElement(elements);
        }

        function generateMagicalMoment(character, element) {
            const moments = [
                `The moment the ${character} touched the ${element}, it began to glow with warmth. "Hello, kind soul," whispered a gentle voice. "I have been waiting for someone with a heart like yours."`,
                `As soon as the ${character} picked up the ${element}, the world around them seemed brighter. Flowers bloomed more colorfully, and a soft melody filled the air. The ${element} had chosen them for something special.`,
                `The ${element} felt warm and alive in the ${character}'s gentle hands. Suddenly, they could understand the language of all living things - the trees, the flowers, even the busy ants had stories to tell.`,
                `When the ${character} held the ${element} close to their heart, it pulsed with a rhythm that matched their own. They felt a surge of love and understanding flow through them, connecting them to all life in their world.`
            ];
            return getRandomElement(moments);
        }

        function generateChallenge(character, setting, theme) {
            const challenges = [
                `As the ${character} explored the ${setting} with their new magical gift, they heard crying in the distance. A small creature was lost and frightened, needing someone to show them ${theme}.`,
                `The peaceful ${setting} was troubled that day. Some of the animals had forgotten how important ${theme} was, and sadness had begun to spread like grey clouds.`,
                `While walking through the ${setting}, the ${character} discovered that the magic there was fading. The only way to restore it was through acts of genuine ${theme}.`,
                `A gentle storm had scattered many of the smaller creatures throughout the ${setting}. They needed someone brave and kind to help them find their way back to safety and teach them about ${theme}.`
            ];
            return getRandomElement(challenges);
        }

        function generateFriendMeeting(character, setting) {
            const meetings = [
                `Soon, the ${character} met a group of friendly animals who lived in the ${setting}. There was a wise old turtle, a playful squirrel, and a gentle deer. They had all heard about the ${character}'s kind heart.`,
                `Word of the ${character}'s kindness spread quickly through the ${setting}. Before long, creatures great and small came to meet this special friend who brought joy wherever they went.`,
                `As the ${character} continued their journey, they were joined by other kind souls from the ${setting} - each one eager to help and learn from their new friend's gentle wisdom.`,
                `The magic of the ${character}'s presence drew together all the good-hearted beings in the ${setting}. Together, they formed a circle of friendship that would make their world brighter.`
            ];
            return getRandomElement(meetings);
        }

        function generateHelpingScene(character, element, theme) {
            const scenes = [
                `Using the power of the ${element}, the ${character} and their friends worked together to help everyone in need. With each act of ${theme}, the magical object glowed brighter and their hearts felt fuller.`,
                `The ${character} showed their new friends how the ${element} worked best when they all practiced ${theme} together. Soon, the entire area was filled with laughter, joy, and the warm glow of caring hearts.`,
                `Through patient teaching and gentle example, the ${character} helped everyone understand the true power of ${theme}. The ${element} sparkled with approval as kindness spread from heart to heart.`,
                `One by one, the ${character} and their friends used the ${element}'s magic to solve each problem they encountered. Every act of ${theme} made their community stronger and happier.`
            ];
            return getRandomElement(scenes);
        }

        function generateLessonScene(character, lesson, theme) {
            const scenes = [
                `As the day progressed, everyone in the community learned an important truth: ${lesson}. The ${character} smiled as they watched their friends practice this wisdom with joy.`,
                `Through their adventures together, all the creatures discovered that ${lesson}. The ${character} felt proud to see how ${theme} had transformed their entire world.`,
                `The wise ${character} gathered everyone together and shared the most important lesson of all: ${lesson}. Everyone nodded in understanding, feeling the truth of these words in their hearts.`,
                `By the end of their magical day, every creature in the land understood that ${lesson}. The ${character} had helped them all discover the power of ${theme}.`
            ];
            return getRandomElement(scenes);
        }

        function generateCelebration(character, setting) {
            const celebrations = [
                `That evening, all the creatures of the ${setting} gathered to celebrate their new understanding. They sang songs, shared stories, and danced under the twinkling stars, with the ${character} at the center of it all.`,
                `The entire ${setting} came alive with celebration. Flowers bloomed brighter, streams babbled happier songs, and even the stars seemed to twinkle with extra joy, all thanks to the ${character}'s kindness.`,
                `As word spread throughout the ${setting}, creatures from far and wide came to thank the ${character}. The celebration lasted until the moon was high, filled with gratitude and new friendships.`,
                `The magic in the ${setting} was stronger than ever before. Everyone celebrated by sharing their favorite foods, playing gentle games, and promising to remember the ${character}'s wonderful example.`
            ];
            return getRandomElement(celebrations);
        }

        function generateWisdom(character, element, theme) {
            const wisdom = [
                `As the celebration wound down, the ${character} carefully placed the ${element} back where they had found it. "The real magic," they explained, "was inside all of us from the beginning. The ${element} just helped us remember."`,
                `The ${character} looked at their new friends with a warm smile. "This ${element} taught us something special today," they said. "True magic happens when we choose ${theme} in everything we do."`,
                `Before saying goodnight, the ${character} shared their most important discovery: "The ${element} was wonderful, but the greatest magic comes from the love we share with each other."`,
                `The wise ${character} knew that their time with the ${element} had taught everyone something precious. "We don't need magic objects to be special," they said. "Our kind hearts are magic enough."`
            ];
            return getRandomElement(wisdom);
        }

        function generateEnding(character, setting) {
            const endings = [
                `That night, as all the creatures of the ${setting} drifted off to peaceful sleep, they dreamed of their dear friend the ${character}. In their dreams, kindness continued to spread like warm sunlight, touching every corner of their magical world. The end. Sweet dreams! 🌙✨`,
                `As the stars came out to light the ${setting}, the ${character} tucked all their new friends safely into their homes. Everyone fell asleep with happy hearts, knowing that tomorrow would bring new chances to spread joy. The end. Sleep tight! 🌙✨`,
                `The ${character} looked up at the peaceful night sky above the ${setting} and felt grateful for the wonderful day. All around them, their friends slept soundly, dreaming of kindness and friendship. The end. Have the sweetest dreams! 🌙✨`,
                `With hearts full of love and minds full of wonderful memories, everyone in the ${setting} settled down for the night. The ${character}'s lesson would live on in their dreams and in their daily lives. The end. Good night! 🌙✨`
            ];
            return getRandomElement(endings);
        }

        function capitalize(str) {
            return str.split(' ').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }

        function displayStory(story) {
            // Show confirmation message in the main window
            document.getElementById('storyContent').innerHTML = `
                <div style="text-align: center; padding: 50px;">
                    <h3 style="color: #5a67d8; margin-bottom: 20px;">📖 Your Story is Ready!</h3>
                    <p style="font-size: 1.1em; margin-bottom: 20px;">Click the button below to open your magical storybook!</p>
                    <button onclick="openStoryBook()" style="
                        background: linear-gradient(135deg, #ff6b6b, #ffa500);
                        color: white;
                        border: none;
                        padding: 15px 30px;
                        border-radius: 25px;
                        cursor: pointer;
                        font-size: 1.2em;
                        font-weight: bold;
                        text-transform: uppercase;
                        letter-spacing: 1px;
                        margin-top: 15px;
                        box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
                        transition: all 0.3s ease;
                    " onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 10px 25px rgba(255, 107, 107, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 15px rgba(255, 107, 107, 0.3)'">
                        ✨ Open Story Book ✨
                    </button>
                </div>
            `;
            
            // Store the story for the book mode
            currentStory = story;
        }

        function openStoryBook() {
            if (!currentStory) return;
            
            // Create book pages
            createBookPages(currentStory);
            
            // Show book mode
            document.getElementById('bookMode').classList.add('active');
            
            // Initialize book navigation
            currentPageIndex = 0;
            totalPages = currentStory.pages.length + 1; // +1 for cover page
            updateBookNavigation();
            showBookPage(0);
            
            // Add keyboard navigation
            document.addEventListener('keydown', handleBookKeyboard);
        }

        function createBookPages(story) {
            const bookPages = document.getElementById('bookPages');
            bookPages.innerHTML = '';
            
            // Create cover page
            const coverPage = document.createElement('div');
            coverPage.className = 'book-page cover-page';
            coverPage.dataset.page = '0';
            coverPage.innerHTML = `
                <div class="page-content">
                    <div class="cover-decoration">📚</div>
                    <h1 class="cover-title">${story.title}</h1>
                    <p class="cover-subtitle">A Magical Bedtime Story</p>
                    <div class="cover-decoration">✨🌙✨</div>
                </div>
            `;
            bookPages.appendChild(coverPage);
            
            // Create story pages
            story.pages.forEach((pageText, index) => {
                const page = document.createElement('div');
                page.className = 'book-page';
                page.dataset.page = index + 1;
                
                const imagePrompt = generateImagePrompt(story.character, story.setting, index);
                const imageUrl = generateImageUrl(imagePrompt);
                
                page.innerHTML = `
                    <div class="page-content">
                        <div class="page-text">${pageText}</div>
                        <img src="${imageUrl}" alt="Story illustration for page ${index + 1}" class="page-illustration" loading="lazy">
                    </div>
                    <div class="page-number">Page ${index + 1}</div>
                `;
                bookPages.appendChild(page);
            });
        }

        function generateImagePrompt(character, setting, pageIndex) {
            const prompts = [
                `cute cartoon ${character} in a magical ${setting}, children's book illustration style, bright colors, friendly expression, whimsical`,
                `${character} discovering a glowing magical object in ${setting}, children's storybook art, soft lighting, enchanting atmosphere`,
                `${character} touching a sparkling magical item, children's book illustration, warm glowing effects, wonder and amazement`,
                `${character} with magical powers helping in ${setting}, cartoon style, bright cheerful colors, kind and gentle scene`,
                `${character} meeting small forest animals in ${setting}, children's book art, cute animals, friendship scene, pastoral`,
                `${character} using magic to help lost animals, children's illustration, glowing magical effects, caring and helpful scene`,
                `${character} surrounded by happy animals in ${setting}, children's storybook style, celebration scene, joyful atmosphere`,
                `group celebration in magical ${setting} with ${character}, children's book art, festive and happy, community gathering`,
                `wise ${character} sharing wisdom in ${setting}, children's illustration, peaceful evening scene, storytelling moment`,
                `peaceful nighttime scene in ${setting} with sleeping ${character}, children's book art, stars and moon, dreamy bedtime scene`
            ];
            
            return prompts[pageIndex] || `cute ${character} in magical ${setting}, children's book illustration style`;
        }

        function generateImageUrl(prompt) {
            const cleanPrompt = encodeURIComponent(
                `${prompt}, children's book illustration, cartoon style, bright colors, friendly, cute, safe for kids, storybook art`
            );
            const negativePrompt = encodeURIComponent("scary, dark, violent, realistic, photographic, inappropriate");
            const seed = Math.floor(Math.random() * 10000);
            
            return `https://image.pollinations.ai/prompt/${cleanPrompt}?negative=${negativePrompt}&width=280&height=200&seed=${seed}&model=flux&enhance=true`;
        }

        function showBookPage(pageIndex) {
            // Hide all pages
            document.querySelectorAll('.book-page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show current page
            const currentPage = document.querySelector(`[data-page="${pageIndex}"]`);
            if (currentPage) {
                currentPage.classList.add('active');
                playPageSound();
            }
            
            updateBookNavigation();
            updateProgress();
        }

        function updateBookNavigation() {
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');
            
            prevBtn.disabled = currentPageIndex === 0;
            nextBtn.disabled = currentPageIndex === totalPages - 1;
        }

        function updateProgress() {
            const progress = (currentPageIndex / (totalPages - 1)) * 100;
            document.getElementById('bookProgress').style.width = `${progress}%`;
        }

        function nextPage() {
            if (currentPageIndex < totalPages - 1) {
                currentPageIndex++;
                showBookPage(currentPageIndex);
            }
        }

        function previousPage() {
            if (currentPageIndex > 0) {
                currentPageIndex--;
                showBookPage(currentPageIndex);
            }
        }

        function closeBook() {
            document.getElementById('bookMode').classList.remove('active');
            document.removeEventListener('keydown', handleBookKeyboard);
        }

        function handleBookKeyboard(e) {
            switch(e.key) {
                case 'ArrowRight':
                case ' ':
                    e.preventDefault();
                    nextPage();
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    previousPage();
                    break;
                case 'Escape':
                    e.preventDefault();
                    closeBook();
                    break;
            }
        }

        function playPageSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime + 0.1);
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);
            } catch(e) {
                // Audio context not supported or blocked
            }
        }
    </script>
</body>
</html>
